<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flashcards</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; font-family: 'Inter', sans-serif; }
    body { max-width: 900px; margin: 0 auto; padding: 80px 40px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; background: #0f172a; }
    input, textarea { width: 100%; padding: 16px 20px; font-size: 16px; background: #1e293b; color: #f8fafc; border: 1px solid #334155; border-radius: 8px; margin-top: 12px; outline: none; transition: border-color 0.2s; }
    input::placeholder, textarea::placeholder { color: #64748b; }
    input:focus, textarea:focus { border-color: #60a5fa; }
    .card { position: relative; padding: 48px 40px; background: #1e293b; border: 1px solid #334155; border-radius: 12px; text-align: center; box-shadow: 0 4px 24px rgba(0,0,0,0.3); transition: opacity 0.15s; display: flex; flex-direction: column; align-items: center; }
    .card.fade { opacity: 0; }
    .card.shake { animation: shake 0.4s; }
    @keyframes shake { 20%,60% { transform: translateX(-8px); } 40%,80% { transform: translateX(8px); } }
    .card input { text-align: center; background: #0f172a; transition: border-color 0.3s; }
    .card input.correct { border-color: #22c55e; }
    .card input.wrong { border-color: #ef4444; }
    .stats { width: 100%; display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.3; transition: opacity 0.2s; }
    .card:hover .stats { opacity: 1; }
    .progress { width: 100%; height: 2px; background: #334155; border-radius: 2px; margin-bottom: 32px; }
    .progress-bar { height: 100%; background: #60a5fa; border-radius: 2px; transition: width 0.3s; }
    .ex { display: inline-block; font-size: 24px; color: #f8fafc; line-height: 1.8; background: #0f172a; padding: 20px 24px; border-radius: 8px; border: 1px solid #334155; transition: opacity 0.2s; }
    .def { font-size: 15px; color: #94a3b8; line-height: 1.6; margin-top: 16px; font-style: italic; padding: 12px 0; }
    .modal { display: none; position: fixed; inset: 0; background: #0f172a; padding: 40px; overflow: auto; z-index: 100; }
    .modal-inner { max-width: 480px; margin: 0 auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid #334155; }
    .modal-title { font-size: 18px; font-weight: 500; color: #f8fafc; }
    .modal-close { width: 24px; height: 24px; cursor: pointer; opacity: 0.5; transition: opacity 0.2s; }
    .modal-close:hover { opacity: 1; }
    .modal input, .modal textarea { text-align: left; }
    .modal textarea { height: 100px; resize: none; }
    .btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .btn { display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: #1e293b; border: 1px solid #334155; border-radius: 8px; cursor: pointer; font-size: 14px; color: #94a3b8; transition: all 0.2s; }
    .btn:hover { border-color: #60a5fa; color: #f8fafc; }
    .btn:hover svg { stroke: #60a5fa; }
    .btn svg { width: 16px; height: 16px; stroke: #64748b; transition: stroke 0.2s; }
    .btn-primary { background: #3b82f6; border-color: #3b82f6; color: #fff; }
    .btn-primary svg { stroke: #fff; }
    .btn-primary:hover { background: #2563eb; border-color: #2563eb; color: #fff; }
    .btn-primary:hover svg { stroke: #fff; }
    .btn-danger { border-color: #dc2626; color: #dc2626; }
    .btn-danger svg { stroke: #dc2626; }
    .btn-danger:hover { background: #dc2626; border-color: #dc2626; color: #fff; }
    .btn-danger:hover svg { stroke: #fff; }
    .btn-danger:disabled { opacity: 0.4; cursor: not-allowed; background: transparent; color: #dc2626; }
    .btn-danger:disabled svg { stroke: #dc2626; }
    .section { margin-top: 48px; }
    .section:first-of-type { margin-top: 0; }
    .section-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
    .danger-zone { margin-top: 48px; padding: 24px; background: rgba(220, 38, 38, 0.1); border: 1px solid #dc2626; border-radius: 8px; }
    .danger-zone .section-label { color: #dc2626; margin-bottom: 12px; }
    .danger-zone p { font-size: 13px; color: #94a3b8; margin-bottom: 16px; line-height: 1.5; }
    .danger-zone input { background: #0f172a; margin-top: 0; margin-bottom: 12px; }
    .icon { position: fixed; top: 24px; right: 24px; width: 20px; height: 20px; cursor: pointer; opacity: 0.4; transition: opacity 0.2s; z-index: 10; }
    .icon:hover { opacity: 1; }
    .menu { display: none; position: fixed; top: 52px; right: 24px; background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 8px 0; z-index: 20; min-width: 140px; }
    .menu.show { display: block; }
    .menu-item { display: flex; align-items: center; gap: 10px; padding: 10px 16px; color: #94a3b8; font-size: 14px; cursor: pointer; transition: background 0.15s; }
    .menu-item:hover { background: #334155; color: #f8fafc; }
    .menu-item svg { width: 16px; height: 16px; stroke: currentColor; }
  </style>
</head>
<body>
  <svg class="icon" id="icon" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" role="button" aria-label="Settings"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.2 4.2l2.8 2.8M17 17l2.8 2.8M1 12h4M19 12h4M4.2 19.8l2.8-2.8M17 7l2.8-2.8"/></svg>
  <div class="menu" id="menu">
    <div class="menu-item" id="menuAdd"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>Add</div>
    <div class="menu-item" id="menuEdit"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Edit</div>
    <div class="menu-item" id="menuSettings"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.2 4.2l2.8 2.8M17 17l2.8 2.8M1 12h4M19 12h4M4.2 19.8l2.8-2.8M17 7l2.8-2.8"/></svg>Settings</div>
  </div>
  <div class="card" id="card">
    <div class="stats"><span id="counter">-</span><span id="streak"><svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;stroke:#f97316;fill:none" viewBox="0 0 24 24" stroke-width="2"><path d="M12 2c.4 2.3.6 4.5 0 6.5C10.5 5 8 4 6 5c1 2.5 1.5 5 1 7.5C5 11 3 9.5 2 11c1 3 2 6 5 8 1.5 1 3 2 5 2s3.5-1 5-2c3-2 4-5 5-8-1-1.5-3 0-5 1.5.5-2.5 0-5-1-7.5-2-1-4.5 0-6 3.5.6-2 .4-4.2 0-6.5z"/></svg><span id="streakNum">0</span></span></div>
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    <div class="ex" id="ex"></div>
    <div class="def" id="def">Loading...</div>
    <input type="text" id="ans" autofocus>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-inner">
      <div class="modal-header">
        <span class="modal-title" id="editModalTitle">Edit Card</span>
        <svg class="modal-close" id="closeEdit" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" role="button" aria-label="Close"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </div>
      <div class="section">
        <div class="section-label">Word</div>
        <input type="text" id="word" placeholder="Enter word">
      </div>
      <div class="section">
        <div class="section-label">Definition</div>
        <input type="text" id="defIn" placeholder="Enter definition">
      </div>
      <div class="section">
        <div class="section-label">Example (optional)</div>
        <input type="text" id="exIn" placeholder="Sentence using the word">
      </div>
      <div class="btns">
        <div class="btn btn-primary" id="btnSave"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2zM17 21v-8H7v8M7 3v5h8"/></svg><span id="btnSaveText">Save</span></div>
        <div class="btn btn-danger" id="btnDel" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>Delete</div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-inner">
      <div class="modal-header">
        <span class="modal-title">Settings</span>
        <svg class="modal-close" id="closeSettings" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" role="button" aria-label="Close"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </div>
      <div class="section">
        <div class="section-label">Import Cards</div>
        <textarea id="csv" placeholder="Paste JSON array to import..."></textarea>
        <div class="btns">
          <div class="btn" id="btnImport"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>Import</div>
        </div>
      </div>
      <div class="section">
        <div class="section-label">Export Cards</div>
        <p style="font-size: 13px; color: #94a3b8; margin-bottom: 12px;">Download all cards as a JSON file.</p>
        <div class="btns">
          <div class="btn" id="btnExport"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>Export</div>
        </div>
      </div>
      <div class="danger-zone">
        <div class="section-label">Danger Zone</div>
        <p>This will permanently delete all your flashcards. Type <strong style="color:#f8fafc">DELETE</strong> to confirm.</p>
        <input type="text" id="confirmDelete" placeholder="Type DELETE to confirm">
        <div class="btns">
          <div class="btn btn-danger" id="btnClear" disabled><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/></svg>Clear All Cards</div>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import { FSRS, Rating, createEmptyCard } from 'https://unpkg.com/ts-fsrs/dist/index.mjs';
    const f = new FSRS(), cards = JSON.parse(localStorage.getItem('fc') || '[]');
    let cur = null, answered = false, editMode = false;
    let streakData = JSON.parse(localStorage.getItem('streak') || '{"count":0,"date":""}');
    let sessionData = JSON.parse(localStorage.getItem('session') || '{"count":0,"wrong":0,"words":[],"date":""}');
    const isToday = sessionData.date === new Date().toDateString();
    let sessionCount = isToday ? sessionData.count : 0;
    let wrongCount = isToday ? (sessionData.wrong || 0) : 0;
    let wrongWords = isToday ? (sessionData.words || []) : [];

    const save = () => localStorage.setItem('fc', JSON.stringify(cards));
    const due = () => cards.filter(c => new Date(c.card.due) <= new Date());
    const today = () => new Date().toDateString();
    const updateStreak = () => {
      if (streakData.date !== today()) {
        streakData = { count: streakData.date === new Date(Date.now()-86400000).toDateString() ? streakData.count + 1 : 1, date: today() };
        localStorage.setItem('streak', JSON.stringify(streakData));
      }
    };

    const saveSession = () => localStorage.setItem('session', JSON.stringify({ count: sessionCount, wrong: wrongCount, words: wrongWords, date: new Date().toDateString() }));
    const sessionLimit = () => 51 + wrongCount;

    function next(pickNew = true) {
      if (sessionCount >= sessionLimit()) {
        ex.textContent = ''; ans.style.display = 'none';
        def.innerHTML = 'Session complete!<div class="btns" style="justify-content:center;margin-top:24px"><div class="btn btn-primary" id="btnNewSession">New Session</div><div class="btn" id="btnDone">Done</div></div>';
        document.getElementById('btnNewSession').onclick = () => { sessionCount = 0; wrongCount = 0; wrongWords = []; saveSession(); next(); };
        document.getElementById('btnDone').onclick = () => { def.innerHTML = 'See you tomorrow!'; };
        return;
      }
      let d = due();
      const wrongCards = cards.filter(c => wrongWords.includes(c.word) && !d.includes(c));
      d = [...d, ...wrongCards];
      streakNum.textContent = streakData.count;
      if (!d.length) d = cards;
      if (!d.length) { def.textContent = 'No cards yet'; ex.textContent = ''; ans.style.display = 'none'; counter.textContent = ''; cur = null; return; }
      if (pickNew) {
        sessionCount++;
        saveSession();
        cur = d[Math.floor(Math.random() * d.length)];
        localStorage.setItem('curWord', cur.word);
      }
      counter.textContent = sessionCount + ' / ' + sessionLimit();
      progressBar.style.width = (sessionCount / sessionLimit() * 100) + '%';
      def.textContent = cur.def + (cur.word ? ' (' + cur.word[0].toLowerCase() + ')' : '');
      const esc = (cur.word || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      ex.textContent = (cur.ex || '').replace(esc ? new RegExp(esc, 'gi') : '', '___');
      ans.value = ''; ans.style.display = ''; ans.classList.remove('correct', 'wrong'); answered = false; ans.focus();
    }

    ans.onkeydown = e => {
      if (e.key !== 'Enter' || !cur) return;
      if (answered) { card.classList.add('fade'); setTimeout(() => { next(); card.classList.remove('fade'); }, 150); return; }
      const correct = ans.value.trim().toLowerCase() === (cur.word || '').toLowerCase();
      cur.card = f.repeat(cur.card, new Date())[correct ? Rating.Good : Rating.Again].card;
      if (correct) { wrongWords = wrongWords.filter(w => w !== cur.word); }
      else { wrongCount++; if (!wrongWords.includes(cur.word)) wrongWords.push(cur.word); card.classList.add('shake'); setTimeout(() => card.classList.remove('shake'), 400); }
      saveSession();
      ans.classList.remove('correct', 'wrong');
      ans.classList.add(correct ? 'correct' : 'wrong');
      const esc = (cur.word || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      ex.style.opacity = '0';
      setTimeout(() => {
        ex.innerHTML = esc ? (cur.ex || '').replace(new RegExp(`(${esc})`, 'gi'), `<span style="color:${correct ? '#22c55e' : '#ef4444'};font-weight:600">$1</span>`) : (cur.ex || '');
        ex.style.opacity = '1';
      }, 150);
      answered = true; updateStreak(); save(); ans.focus();
    };

    const openEditModal = (edit = false) => {
      editMode = edit;
      editModal.style.display = 'block';
      editModalTitle.textContent = edit ? 'Edit Card' : 'Add New Card';
      btnSaveText.textContent = edit ? 'Save' : 'Add';
      btnDel.style.display = edit && cur ? 'flex' : 'none';
      if (edit && cur) {
        word.value = cur.word;
        defIn.value = cur.def;
        exIn.value = cur.ex || '';
      } else {
        word.value = defIn.value = exIn.value = '';
      }
      word.focus();
    };

    const closeEditModal = () => {
      editModal.style.display = 'none';
      ans.focus();
    };

    const openSettingsModal = () => {
      settingsModal.style.display = 'block';
      confirmDelete.value = '';
      btnClear.disabled = true;
      csv.value = '';
    };

    const closeSettingsModal = () => {
      settingsModal.style.display = 'none';
      ans.focus();
    };

    // Menu toggle
    const toggleMenu = () => { menu.classList.toggle('show'); menuEdit.style.display = cur ? 'flex' : 'none'; };
    const closeMenu = () => menu.classList.remove('show');
    document.addEventListener('click', e => { if (!menu.contains(e.target) && e.target !== icon) closeMenu(); });

    // Event listeners
    icon.onclick = toggleMenu;
    menuAdd.onclick = () => { closeMenu(); openEditModal(false); };
    menuEdit.onclick = () => { closeMenu(); openEditModal(true); };
    menuSettings.onclick = () => { closeMenu(); openSettingsModal(); };
    closeSettings.onclick = closeSettingsModal;
    closeEdit.onclick = closeEditModal;

    confirmDelete.oninput = () => btnClear.disabled = confirmDelete.value !== 'DELETE';

    btnSave.onclick = () => {
      if (!word.value.trim() || !defIn.value.trim()) { alert('Word and definition are required'); return; }
      if (editMode && cur) { cur.word = word.value.trim(); cur.def = defIn.value.trim(); cur.ex = exIn.value.trim(); }
      else cards.push({ word: word.value.trim(), def: defIn.value.trim(), ex: exIn.value.trim(), card: createEmptyCard() });
      save(); closeEditModal(); next();
    };

    btnDel.onclick = () => {
      const i = cards.indexOf(cur);
      if (cur && i >= 0 && confirm('Delete "' + cur.word + '"?')) { cards.splice(i, 1); save(); localStorage.removeItem('curWord'); closeEditModal(); next(); }
    };

    btnImport.onclick = () => {
      if (!csv.value.trim()) return;
      try {
        const imported = JSON.parse(csv.value);
        if (!Array.isArray(imported)) { alert('Invalid format'); return; }
        const valid = imported.filter(c => c && c.word && c.def && c.card);
        if (!valid.length) { alert('No valid cards'); return; }
        valid.forEach(c => cards.push(c));
        save(); csv.value = ''; closeSettingsModal(); next();
        alert('Imported ' + valid.length + ' cards');
      } catch { alert('Invalid JSON'); }
    };

    btnExport.onclick = () => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(cards, null, 2)], {type: 'application/json'}));
      a.download = 'flashcards.json'; a.click();
    };

    btnClear.onclick = () => {
      if (confirmDelete.value === 'DELETE') {
        cards.length = 0;
        save();
        localStorage.removeItem('curWord');
        closeSettingsModal();
        next();
        alert('All cards have been deleted.');
      }
    };

    // Restore current card on page load, or pick new
    const savedWord = localStorage.getItem('curWord');
    cur = savedWord ? cards.find(c => c.word === savedWord) : null;
    if (cur) next(false); else next();
  </script>
</body>
</html>
