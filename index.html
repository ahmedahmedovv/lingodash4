<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280">
    <title>Flashcards</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 1rem system-ui, -apple-system, sans-serif; background: #f5f5f7; color: #1d1d1f; min-height: 100vh; }

        .container { max-width: 1600px; margin: 0 auto; padding: 2rem 3rem; display: grid; grid-template-columns: 1fr 420px; gap: 3rem; min-height: calc(100vh - 3rem); transition: all .3s; align-items: start; }
        .container.focus-mode { grid-template-columns: 1fr; max-width: 900px; }
        .container.focus-mode .sidebar { display: none; }

        /* Top Bar */
        .top-bar { position: fixed; top: 1.5rem; right: 1.5rem; display: flex; gap: .75rem; align-items: center; font-size: 1rem; color: #86868b; z-index: 10; }
        .focus-btn { background: #fff; border: 1px solid #d2d2d7; font-size: 1.1rem; cursor: pointer; padding: .5rem .75rem; border-radius: 8px; transition: all .2s; }
        .focus-btn:hover { background: #f5f5f7; }

        /* Study Panel */
        .study-panel { background: #fff; border-radius: 20px; padding: 4rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 550px; box-shadow: 0 2px 8px rgba(0,0,0,.08); position: sticky; top: 1.5rem; align-self: flex-start; z-index: 5; }
        .sentence { font-size: 2.2rem; line-height: 1.5; text-align: center; margin-bottom: 2rem; color: #1d1d1f; max-width: 900px; }
        .hint { color: #86868b; font-size: 1.3rem; margin-bottom: 3rem; text-align: center; font-style: italic; max-width: 800px; }
        .input-wrap { position: relative; }
        input[type="text"] { border: 2px solid #d2d2d7; background: #f5f5f7; border-radius: 14px; padding: 1.3rem 2rem; width: 400px; font-size: 1.4rem; text-align: center; outline: none; transition: all .2s; }
        input[type="text"]:focus { border-color: #0071e3; background: #fff; }
        .msg { margin-top: 2rem; font-size: 1.2rem; min-height: 1.5rem; font-weight: 500; }
        
        /* Study Actions */
        .study-actions { display: flex; justify-content: center; gap: 2rem; margin-top: 1.5rem; }
        .study-actions button { width: 44px; height: 44px; padding: 0; font-size: 1.3rem; background: transparent; border: none; border-radius: 8px; cursor: pointer; opacity: .6; transition: opacity .2s; }
        .study-actions button:hover { opacity: 1; background: #f5f5f7; }
        .study-actions .btn-delete:hover { background: #ffeceb; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-overlay.show { display: flex; }
        .modal { background: #fff; border-radius: 16px; padding: 2rem; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,.2); }
        .modal h3 { margin-bottom: 1.5rem; font-size: 1.3rem; }
        .modal .form-group { margin-bottom: 1rem; }
        .modal label { display: block; font-size: .85rem; color: #86868b; margin-bottom: .3rem; }
        .modal input, .modal textarea { width: 100%; padding: .75rem; border: 1px solid #d2d2d7; border-radius: 8px; font: inherit; font-size: 1rem; }
        .modal input:focus, .modal textarea:focus { outline: none; border-color: #0071e3; }
        .modal textarea { height: 80px; resize: none; }
        .modal .error { color: #ff3b30; font-size: .85rem; margin-top: .25rem; display: none; }
        .modal .error.show { display: block; }
        .modal .preview { font-size: .9rem; color: #86868b; margin-top: .5rem; padding: .5rem; background: #f5f5f7; border-radius: 6px; display: none; }
        .modal .preview.show { display: block; }
        .modal .preview strong { background: #0071e3; color: #fff; padding: .1rem .4rem; border-radius: 4px; }
        .modal-btns { display: flex; gap: .75rem; justify-content: flex-end; margin-top: 1.5rem; }
        .btn-save { background: #0071e3; color: #fff; border-color: #0071e3; }
        .ok { color: #34c759; font-weight: 600; }
        .no { color: #ff3b30; font-weight: 600; }
        .done-msg { color: #86868b; }
        .done-msg button { margin-top: 1rem; }

        /* Session Progress */
        .session-info { position: fixed; top: 1.5rem; left: 1.5rem; background: #fff; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.1); font-size: 1.1rem; z-index: 10; }
        .session-info .progress-bar { width: 180px; height: 6px; background: #e8e8ed; border-radius: 3px; margin-top: .5rem; overflow: hidden; }
        .session-info .progress-fill { height: 100%; background: #0071e3; border-radius: 2px; transition: width .3s; }
        .session-info .mistake-badge { color: #ff3b30; font-weight: 600; }

        /* Review Mode Banner */
        .review-banner { background: #fff5f5; border: 1px solid #ffccc9; color: #ff3b30; padding: 1rem 2rem; border-radius: 12px; margin-bottom: 2rem; font-weight: 500; font-size: 1.1rem; display: flex; align-items: center; gap: .5rem; }
        .review-banner::before { content: "üîÑ"; }

        /* Session Complete */
        .session-complete { text-align: center; }
        .session-complete h2 { font-size: 2.5rem; margin-bottom: 1.5rem; color: #34c759; }
        .session-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 2rem 0; max-width: 450px; }
        .session-stat { background: #f5f5f7; padding: 1.25rem; border-radius: 12px; }
        .session-stat .num { font-size: 2.2rem; font-weight: 600; color: #1d1d1f; }
        .session-stat .label { font-size: .85rem; color: #86868b; margin-top: .25rem; }

        /* Welcome Page */
        .welcome-page { background: #fff; border-radius: 20px; padding: 3rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; box-shadow: 0 2px 8px rgba(0,0,0,.08); text-align: center; }
        .welcome-page h1 { font-size: 2rem; margin-bottom: 2rem; color: #1d1d1f; }
        .welcome-form { width: 100%; max-width: 360px; }
        .welcome-form label { display: block; text-align: left; font-size: .85rem; color: #86868b; margin-bottom: .25rem; }
        .welcome-form select, .welcome-form input[type="number"] { width: 100%; padding: .875rem; border: 1px solid #d2d2d7; border-radius: 10px; font: inherit; font-size: 1.2rem; margin-bottom: 1.5rem; background: #fff; }
        .welcome-form button { width: 100%; padding: 1rem; background: #0071e3; color: #fff; border: none; border-radius: 10px; font: inherit; font-size: 1.2rem; font-weight: 500; cursor: pointer; }
        .welcome-form button:hover { background: #0077ed; }
        .welcome-form button:disabled { background: #d2d2d7; cursor: not-allowed; }

        /* Buttons */
        button { background: #f5f5f7; border: 1px solid #d2d2d7; color: #1d1d1f; padding: .7rem 1.4rem; border-radius: 8px; font: inherit; font-size: 1.05rem; cursor: pointer; transition: all .2s; }
        button:hover { background: #e8e8ed; }
        .btn-primary { background: #0071e3; border-color: #0071e3; color: #fff; }
        .btn-primary:hover { background: #0077ed; }
        .btn-danger { color: #ff3b30; border-color: #ffccc9; background: #fff5f5; }
        .btn-danger:hover { background: #ffeceb; }
        .btn-success { background: #34c759; border-color: #34c759; color: #fff; }
        .btn-success:hover { background: #30b350; }

        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 1.25rem; }

        /* Header Section - Language & Stats Combined */
        .sidebar-header { background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        .lang-section { display: flex; align-items: center; gap: .75rem; margin-bottom: 1rem; }
        .lang-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #0071e3, #00c6ff); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .lang-select-wrap { flex: 1; }
        .lang-select { width: 100%; padding: .5rem .75rem; border-radius: 8px; border: 1px solid #d2d2d7; background: #f5f5f7; font: inherit; font-size: .95rem; cursor: pointer; transition: all .2s; }
        .lang-select:hover { border-color: #0071e3; }
        .lang-actions { display: flex; gap: .25rem; }
        .lang-actions button { padding: .4rem .5rem; font-size: .85rem; background: transparent; border: none; border-radius: 6px; opacity: .6; }
        .lang-actions button:hover { opacity: 1; background: #f5f5f7; }

        /* Stats Pills */
        .stats-row { display: flex; gap: .5rem; flex-wrap: wrap; }
        .stat-pill { display: flex; align-items: center; gap: .4rem; padding: .5rem .75rem; background: #f5f5f7; border-radius: 20px; font-size: .9rem; }
        .stat-pill .icon { font-size: .95rem; }
        .stat-pill .num { font-weight: 600; color: #1d1d1f; }
        .stat-pill .label { color: #86868b; font-size: .8rem; }
        .stat-pill.due { background: #fff4e6; }
        .stat-pill.due .num { color: #ff9500; }
        .stat-pill.mastered { background: #e8f5e9; }
        .stat-pill.mastered .num { color: #34c759; }

        /* Data Management */
        .data-card { background: #fff; border-radius: 16px; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        .data-title { font-size: .75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #86868b; margin-bottom: .75rem; font-weight: 600; }
        .data-btns { display: flex; gap: .5rem; }
        .data-btns button { flex: 1; display: flex; align-items: center; justify-content: center; gap: .4rem; padding: .6rem; font-size: .85rem; background: #f5f5f7; border: 1px solid transparent; border-radius: 8px; }
        .data-btns button:hover { background: #e8e8ed; }
        .data-btns button.danger { color: #ff3b30; }
        .data-btns button.danger:hover { background: #ffeceb; border-color: #ffccc9; }

        /* Words Card - Improved */
        .words-card { background: #fff; border-radius: 16px; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .words-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem; }
        .words-title { font-size: .75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #86868b; font-weight: 600; }
        .words-title span { color: #1d1d1f; font-weight: 600; margin-left: .25rem; }
        .sort-select { font-size: .85rem; padding: .35rem .6rem; border-radius: 8px; border: 1px solid #d2d2d7; background: #f5f5f7; cursor: pointer; }
        .sort-select:hover { border-color: #0071e3; }
        .btn-add-card { display: flex; align-items: center; gap: .3rem; padding: .4rem .75rem; background: #0071e3; color: #fff; border: none; border-radius: 8px; font-size: .85rem; font-weight: 500; cursor: pointer; transition: all .2s; }
        .btn-add-card:hover { background: #0077ed; transform: translateY(-1px); }

        .words-list { flex: 1; overflow-y: auto; min-height: 0; margin: 0 -.25rem; padding: 0 .25rem; }
        .word-item { display: flex; align-items: center; padding: .6rem .5rem; border-radius: 10px; gap: .75rem; transition: background .15s; }
        .word-item:hover { background: #f5f5f7; }
        .word-status { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .word-status.due { background: #ff9500; box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.15); }
        .word-status.ok { background: #34c759; }
        .word-status.new { background: #86868b; }
        .word-info { flex: 1; min-width: 0; }
        .word-name { font-weight: 500; font-size: 1rem; color: #1d1d1f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .word-meta { font-size: .75rem; color: #86868b; margin-top: .1rem; }
        .word-actions { display: flex; gap: .25rem; opacity: 0; transition: opacity .15s; }
        .word-item:hover .word-actions { opacity: 1; }
        .word-actions button { padding: .35rem .5rem; font-size: .75rem; background: transparent; border: none; border-radius: 6px; opacity: .6; }
        .word-actions button:hover { opacity: 1; background: #e8e8ed; }
        .word-actions button.danger { color: #ff3b30; }
        .word-actions button.danger:hover { background: #ffeceb; }

        /* Empty state for words list */
        .words-empty { text-align: center; padding: 2rem 1rem; color: #86868b; font-size: .9rem; }
        .words-empty .icon { font-size: 2rem; margin-bottom: .5rem; opacity: .5; }

        /* Language Form */
        .lang-form { display: none; margin-top: .75rem; padding: .75rem; background: #f5f5f7; border-radius: 10px; }
        .lang-form.show { display: block; animation: slideDown .2s ease; }
        .lang-form input { width: 100%; padding: .5rem .75rem; margin-bottom: .4rem; border: 1px solid #d2d2d7; border-radius: 8px; font: inherit; font-size: .9rem; }
        .lang-form-btns { display: flex; gap: .4rem; justify-content: flex-end; }
        .lang-form-btns button { font-size: .85rem; padding: .4rem .75rem; }

        /* Large screens */
        @media (min-width: 1920px) {
            .container { max-width: 1800px; grid-template-columns: 1fr 480px; gap: 4rem; }
            .sentence { font-size: 2.6rem; max-width: 1000px; }
            .hint { font-size: 1.4rem; }
            input[type="text"] { width: 450px; font-size: 1.6rem; }
            .study-panel { min-height: 600px; }
        }

        input[type="file"] { display: none; }

        /* Shake animation for wrong answer */
        .shake { animation: shake 0.5s ease; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }
    </style>
</head>
<body>
<div class="session-info" id="sessionInfo" style="display: none;">
    <div>Session: <span id="sessionProgress">0/20</span> <span id="mistakeBadge" class="mistake-badge" style="display: none;"></span></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
</div>

<div class="top-bar">
    <span><strong id="dueCount">0</strong> due</span>
    <button class="focus-btn" onclick="toggleFocus()" title="Toggle sidebar" id="focusBtn">‚ò∞</button>
</div>

<div class="container">
    <main class="study-panel" id="studyPanel">
        <!-- Welcome Page -->
        <div class="welcome-page" id="welcomePage">
            <h1>Flashcards</h1>
            <div class="welcome-form">
                <label>Language</label>
                <select id="welcomeLangSelect" onchange="changeWelcomeLang()">
                    <option value="en">English</option>
                </select>
                
                <label>Cards to study (<span id="welcomeDue">0</span> due)</label>
                <input type="number" id="sessionSizeInput" value="20" min="1" max="500">
                
                <button id="startBtn" onclick="startSession()">Start</button>
            </div>
        </div>

        <!-- Study Interface (hidden initially) -->
        <div id="studyInterface" style="display: none; width: 100%; text-align: center;">
            <div class="review-banner" id="reviewBanner" style="display: none;">Mistake Review Mode</div>
            <p class="sentence" id="sentence"></p>
            <p class="hint" id="hint"></p>
            <div class="input-wrap">
                <input type="text" id="answer" autocomplete="off">
            </div>
            <p class="msg" id="msg"></p>
            <div class="study-actions" id="studyActions" style="display: none;">
                <button onclick="editCurrentCard()" title="Edit">‚úèÔ∏è</button>
                <button class="btn-delete" onclick="deleteCurrentCard()" title="Delete">üóëÔ∏è</button>
            </div>
            
            <!-- Edit Modal -->
            <div class="modal-overlay" id="editModal" onclick="if(event.target===this)closeEditModal()">
                <div class="modal">
                    <h3>Edit Card</h3>
                    <div class="form-group">
                        <label>Word</label>
                        <input type="text" id="editWord" oninput="validateEdit()">
                    </div>
                    <div class="form-group">
                        <label>Definition</label>
                        <input type="text" id="editDef">
                    </div>
                    <div class="form-group">
                        <label>Sentence (include the word)</label>
                        <textarea id="editSent" oninput="validateEdit()"></textarea>
                        <p class="error" id="editError">Include the word in your sentence</p>
                        <div class="preview" id="editPreview"></div>
                    </div>
                    <div class="modal-btns">
                        <button onclick="closeEditModal()">Cancel</button>
                        <button class="btn-primary" onclick="saveEdit()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <aside class="sidebar">
        <!-- Header: Language + Stats -->
        <div class="sidebar-header">
            <div class="lang-section">
                <div class="lang-icon">üåê</div>
                <div class="lang-select-wrap">
                    <select class="lang-select" id="langSelect" onchange="switchLang()">
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="lang-actions">
                    <button onclick="toggleLangForm()" title="Add language">+</button>
                    <button onclick="renameLang()" title="Rename">‚úé</button>
                </div>
            </div>
            <div class="lang-form" id="langForm">
                <input id="newLangName" placeholder="Language name (e.g., Spanish)">
                <input id="newLangCode" placeholder="Code (e.g., es)">
                <div class="lang-form-btns">
                    <button onclick="cancelLangForm()">Cancel</button>
                    <button class="btn-primary" onclick="addLang()">Add</button>
                </div>
            </div>
            
            <div class="stats-row">
                <div class="stat-pill due">
                    <span class="icon">‚è∞</span>
                    <span class="num" id="statDue">0</span>
                    <span class="label">due</span>
                </div>
                <div class="stat-pill">
                    <span class="icon">üìö</span>
                    <span class="num" id="statLearning">0</span>
                    <span class="label">learning</span>
                </div>
                <div class="stat-pill mastered">
                    <span class="icon">‚≠ê</span>
                    <span class="num" id="statMastered">0</span>
                    <span class="label">mastered</span>
                </div>
                <div class="stat-pill">
                    <span class="icon">üéØ</span>
                    <span class="num" id="statAccuracy">0%</span>
                    <span class="label">accuracy</span>
                </div>
            </div>
        </div>

        <!-- Data Management -->
        <div class="data-card">
            <div class="data-title">Data</div>
            <div class="data-btns">
                <button onclick="exp()">
                    <span>üì§</span> Export
                </button>
                <button onclick="imp.click()">
                    <span>üì•</span> Import
                </button>
                <button class="danger" onclick="clearWords()">
                    <span>üóëÔ∏è</span> Clear
                </button>
            </div>
            <input type="file" id="imp" accept=".json" onchange="handleImport(this)">
        </div>

        <!-- Words List -->
        <div class="words-card">
            <div class="words-header">
                <div class="words-title">Cards <span id="langCount">0</span></div>
                <div style="display: flex; gap: .5rem; align-items: center;">
                    <button class="btn-add-card" onclick="openAddModal()" title="Add new card">
                        <span>‚ûï</span> Add
                    </button>
                    <select class="sort-select" id="sortSelect" onchange="renderList()">
                        <option value="due">Due First</option>
                        <option value="word">A-Z</option>
                        <option value="ef">Hardest</option>
                        <option value="stage">Stage</option>
                    </select>
                </div>
            </div>
            <div class="words-list" id="wordsList"></div>
        </div>
    </aside>

    <!-- Add Card Modal -->
    <div class="modal-overlay" id="addModal" onclick="if(event.target===this)closeAddModal()">
        <div class="modal">
            <h3>Add New Card</h3>
            <div class="form-group">
                <label>Word</label>
                <input type="text" id="aWord" placeholder="e.g., elephant" oninput="validateAddForm()">
            </div>
            <div class="form-group">
                <label>Definition (hint)</label>
                <input type="text" id="aDef" placeholder="e.g., a large animal with a trunk">
            </div>
            <div class="form-group">
                <label>Sentence (include the word)</label>
                <textarea id="aSent" placeholder="e.g., The elephant sprayed water with its trunk." oninput="validateAddForm()"></textarea>
                <p class="error" id="addError">Include the word in your sentence</p>
                <div class="preview" id="addPreview"></div>
            </div>
            <div class="modal-btns">
                <button onclick="closeAddModal()">Cancel</button>
                <button class="btn-primary" onclick="saveCard()">Save Card</button>
            </div>
        </div>
    </div>
</div>

<script>
// DOM Element References
const sentence = document.getElementById('sentence');
const hint = document.getElementById('hint');
const answer = document.getElementById('answer');
const msg = document.getElementById('msg');

// Data State
let cards = JSON.parse(localStorage.cards || 'null') || [
    {w:'apple', s:'She took a bite of the crisp red apple.', d:'a round fruit', lang:'en'},
    {w:'banana', s:'The monkey peeled the banana before eating.', d:'a long curved yellow fruit', lang:'en'},
    {w:'door', s:'Please close the door behind you.', d:'a barrier for an entrance', lang:'en'}
], cur, editIdx = -1, answerStartTime = 0;

let languages = JSON.parse(localStorage.languages || 'null') || [{code: 'en', name: 'English'}];
let currentLang = localStorage.currentLang || 'en';

// Session State
let sessionSize = 20;
let sessionCardsStudied = 0;
let sessionMistakes = [];
let reviewingMistakes = false;
let inSession = false;
let sessionDueCards = [];
const INTERLEAVE_INTERVAL = 10;
let waitingForNext = false;
let lastAnswerWrong = false;

// Data Access Functions
const save = () => localStorage.cards = JSON.stringify(cards);
const saveLangs = () => localStorage.languages = JSON.stringify(languages);
const saveCurrentLang = () => localStorage.currentLang = currentLang;
const dueCards = () => cards.filter(c => (c.due||0) <= Date.now() && (c.lang || 'en') === currentLang);
const currentLangCards = () => cards.filter(c => (c.lang || 'en') === currentLang);
const findCardIndex = (card) => cards.findIndex(c => c.w === card.w && c.s === card.s && c.lang === card.lang);
const removeCardFromSession = (card) => {
    sessionDueCards = sessionDueCards.filter(c => !(c.w === card.w && c.s === card.s));
    sessionMistakes = sessionMistakes.filter(c => !(c.w === card.w && c.s === card.s));
};

// Escape special regex characters
function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Shared Validation Utility
function validateSentence(word, sentence, errorId, previewId) {
    const errorEl = document.getElementById(errorId);
    const previewEl = document.getElementById(previewId);
    
    if (word && sentence) {
        if (sentence.toLowerCase().includes(word.toLowerCase())) {
            errorEl?.classList.remove('show');
            previewEl?.classList.add('show');
            if (previewEl) {
                previewEl.innerHTML = sentence.replace(new RegExp('(' + escapeRegex(word) + ')', 'gi'), '<strong>___</strong>');
            }
            return true;
        } else {
            errorEl?.classList.add('show');
            previewEl?.classList.remove('show');
            return false;
        }
    } else {
        errorEl?.classList.remove('show');
        previewEl?.classList.remove('show');
        return false;
    }
}

// SM-2 Algorithm Implementation
function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array.from({length: m + 1}, () => Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            dp[i][j] = a[i-1] === b[j-1] ? dp[i-1][j-1] : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
        }
    }
    return dp[m][n];
}

function calculateQuality(userAnswer, correctAnswer, responseTimeMs) {
    const ua = userAnswer.trim().toLowerCase();
    const ca = correctAnswer.toLowerCase();
    const isCorrect = ua === ca;
    const distance = levenshtein(ua, ca);
    const similarity = 1 - distance / Math.max(ca.length, 1);
    const seconds = responseTimeMs / 1000;

    if (isCorrect) {
        return seconds < 3 ? 5 : seconds < 8 ? 4 : 3;
    }
    return similarity >= 0.8 ? 2 : similarity >= 0.5 ? 1 : 0;
}

function sm2(card, quality) {
    if (card.ef === undefined) card.ef = 2.5;
    if (card.n === undefined) card.n = 0;

    const qDiff = 5 - quality;
    card.ef = Math.max(1.3, card.ef + (0.1 - qDiff * (0.08 + qDiff * 0.02)));

    let intervalMins;
    if (quality < 3) {
        card.n = 0;
        intervalMins = 1;
    } else {
        if (card.n === 0) intervalMins = 1;
        else if (card.n === 1) intervalMins = 10;
        else if (card.n === 2) intervalMins = 1440;
        else if (card.n === 3) intervalMins = 6 * 1440;
        else intervalMins = Math.round((card.int || 1440) * card.ef);
        card.n++;
    }

    card.int = Math.min(intervalMins, 525600);
    card.due = Date.now() + card.int * 60000;
    return quality >= 3;
}

function toggleFocus() {
    const container = document.querySelector('.container');
    const focusBtn = document.getElementById('focusBtn');
    const isFocus = container.classList.toggle('focus-mode');
    focusBtn.textContent = isFocus ? '‚óß' : '‚ò∞';
    localStorage.focusMode = isFocus;
}

if (localStorage.focusMode === 'true') {
    document.querySelector('.container').classList.add('focus-mode');
    document.getElementById('focusBtn').textContent = '‚óß';
}

// Welcome Page Functions
function updateWelcomeStats() {
    const due = dueCards().length;
    document.getElementById('welcomeDue').textContent = due;
    const startBtn = document.getElementById('startBtn');
    startBtn.disabled = due === 0;
    startBtn.textContent = due === 0 ? 'No Cards Due' : 'Start';
}

function updateWelcomeLangSelect() {
    const select = document.getElementById('welcomeLangSelect');
    select.innerHTML = languages.map(l => `<option value="${l.code}"${l.code === currentLang ? ' selected' : ''}>${l.name}</option>`).join('');
}

function changeWelcomeLang() {
    currentLang = document.getElementById('welcomeLangSelect').value;
    saveCurrentLang();
    renderLangSelect();
    updateWelcomeStats();
    updateStats();
    renderList();
}

function startSession() {
    const due = dueCards();
    if (due.length === 0) return;
    
    sessionSize = Math.min(500, Math.max(1, parseInt(document.getElementById('sessionSizeInput').value) || 20));
    
    document.getElementById('welcomePage').style.display = 'none';
    document.getElementById('studyInterface').style.display = '';
    
    inSession = true;
    sessionCardsStudied = 0;
    sessionMistakes = [];
    reviewingMistakes = false;
    waitingForNext = false;
    lastAnswerWrong = false;
    
    sessionDueCards = due.slice(0, sessionSize).sort(() => Math.random() - 0.5);
    
    updateSessionUI();
    document.getElementById('sessionInfo').style.display = 'block';
    show();
}

function returnToWelcome() {
    inSession = false;
    sessionCardsStudied = 0;
    sessionMistakes = [];
    reviewingMistakes = false;
    waitingForNext = false;
    lastAnswerWrong = false;
    sessionDueCards = [];
    
    document.getElementById('studyInterface').style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    document.getElementById('welcomePage').style.display = '';
    document.getElementById('sessionInfo').style.display = 'none';
    document.getElementById('msg').innerHTML = '';
    
    updateWelcomeStats();
    updateStats();
}

function updateSessionUI() {
    const totalInSession = Math.min(sessionSize, sessionDueCards.length + sessionCardsStudied);
    const progress = Math.min(sessionCardsStudied, totalInSession);
    const percent = totalInSession > 0 ? (progress / totalInSession * 100) : 0;
    
    document.getElementById('sessionProgress').textContent = `${progress}/${totalInSession}`;
    document.getElementById('progressFill').style.width = `${percent}%`;
    
    const badge = document.getElementById('mistakeBadge');
    if (sessionMistakes.length > 0 && !reviewingMistakes) {
        badge.textContent = `(${sessionMistakes.length} mistakes)`;
        badge.style.display = '';
    } else {
        badge.style.display = 'none';
    }
}

function checkInterleaveReview() {
    if (!reviewingMistakes && sessionMistakes.length > 0 && sessionCardsStudied > 0 && sessionCardsStudied % INTERLEAVE_INTERVAL === 0) {
        reviewingMistakes = true;
        return true;
    }
    return false;
}

function renderLangSelect() {
    const select = document.getElementById('langSelect');
    select.innerHTML = languages.map(l => `<option value="${l.code}"${l.code === currentLang ? ' selected' : ''}>${l.name}</option>`).join('');
    document.getElementById('langCount').textContent = currentLangCards().length;
    updateWelcomeLangSelect();
}

function switchLang() {
    currentLang = document.getElementById('langSelect').value;
    saveCurrentLang();
    renderLangSelect();
    updateWelcomeLangSelect();
    if (inSession) {
        returnToWelcome();
    } else {
        updateWelcomeStats();
    }
    updateStats();
    renderList();
}

function toggleLangForm() {
    document.getElementById('langForm').classList.toggle('show');
    document.getElementById('newLangName').focus();
}

function cancelLangForm() {
    document.getElementById('langForm').classList.remove('show');
    document.getElementById('newLangName').value = '';
    document.getElementById('newLangCode').value = '';
}

function addLang() {
    const name = document.getElementById('newLangName').value.trim();
    const code = document.getElementById('newLangCode').value.trim().toLowerCase();
    
    if (!name || !code) return;
    if (languages.find(l => l.code === code)) {
        alert('Language code already exists');
        return;
    }
    
    languages.push({name, code});
    saveLangs();
    currentLang = code;
    saveCurrentLang();
    renderLangSelect();
    updateWelcomeLangSelect();
    cancelLangForm();
    updateWelcomeStats();
    updateStats();
}

function renameLang() {
    const lang = languages.find(l => l.code === currentLang);
    if (!lang) return;
    
    const newName = prompt(`Rename "${lang.name}":`, lang.name);
    if (newName?.trim()) {
        lang.name = newName.trim();
        saveLangs();
        renderLangSelect();
        updateWelcomeLangSelect();
    }
}

function formatInterval(mins) {
    if (!mins || mins <= 1) return 'new';
    if (mins < 60) return `${Math.round(mins)}m`;
    if (mins < 1440) return `${Math.round(mins/60)}h`;
    return `${Math.round(mins/1440)}d`;
}

function updateStats() {
    const langCards = currentLangCards();
    const due = dueCards().length;
    const mastered = langCards.filter(c => (c.n||0) >= 4).length;
    const totalReviews = langCards.reduce((a,c) => a + (c.reviews||0), 0);
    const totalCorrect = langCards.reduce((a,c) => a + (c.correct||0), 0);
    const accuracy = totalReviews ? Math.round(totalCorrect/totalReviews*100) : 0;

    document.getElementById('dueCount').textContent = due;
    document.getElementById('statDue').textContent = due;
    document.getElementById('statLearning').textContent = langCards.length - mastered;
    document.getElementById('statMastered').textContent = mastered;
    document.getElementById('statAccuracy').textContent = `${accuracy}%`;
    document.getElementById('langCount').textContent = langCards.length;
}

function show() {
    waitingForNext = false;
    lastAnswerWrong = false;
    updateStats();
    renderList();
    
    if (reviewingMistakes && sessionMistakes.length > 0) {
        showMistakeReview();
        return;
    }
    
    if (inSession && checkInterleaveReview()) {
        showMistakeReview();
        return;
    }
    
    const dc = inSession ? sessionDueCards : dueCards();

    if (!dc.length) {
        if (inSession) {
            if (sessionMistakes.length > 0) {
                reviewingMistakes = true;
                showMistakeReview();
                return;
            }
            showSessionComplete();
        } else {
            showNoCards();
        }
        return;
    }

    document.getElementById('reviewBanner').style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    sentence.classList.remove('done-msg');
    answer.style.display = '';
    answer.readOnly = false;
    answer.style.background = '';
    msg.textContent = '';
    
    cur = inSession ? dc[0] : dc[Math.random()*dc.length|0];
    
    sentence.textContent = cur.s.replace(new RegExp(escapeRegex(cur.w), 'gi'), '___');
    hint.textContent = `${cur.d} (${cur.w[0]})`;
    answer.value = '';
    answer.focus();
    answerStartTime = Date.now();
}

function showMistakeReview() {
    waitingForNext = false;
    lastAnswerWrong = false;
    
    if (sessionMistakes.length === 0) {
        reviewingMistakes = false;
        show();
        return;
    }
    
    document.getElementById('reviewBanner').style.display = '';
    document.getElementById('studyActions').style.display = 'none';
    sentence.classList.remove('done-msg');
    answer.style.display = '';
    answer.readOnly = false;
    answer.style.background = '';
    msg.textContent = '';
    
    cur = sessionMistakes[0];
    sentence.textContent = cur.s.replace(new RegExp(escapeRegex(cur.w), 'gi'), '___');
    hint.textContent = `${cur.d} (${cur.w[0]})`;
    answer.value = '';
    answer.focus();
    answerStartTime = Date.now();
}

function showNoCards() {
    sentence.textContent = 'All done';
    sentence.classList.add('done-msg');
    hint.textContent = '';
    answer.style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    msg.innerHTML = '<button class="btn-primary" onclick="resetAll()">Study Again</button>';
}

function showSessionComplete() {
    sentence.classList.add('done-msg');
    hint.textContent = '';
    answer.style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    
    const sessionTotal = sessionCardsStudied;
    const mistakeCount = sessionMistakes.length;
    const correctCount = sessionTotal - mistakeCount;
    const accuracy = sessionTotal > 0 ? Math.round(correctCount / sessionTotal * 100) : 0;
    const remainingDue = dueCards().length;
    
    msg.innerHTML = 
        `<div class="session-complete">
        <h2>üéâ Session Complete!</h2>
        <div class="session-stats">
        <div class="session-stat"><div class="num">${sessionTotal}</div><div class="label">Studied</div></div>
        <div class="session-stat"><div class="num">${correctCount}</div><div class="label">Correct</div></div>
        <div class="session-stat"><div class="num">${accuracy}%</div><div class="label">Accuracy</div></div>
        </div>
        <p style="color: #86868b; margin-bottom: 1rem;">${remainingDue} cards still due</p>
        <button class="btn-primary" onclick="startSession()">New Session</button>
        <button onclick="returnToWelcome()" style="margin-left: .5rem;">Back to Home</button>
        </div>`;
}

function resetAll() {
    cards.forEach(c => { c.due = 0; c.n = 0; c.int = 1; });
    save();
    show();
}

// Close modals with Escape
document.onkeydown = e => {
    if (e.key === 'Escape') {
        closeEditModal();
        closeAddModal();
    }
};

answer.onkeydown = e => {
    if (e.key !== 'Enter' || !cur) return;
    
    if (waitingForNext) {
        waitingForNext = false;
        msg.textContent = '';
        document.getElementById('studyActions').style.display = 'none';
        // Reset input styling
        answer.readOnly = false;
        answer.style.background = '';
        
        // If last answer was wrong, show same card again
        if (lastAnswerWrong) {
            lastAnswerWrong = false;
            sentence.textContent = cur.s.replace(new RegExp(escapeRegex(cur.w), 'gi'), '___');
            answer.focus();
            answerStartTime = Date.now();
            return;
        }
        
        // Otherwise show next card
        show();
        return;
    }
    
    const userAnswer = answer.value.trim().toLowerCase();
    const correctAnswer = cur.w.toLowerCase();
    const isCorrect = userAnswer === correctAnswer;
    
    // If wrong answer, show correct answer and keep the same card
    if (!isCorrect) {
        lastAnswerWrong = true;
        // Add to session mistakes if not already there (and in session mode)
        if (inSession && !reviewingMistakes) {
            const alreadyMistake = sessionMistakes.some(c => c.w === cur.w && c.lang === cur.lang);
            if (!alreadyMistake) {
                sessionMistakes.push(cur);
            }
        }
        sentence.innerHTML = cur.s.replace(new RegExp(`(${escapeRegex(cur.w)})`, 'gi'), `<span class="no">$1</span>`);
        msg.innerHTML = '<span style="color: #86868b;">Press Enter to try again</span>';
        answer.value = '';
        answer.readOnly = true;
        answer.style.background = '#ffeceb';
        answer.classList.add('shake');
        setTimeout(() => answer.classList.remove('shake'), 500);
        waitingForNext = true;
        updateSessionUI();
        return;
    }
    
    // Correct answer - proceed with normal flow
    const responseTime = Date.now() - answerStartTime;
    const quality = calculateQuality(answer.value, cur.w, responseTime);
    const ok = sm2(cur, quality);

    cur.reviews = (cur.reviews || 0) + 1;
    cur.correct = (cur.correct || 0) + (ok ? 1 : 0);
    cur.lastReview = new Date().toISOString();
    cur.lastQuality = quality;
    save();

    sentence.innerHTML = cur.s.replace(new RegExp(`(${escapeRegex(cur.w)})`, 'gi'), `<span class="ok">$1</span>`);
    
    if (inSession) {
        if (reviewingMistakes) {
            sessionMistakes = sessionMistakes.filter(c => !(c.w === cur.w && c.lang === cur.lang));
        } else {
            sessionDueCards = sessionDueCards.filter(c => !(c.w === cur.w && c.lang === cur.lang));
            sessionCardsStudied++;
        }
        updateSessionUI();
    }
    
    lastAnswerWrong = false;
    waitingForNext = true;
    msg.innerHTML = '<span style="color: #86868b;">Press Enter to continue</span>';
    answer.value = '';
    answer.readOnly = true;
    answer.style.background = '#e8e8ed';
    document.getElementById('studyActions').style.display = '';
};

function renderList() {
    const sortBy = document.getElementById('sortSelect').value;
    let sorted = cards.map((c,i) => ({...c, idx: i})).filter(c => (c.lang || 'en') === currentLang);

    if (sortBy === 'word') sorted.sort((a,b) => a.w.localeCompare(b.w));
    else if (sortBy === 'due') sorted.sort((a,b) => (a.due||0) - (b.due||0));
    else if (sortBy === 'ef') sorted.sort((a,b) => (a.ef||2.5) - (b.ef||2.5));
    else if (sortBy === 'stage') sorted.sort((a,b) => (a.n||0) - (b.n||0));

    if (sorted.length === 0) {
        document.getElementById('wordsList').innerHTML = `
            <div class="words-empty">
                <div class="icon">üìù</div>
                <div>No cards yet</div>
                <div style="font-size: .8rem; margin-top: .25rem;">Click "Add Card" to create one</div>
            </div>`;
        return;
    }

    document.getElementById('wordsList').innerHTML = sorted.map(c => {
        const isDue = (c.due||0) <= Date.now();
        const isNew = (c.n || 0) === 0;
        const ef = (c.ef || 2.5).toFixed(1);
        const stage = (c.n || 0);
        const stageLabel = stage === 0 ? 'New' : stage < 4 ? `Learning ${stage}` : 'Mastered';
        const statusClass = isDue ? 'due' : isNew ? 'new' : 'ok';
        
        return `<div class="word-item">
            <div class="word-status ${statusClass}"></div>
            <div class="word-info">
                <div class="word-name">${c.w}</div>
                <div class="word-meta">${stageLabel} ¬∑ Next: ${formatInterval(c.int)} ¬∑ EF: ${ef}</div>
            </div>
            <div class="word-actions">
                <button onclick="editCard(${c.idx})" title="Edit">‚úé</button>
                <button class="danger" onclick="delCard(${c.idx})" title="Delete">üóë</button>
            </div>
        </div>`;
    }).join('');
}

// Add Card Modal Functions
function openAddModal() {
    editIdx = -1;
    document.getElementById('aWord').value = '';
    document.getElementById('aSent').value = '';
    document.getElementById('aDef').value = '';
    document.getElementById('addError').classList.remove('show');
    document.getElementById('addPreview').classList.remove('show');
    document.getElementById('addModal').classList.add('show');
    document.getElementById('aWord').focus();
}

function closeAddModal() {
    editIdx = -1;
    document.getElementById('addModal').classList.remove('show');
}

function validateAddForm() {
    const word = document.getElementById('aWord').value.trim();
    const sent = document.getElementById('aSent').value.trim();
    validateSentence(word, sent, 'addError', 'addPreview');
}

function saveCard() {
    const w = document.getElementById('aWord').value.trim();
    const s = document.getElementById('aSent').value.trim();
    const d = document.getElementById('aDef').value.trim();
    
    if (!w || !s || !d) {
        alert('Please fill in all fields');
        return;
    }
    if (!s.toLowerCase().includes(w.toLowerCase())) {
        alert('The sentence must include the word');
        return;
    }

    if (editIdx >= 0) {
        cards[editIdx].w = w;
        cards[editIdx].s = s;
        cards[editIdx].d = d;
        cards[editIdx].lang = currentLang;
    } else {
        cards.push({w, s, d, int: 1, due: 0, ef: 2.5, n: 0, lang: currentLang});
    }

    save();
    closeAddModal();
    if (!inSession) updateWelcomeStats();
    updateStats();
    renderList();
}

// Keep for backwards compatibility
toggleAdd = openAddModal;
cancelAdd = closeAddModal;
validateCard = validateAddForm;

function editCard(i) {
    editIdx = i;
    document.getElementById('aWord').value = cards[i].w;
    document.getElementById('aSent').value = cards[i].s;
    document.getElementById('aDef').value = cards[i].d;
    document.getElementById('addError').classList.remove('show');
    document.getElementById('addPreview').classList.remove('show');
    document.getElementById('addModal').classList.add('show');
    validateAddForm();
    document.getElementById('aWord').focus();
}

function delCard(i) {
    if (confirm(`Delete "${cards[i].w}"?`)) {
        cards.splice(i, 1);
        save();
        if (!inSession) updateWelcomeStats();
        updateStats();
        renderList();
    }
}

function editCurrentCard() {
    if (!cur) return;
    document.getElementById('editWord').value = cur.w;
    document.getElementById('editDef').value = cur.d;
    document.getElementById('editSent').value = cur.s;
    document.getElementById('editError').classList.remove('show');
    document.getElementById('editPreview').classList.remove('show');
    document.getElementById('editModal').classList.add('show');
    document.getElementById('editWord').focus();
}

function validateEdit() {
    const word = document.getElementById('editWord').value.trim();
    const sent = document.getElementById('editSent').value.trim();
    validateSentence(word, sent, 'editError', 'editPreview');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

function saveEdit() {
    if (!cur) return;
    
    const newWord = document.getElementById('editWord').value.trim();
    const newDef = document.getElementById('editDef').value.trim();
    const newSent = document.getElementById('editSent').value.trim();
    
    if (!newWord || !newDef || !newSent) {
        alert('All fields are required');
        return;
    }
    if (!newSent.toLowerCase().includes(newWord.toLowerCase())) {
        alert('The sentence must include the word');
        return;
    }
    
    const idx = findCardIndex(cur);
    if (idx === -1) return;
    
    cards[idx].w = newWord;
    cards[idx].d = newDef;
    cards[idx].s = newSent;
    save();
    
    cur = cards[idx];
    sentence.innerHTML = cur.s.replace(new RegExp(`(${cur.w})`, 'gi'), '<span class="ok">$1</span>');
    hint.textContent = `${cur.d} (${cur.w[0]})`;
    
    renderList();
    updateStats();
    if (!inSession) updateWelcomeStats();
    closeEditModal();
}

function deleteCurrentCard() {
    if (!cur) return;
    if (!confirm(`Delete "${cur.w}"?`)) return;
    
    const idx = findCardIndex(cur);
    if (idx === -1) return;
    
    cards.splice(idx, 1);
    save();
    
    if (inSession) removeCardFromSession(cur);
    
    waitingForNext = false;
    lastAnswerWrong = false;
    document.getElementById('studyActions').style.display = 'none';
    renderList();
    updateStats();
    if (!inSession) updateWelcomeStats();
    show();
}

function clearWords() {
    const langCards = currentLangCards();
    if (langCards.length === 0) {
        alert(`No cards to clear for ${languages.find(l => l.code === currentLang)?.name || currentLang}`);
        return;
    }
    
    const allCardsCount = cards.length;
    const currentLangCount = langCards.length;
    
    let message = `Clear cards for "${languages.find(l => l.code === currentLang)?.name || currentLang}" (${currentLangCount} cards)?\n\n`;
    message += 'Click OK to clear current language only.\n';
    if (allCardsCount > currentLangCount) {
        message += `Click Cancel, then type "ALL" to clear ALL ${allCardsCount} cards across all languages.`;
    }
    
    if (confirm(message)) {
        cards = cards.filter(c => (c.lang || 'en') !== currentLang);
        save();
        if (!inSession) updateWelcomeStats();
        updateStats();
        renderList();
    } else {
        const confirmAll = prompt(`Type "ALL" (uppercase) to delete ALL ${allCardsCount} cards across all languages:`);
        if (confirmAll === 'ALL') {
            cards = [];
            save();
            if (!inSession) updateWelcomeStats();
            updateStats();
            renderList();
        }
    }
}

function exp() {
    const langCards = currentLangCards();
    const exportData = {
        version: 1,
        exportedAt: new Date().toISOString(),
        language: languages.find(l => l.code === currentLang)?.name || currentLang,
        languageCode: currentLang,
        cardCount: langCards.length,
        cards: langCards
    };
    const a = document.createElement('a');
    a.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(exportData, null, 2));
    a.download = `flashcards-${currentLang}-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function handleImport(input) {
    if (!input.files[0]) return;
    input.files[0].text().then(t => {
        try {
            const data = JSON.parse(t);
            let newCards = [];
            
            if (data.cards && Array.isArray(data.cards)) {
                newCards = data.cards;
            } else if (Array.isArray(data)) {
                newCards = data;
            } else {
                alert('Invalid JSON format');
                return;
            }
            
            newCards = newCards.filter(c => c.w && c.s && c.d);
            cards = cards.filter(c => !newCards.find(nc => nc.w === c.w && nc.lang === c.lang));
            cards = cards.concat(newCards);
            save();
            
            if (!inSession) updateWelcomeStats();
            updateStats();
            renderList();
            
            alert(`Imported ${newCards.length} cards!`);
        } catch (e) {
            alert('Error reading JSON file: ' + e.message);
        }
        input.value = '';
    });
}

renderLangSelect();
updateWelcomeLangSelect();
updateWelcomeStats();
updateStats();
renderList();
</script>
</body>
</html>
