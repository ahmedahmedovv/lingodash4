<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Flashcards</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 1rem system-ui, -apple-system, sans-serif; background: #f5f5f7; color: #1d1d1f; min-height: 100vh; }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; display: grid; grid-template-columns: 1fr 360px; gap: 2rem; min-height: 100vh; transition: all .3s; }
        .container.focus-mode { grid-template-columns: 1fr; max-width: 700px; }
        .container.focus-mode .sidebar { display: none; }

        /* Top Bar */
        .top-bar { position: fixed; top: 1rem; right: 1rem; display: flex; gap: .5rem; align-items: center; font-size: .85rem; color: #86868b; z-index: 10; }
        .focus-btn { background: #fff; border: 1px solid #d2d2d7; font-size: 1rem; cursor: pointer; padding: .4rem .6rem; border-radius: 8px; transition: all .2s; }
        .focus-btn:hover { background: #f5f5f7; }

        /* Study Panel */
        .study-panel { background: #fff; border-radius: 16px; padding: 3rem 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        .sentence { font-size: 1.6rem; line-height: 1.7; text-align: center; margin-bottom: 1rem; color: #1d1d1f; }
        .hint { color: #86868b; font-size: 1rem; margin-bottom: 2rem; }
        .input-wrap { position: relative; }
        input[type="text"] { border: 2px solid #d2d2d7; background: #f5f5f7; border-radius: 12px; padding: 1rem 1.5rem; width: 280px; font-size: 1.1rem; text-align: center; outline: none; transition: all .2s; }
        input[type="text"]:focus { border-color: #0071e3; background: #fff; }
        .msg { margin-top: 1.5rem; font-size: 1.1rem; min-height: 1.5rem; font-weight: 500; }
        .ok { color: #34c759; font-weight: 600; }
        .no { color: #ff3b30; font-weight: 600; }
        .done-msg { color: #86868b; }
        .done-msg button { margin-top: 1rem; }

        /* Session Progress */
        .session-info { position: fixed; top: 1rem; left: 1rem; background: #fff; padding: .6rem 1rem; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,.08); font-size: .85rem; z-index: 10; }
        .session-info .progress-bar { width: 120px; height: 4px; background: #e8e8ed; border-radius: 2px; margin-top: .3rem; overflow: hidden; }
        .session-info .progress-fill { height: 100%; background: #0071e3; border-radius: 2px; transition: width .3s; }
        .session-info .mistake-badge { color: #ff3b30; font-weight: 600; }

        /* Review Mode Banner */
        .review-banner { background: #fff5f5; border: 1px solid #ffccc9; color: #ff3b30; padding: .75rem 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; font-weight: 500; display: flex; align-items: center; gap: .5rem; }
        .review-banner::before { content: "ðŸ”„"; }

        /* Session Complete */
        .session-complete { text-align: center; }
        .session-complete h2 { font-size: 2rem; margin-bottom: 1rem; color: #34c759; }
        .session-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1.5rem 0; max-width: 400px; }
        .session-stat { background: #f5f5f7; padding: 1rem; border-radius: 12px; }
        .session-stat .num { font-size: 1.8rem; font-weight: 600; color: #1d1d1f; }
        .session-stat .label { font-size: .75rem; color: #86868b; margin-top: .25rem; }

        /* Buttons */
        button { background: #f5f5f7; border: 1px solid #d2d2d7; color: #1d1d1f; padding: .6rem 1.2rem; border-radius: 8px; font: inherit; cursor: pointer; transition: all .2s; }
        button:hover { background: #e8e8ed; }
        .btn-primary { background: #0071e3; border-color: #0071e3; color: #fff; }
        .btn-primary:hover { background: #0077ed; }
        .btn-danger { color: #ff3b30; border-color: #ffccc9; background: #fff5f5; }
        .btn-danger:hover { background: #ffeceb; }
        .btn-success { background: #34c759; border-color: #34c759; color: #fff; }
        .btn-success:hover { background: #30b350; }

        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 1rem; }

        /* Stats Card */
        .stats-card { background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        .stats-card h2 { display: none; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .stat-item { text-align: center; padding: .75rem; background: #f5f5f7; border-radius: 10px; }
        .stat-num { font-size: 1.5rem; font-weight: 600; color: #1d1d1f; }
        .stat-label { font-size: .75rem; color: #86868b; margin-top: .25rem; }
        .stat-item.due .stat-num { color: #ff9500; }
        .stat-item.mastered .stat-num { color: #34c759; }

        /* Session Settings Card */
        .session-card { background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        .session-card h3 { font-size: .85rem; color: #86868b; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 1rem; }
        .session-options { display: flex; gap: .5rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .session-option { padding: .4rem .8rem; border: 1px solid #d2d2d7; border-radius: 8px; cursor: pointer; font-size: .85rem; transition: all .2s; }
        .session-option:hover { background: #f5f5f7; }
        .session-option.active { background: #0071e3; border-color: #0071e3; color: #fff; }
        .session-custom { display: flex; gap: .5rem; }
        .session-custom input { width: 60px; padding: .4rem; border: 1px solid #d2d2d7; border-radius: 6px; text-align: center; font: inherit; }

        /* Actions Card */
        .actions-card { background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        .actions-card h2 { display: none; }
        .action-btns { display: flex; flex-direction: column; gap: .5rem; }
        .action-btns button { width: 100%; justify-content: flex-start; display: flex; align-items: center; gap: .5rem; }

        /* Words Card */
        .words-card { background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); flex: 1; display: flex; flex-direction: column; max-height: 400px; }
        .words-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .words-header h2 { display: none; }
        .sort-select { font-size: .8rem; padding: .3rem .5rem; border-radius: 6px; border: 1px solid #d2d2d7; background: #f5f5f7; }

        /* Language Selector */
        .lang-card { background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        .lang-card h2 { display: none; }
        .lang-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem; }
        .lang-current { font-weight: 600; color: #1d1d1f; }
        .lang-count { font-size: .75rem; color: #86868b; }
        .lang-select { width: 100%; padding: .5rem; border-radius: 8px; border: 1px solid #d2d2d7; background: #f5f5f7; font: inherit; font-size: .9rem; margin-bottom: .5rem; }
        .lang-btns { display: flex; gap: .5rem; }
        .lang-btns button { flex: 1; font-size: .8rem; padding: .4rem; }
        .words-list { flex: 1; overflow-y: auto; }
        .word-item { display: flex; align-items: center; padding: .6rem 0; border-bottom: 1px solid #f0f0f2; gap: .75rem; }
        .word-item:last-child { border-bottom: none; }
        .word-status { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .word-status.due { background: #ff9500; }
        .word-status.ok { background: #34c759; }
        .word-name { flex: 1; font-weight: 500; }
        .word-stats { font-size: .75rem; color: #86868b; }
        .word-actions { display: flex; gap: .3rem; }
        .word-actions button { padding: .3rem .5rem; font-size: .7rem; }

        /* Add Form */
        .add-form { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f0f0f2; }
        .add-form.show { display: block; }
        .add-form input, .add-form textarea { width: 100%; padding: .6rem; margin-bottom: .5rem; border: 1px solid #d2d2d7; border-radius: 8px; font: inherit; font-size: .9rem; }
        .add-form textarea { height: 60px; resize: none; }
        .add-form .error { color: #ff3b30; font-size: .75rem; margin: -.3rem 0 .5rem; display: none; }
        .add-form .error.show { display: block; }
        .add-form .preview { font-size: .8rem; color: #86868b; margin-bottom: .5rem; padding: .5rem; background: #f5f5f7; border-radius: 6px; display: none; }
        .add-form .preview.show { display: block; }
        .add-form .preview strong { color: #1d1d1f; }
        .add-form-btns { display: flex; gap: .5rem; justify-content: flex-end; }
        .add-form-btns button { font-size: .85rem; }

        /* Mobile */
        @media (max-width: 800px) {
            .container { grid-template-columns: 1fr; padding: 1rem; }
            .study-panel { min-height: 300px; padding: 2rem 1rem; }
            .sentence { font-size: 1.3rem; }
            .sidebar { order: 1; }
            .session-info { position: static; margin-bottom: 1rem; }
        }

        input[type="file"] { display: none; }
    </style>
</head>
<body>
<div class="session-info" id="sessionInfo" style="display: none;">
    <div>Session: <span id="sessionProgress">0/20</span> <span id="mistakeBadge" class="mistake-badge" style="display: none;"></span></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
</div>

<div class="top-bar">
    <span><strong id="dueCount">0</strong> due</span>
    <button class="focus-btn" onclick="toggleFocus()" title="Toggle sidebar" id="focusBtn">â˜°</button>
</div>

<div class="container">
    <main class="study-panel" id="studyPanel">
        <div class="review-banner" id="reviewBanner" style="display: none;">Mistake Review Mode</div>
        <p class="sentence" id="sentence"></p>
        <p class="hint" id="hint"></p>
        <div class="input-wrap">
            <input type="text" id="answer" placeholder="Type your answer..." autocomplete="off">
        </div>
        <p class="msg" id="msg"></p>
    </main>

    <aside class="sidebar">
        <div class="lang-card">
            <h2>Language</h2>
            <div class="lang-header">
                <span class="lang-current" id="langCurrent">English</span>
                <span class="lang-count" id="langCount">0 cards</span>
            </div>
            <select class="lang-select" id="langSelect" onchange="switchLang()">
                <option value="ts">English</option>
            </select>
            <div class="lang-btns">
                <button onclick="toggleLangForm()">+ New</button>
                <button onclick="renameLang()">Rename</button>
            </div>
            <div class="add-form" id="langForm">
                <input id="newLangName" placeholder="Language name (e.g., Spanish)">
                <input id="newLangCode" placeholder="Code (e.g., es)">
                <div class="add-form-btns">
                    <button onclick="cancelLangForm()">Cancel</button>
                    <button class="btn-primary" onclick="addLang()">Add</button>
                </div>
            </div>
        </div>

        <div class="session-card">
            <h3>Session Settings</h3>
            <div class="session-options">
                <span class="session-option" data-size="10" onclick="setSessionSize(10)">10</span>
                <span class="session-option active" data-size="20" onclick="setSessionSize(20)">20</span>
                <span class="session-option" data-size="50" onclick="setSessionSize(50)">50</span>
                <span class="session-option" data-size="100" onclick="setSessionSize(100)">100</span>
            </div>
            <div class="session-custom">
                <input type="number" id="customSize" placeholder="Custom" min="5" max="500" onchange="setCustomSessionSize()">
                <button class="btn-primary" onclick="startSession()" id="startBtn">Start Session</button>
            </div>
        </div>

        <div class="stats-card">
            <h2>Statistics</h2>
            <div class="stats-grid">
                <div class="stat-item due"><div class="stat-num" id="statDue">0</div><div class="stat-label">Due Now</div></div>
                <div class="stat-item"><div class="stat-num" id="statLearning">0</div><div class="stat-label">Learning</div></div>
                <div class="stat-item mastered"><div class="stat-num" id="statMastered">0</div><div class="stat-label">Mastered</div></div>
                <div class="stat-item"><div class="stat-num" id="statAccuracy">0%</div><div class="stat-label">Accuracy</div></div>
            </div>
        </div>

        <div class="actions-card">
            <h2>Actions</h2>
            <div class="action-btns">
                <button onclick="toggleAdd()">+ Add Card</button>
                <button onclick="exp()">Export</button>
                <button onclick="imp.click()">Import</button>
                <button class="btn-danger" onclick="clearWords()">Clear All</button>
            </div>
            <input type="file" id="imp" accept=".csv">
        </div>

        <div class="words-card">
            <div class="words-header">
                <h2>Words</h2>
                <select class="sort-select" id="sortSelect" onchange="renderList()">
                    <option value="due">Due First</option>
                    <option value="word">A-Z</option>
                    <option value="ef">Hardest (EF)</option>
                    <option value="stage">Learning Stage</option>
                </select>
            </div>
            <div class="words-list" id="wordsList"></div>
            <div class="add-form" id="addForm">
                <input id="aWord" placeholder="Word" oninput="validateCard()">
                <textarea id="aSent" placeholder="Sentence (include the word)" oninput="validateCard()"></textarea>
                <p class="error" id="addError">Include the word in your sentence</p>
                <div class="preview" id="addPreview"></div>
                <input id="aDef" placeholder="Definition">
                <div class="add-form-btns">
                    <button onclick="cancelAdd()">Cancel</button>
                    <button class="btn-primary" onclick="saveCard()">Save</button>
                </div>
            </div>
        </div>
    </aside>
</div>

<script>
let cards = JSON.parse(localStorage.cards || '0') || [
    {w:'apple', s:'She took a bite of the crisp red apple.', d:'a round fruit', lang:'en'},
    {w:'banana', s:'The monkey peeled the banana before eating.', d:'a long curved yellow fruit', lang:'en'},
    {w:'door', s:'Please close the door behind you.', d:'a barrier for an entrance', lang:'en'}
], cur, editIdx = -1, answerStartTime = 0;

let languages = JSON.parse(localStorage.languages || '0') || [
    {code: 'en', name: 'English'}
];
let currentLang = localStorage.currentLang || 'en';

// Session State
let sessionSize = 20;
let sessionCardsStudied = 0;
let sessionMistakes = [];
let reviewingMistakes = false;
let inSession = false;
let sessionDueCards = [];
let interleaveInterval = 10; // Review mistakes every N cards

const save = () => localStorage.cards = JSON.stringify(cards);
const saveLangs = () => localStorage.languages = JSON.stringify(languages);
const saveCurrentLang = () => localStorage.currentLang = currentLang;
const dueCards = () => cards.filter(c => (c.due||0) <= Date.now() && (c.lang || 'en') === currentLang);
const currentLangCards = () => cards.filter(c => (c.lang || 'en') === currentLang);

// SM-2 Algorithm Implementation
function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array.from({length: m + 1}, (_, i) => [i]);
    for (let j = 1; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            dp[i][j] = a[i-1] === b[j-1]
                ? dp[i-1][j-1]
                : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
        }
    }
    return dp[m][n];
}

function calculateQuality(userAnswer, correctAnswer, responseTimeMs) {
    const ua = userAnswer.trim().toLowerCase();
    const ca = correctAnswer.toLowerCase();
    const isCorrect = ua === ca;
    const distance = levenshtein(ua, ca);
    const similarity = 1 - distance / Math.max(ca.length, 1);
    const seconds = responseTimeMs / 1000;

    if (isCorrect) {
        if (seconds < 3) return 5;
        if (seconds < 8) return 4;
        return 3;
    } else {
        if (similarity >= 0.8) return 2;
        if (similarity >= 0.5) return 1;
        return 0;
    }
}

function sm2(card, quality) {
    if (card.ef === undefined) card.ef = 2.5;
    if (card.n === undefined) card.n = 0;

    const qDiff = 5 - quality;
    card.ef = Math.max(1.3, card.ef + (0.1 - qDiff * (0.08 + qDiff * 0.02)));

    let intervalMins;

    if (quality < 3) {
        card.n = 0;
        intervalMins = 1;
    } else {
        if (card.n === 0) intervalMins = 1;
        else if (card.n === 1) intervalMins = 10;
        else if (card.n === 2) intervalMins = 1440;
        else if (card.n === 3) intervalMins = 6 * 1440;
        else intervalMins = Math.round((card.int || 1440) * card.ef);
        card.n++;
    }

    card.int = Math.min(intervalMins, 525600);
    card.due = Date.now() + card.int * 60000;

    return quality >= 3;
}

function toggleFocus() {
    document.querySelector('.container').classList.toggle('focus-mode');
    let isFocus = document.querySelector('.container').classList.contains('focus-mode');
    document.getElementById('focusBtn').textContent = isFocus ? 'â—§' : 'â˜°';
    localStorage.focusMode = isFocus;
}

if (localStorage.focusMode === 'true') {
    document.querySelector('.container').classList.add('focus-mode');
    document.getElementById('focusBtn').textContent = 'â—§';
}

// Session Settings
function setSessionSize(size) {
    sessionSize = size;
    document.querySelectorAll('.session-option').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.size) === size);
    });
    document.getElementById('customSize').value = '';
}

function setCustomSessionSize() {
    const val = parseInt(document.getElementById('customSize').value);
    if (val >= 5 && val <= 500) {
        sessionSize = val;
        document.querySelectorAll('.session-option').forEach(el => el.classList.remove('active'));
    }
}

function startSession() {
    const due = dueCards();
    if (due.length === 0) {
        alert('No cards due for review!');
        return;
    }
    
    inSession = true;
    sessionCardsStudied = 0;
    sessionMistakes = [];
    reviewingMistakes = false;
    
    // Get up to sessionSize due cards, shuffled
    sessionDueCards = shuffleArray(due.slice(0, sessionSize));
    
    updateSessionUI();
    document.getElementById('sessionInfo').style.display = 'block';
    document.getElementById('startBtn').textContent = 'Restart';
    
    show();
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function updateSessionUI() {
    const totalInSession = Math.min(sessionSize, sessionDueCards.length + sessionCardsStudied);
    const progress = Math.min(sessionCardsStudied, totalInSession);
    const percent = totalInSession > 0 ? (progress / totalInSession * 100) : 0;
    
    document.getElementById('sessionProgress').textContent = progress + '/' + totalInSession;
    document.getElementById('progressFill').style.width = percent + '%';
    
    const badge = document.getElementById('mistakeBadge');
    if (sessionMistakes.length > 0 && !reviewingMistakes) {
        badge.textContent = '(' + sessionMistakes.length + ' mistakes)';
        badge.style.display = '';
    } else {
        badge.style.display = 'none';
    }
}

function checkInterleaveReview() {
    // Check if we should enter mistake review mode
    if (!reviewingMistakes && sessionMistakes.length > 0 && sessionCardsStudied > 0 && sessionCardsStudied % interleaveInterval === 0) {
        reviewingMistakes = true;
        return true;
    }
    return false;
}

function renderLangSelect() {
    let select = document.getElementById('langSelect');
    select.innerHTML = languages.map(l => 
        '<option value="' + l.code + '"' + (l.code === currentLang ? ' selected' : '') + '>' + l.name + '</option>'
    ).join('');
    
    let lang = languages.find(l => l.code === currentLang);
    document.getElementById('langCurrent').textContent = lang ? lang.name : currentLang;
    document.getElementById('langCount').textContent = currentLangCards().length + ' cards';
}

function switchLang() {
    currentLang = document.getElementById('langSelect').value;
    saveCurrentLang();
    renderLangSelect();
    // End current session when switching languages
    endSession();
    show();
}

function toggleLangForm() {
    document.getElementById('langForm').classList.toggle('show');
    document.getElementById('newLangName').focus();
}

function cancelLangForm() {
    document.getElementById('langForm').classList.remove('show');
    document.getElementById('newLangName').value = '';
    document.getElementById('newLangCode').value = '';
}

function addLang() {
    let name = document.getElementById('newLangName').value.trim();
    let code = document.getElementById('newLangCode').value.trim().toLowerCase();
    
    if (!name || !code) return;
    if (languages.find(l => l.code === code)) {
        alert('Language code already exists');
        return;
    }
    
    languages.push({name, code});
    saveLangs();
    currentLang = code;
    saveCurrentLang();
    renderLangSelect();
    cancelLangForm();
    show();
}

function renameLang() {
    let lang = languages.find(l => l.code === currentLang);
    if (!lang) return;
    
    let newName = prompt('Rename "' + lang.name + '":', lang.name);
    if (newName && newName.trim()) {
        lang.name = newName.trim();
        saveLangs();
        renderLangSelect();
    }
}

function formatInterval(mins) {
    if (!mins || mins <= 1) return 'new';
    if (mins < 60) return Math.round(mins) + 'm';
    if (mins < 1440) return Math.round(mins/60) + 'h';
    return Math.round(mins/1440) + 'd';
}

function updateStats() {
    let langCards = currentLangCards();
    let due = dueCards().length;
    let mastered = langCards.filter(c => (c.n||0) >= 4).length;
    let learning = langCards.length - mastered;
    let totalReviews = langCards.reduce((a,c) => a + (c.reviews||0), 0);
    let totalCorrect = langCards.reduce((a,c) => a + (c.correct||0), 0);
    let accuracy = totalReviews ? Math.round(totalCorrect/totalReviews*100) : 0;

    document.getElementById('dueCount').textContent = due;
    document.getElementById('statDue').textContent = due;
    document.getElementById('statLearning').textContent = learning;
    document.getElementById('statMastered').textContent = mastered;
    document.getElementById('statAccuracy').textContent = accuracy + '%';
    document.getElementById('langCount').textContent = langCards.length + ' cards';
}

function show() {
    updateStats();
    renderList();
    
    // Check if in mistake review mode
    if (reviewingMistakes && sessionMistakes.length > 0) {
        showMistakeReview();
        return;
    }
    
    // Check if we should enter mistake review mode
    if (inSession && checkInterleaveReview()) {
        showMistakeReview();
        return;
    }
    
    let dc = inSession ? sessionDueCards : dueCards();

    if (!dc.length) {
        if (inSession) {
            // Check if we have remaining mistakes to review
            if (sessionMistakes.length > 0) {
                reviewingMistakes = true;
                showMistakeReview();
                return;
            }
            showSessionComplete();
        } else {
            showNoCards();
        }
        return;
    }

    document.getElementById('reviewBanner').style.display = 'none';
    sentence.classList.remove('done-msg');
    answer.style.display = '';
    msg.textContent = '';
    
    if (inSession) {
        cur = dc[0]; // Take first from shuffled session cards
    } else {
        cur = dc[Math.random()*dc.length|0];
    }
    
    sentence.textContent = cur.s.replace(new RegExp(cur.w, 'gi'), '___');
    hint.textContent = cur.d + ' (' + cur.w[0] + ')';
    answer.value = '';
    answer.focus();
    answerStartTime = Date.now();
}

function showMistakeReview() {
    if (sessionMistakes.length === 0) {
        reviewingMistakes = false;
        show();
        return;
    }
    
    document.getElementById('reviewBanner').style.display = '';
    sentence.classList.remove('done-msg');
    answer.style.display = '';
    msg.textContent = '';
    
    cur = sessionMistakes[0]; // Take first mistake
    sentence.textContent = cur.s.replace(new RegExp(cur.w, 'gi'), '___');
    hint.textContent = cur.d + ' (' + cur.w[0] + ')';
    answer.value = '';
    answer.focus();
    answerStartTime = Date.now();
}

function showNoCards() {
    sentence.textContent = 'All done';
    sentence.classList.add('done-msg');
    hint.textContent = '';
    answer.style.display = 'none';
    msg.innerHTML = '<button class="btn-primary" onclick="resetAll()">Study Again</button>';
}

function showSessionComplete() {
    sentence.classList.add('done-msg');
    hint.textContent = '';
    answer.style.display = 'none';
    
    const sessionTotal = sessionCardsStudied;
    const mistakeCount = sessionMistakes.length;
    const correctCount = sessionTotal - mistakeCount;
    const accuracy = sessionTotal > 0 ? Math.round(correctCount / sessionTotal * 100) : 0;
    const remainingDue = dueCards().length;
    
    msg.innerHTML = 
        '<div class="session-complete">' +
        '<h2>ðŸŽ‰ Session Complete!</h2>' +
        '<div class="session-stats">' +
        '<div class="session-stat"><div class="num">' + sessionTotal + '</div><div class="label">Studied</div></div>' +
        '<div class="session-stat"><div class="num">' + correctCount + '</div><div class="label">Correct</div></div>' +
        '<div class="session-stat"><div class="num">' + accuracy + '%</div><div class="label">Accuracy</div></div>' +
        '</div>' +
        '<p style="color: #86868b; margin-bottom: 1rem;">' + remainingDue + ' cards still due</p>' +
        '<button class="btn-primary" onclick="startSession()">New Session</button>' +
        '<button onclick="endSession()" style="margin-left: .5rem;">Back to Browse</button>' +
        '</div>';
}

function endSession() {
    inSession = false;
    sessionCardsStudied = 0;
    sessionMistakes = [];
    reviewingMistakes = false;
    sessionDueCards = [];
    document.getElementById('sessionInfo').style.display = 'none';
    document.getElementById('startBtn').textContent = 'Start Session';
    show();
}

function resetAll() {
    cards.forEach(c => {
        c.due = 0;
        c.n = 0;
        c.int = 1;
    });
    save();
    show();
}

answer.onkeydown = e => {
    if (e.key !== 'Enter' || !cur) return;
    const responseTime = Date.now() - answerStartTime;
    const quality = calculateQuality(answer.value, cur.w, responseTime);
    const ok = sm2(cur, quality);

    cur.reviews = (cur.reviews || 0) + 1;
    cur.correct = (cur.correct || 0) + (ok ? 1 : 0);
    cur.lastReview = new Date().toISOString();
    cur.lastQuality = quality;
    save();

    // Show sentence with answer highlighted
    const colorClass = ok ? 'ok' : 'no';
    sentence.innerHTML = cur.s.replace(
        new RegExp('(' + cur.w + ')', 'gi'),
        '<span class="' + colorClass + '">$1</span>'
    );
    msg.textContent = '';
    
    // Handle session tracking
    if (inSession) {
        if (reviewingMistakes) {
            // In mistake review mode
            if (ok) {
                // Remove from mistakes if answered correctly
                sessionMistakes = sessionMistakes.filter(c => !(c.w === cur.w && c.lang === cur.lang));
            }
            // If still wrong, keep in mistake queue for next review
        } else {
            // Normal session card
            if (!ok) {
                // Add to mistake queue
                if (!sessionMistakes.find(c => c.w === cur.w && c.lang === cur.lang)) {
                    sessionMistakes.push(cur);
                }
            }
            // Remove from session queue
            sessionDueCards = sessionDueCards.filter(c => !(c.w === cur.w && c.lang === cur.lang));
            sessionCardsStudied++;
        }
        updateSessionUI();
    }
    
    setTimeout(show, ok ? 600 : 1200);
};

function renderList() {
    let sortBy = document.getElementById('sortSelect').value;
    let sorted = cards.map((c,i) => ({...c, idx: i})).filter(c => (c.lang || 'en') === currentLang);

    if (sortBy === 'word') sorted.sort((a,b) => a.w.localeCompare(b.w));
    else if (sortBy === 'due') sorted.sort((a,b) => (a.due||0) - (b.due||0));
    else if (sortBy === 'ef') sorted.sort((a,b) => (a.ef||2.5) - (b.ef||2.5));
    else if (sortBy === 'stage') sorted.sort((a,b) => (a.n||0) - (b.n||0));

    document.getElementById('wordsList').innerHTML = sorted.map(c => {
        let isDue = (c.due||0) <= Date.now();
        let ef = (c.ef || 2.5).toFixed(1);
        let stage = (c.n || 0);
        let stageLabel = stage === 0 ? 'new' : stage < 4 ? 'L' + stage : 'M';
        return '<div class="word-item">' +
            '<div class="word-status ' + (isDue ? 'due' : 'ok') + '"></div>' +
            '<span class="word-name">' + c.w + '</span>' +
            '<span class="word-stats">' + formatInterval(c.int) + ' Â· EF:' + ef + ' Â· ' + stageLabel + '</span>' +
            '<div class="word-actions">' +
            '<button onclick="editCard(' + c.idx + ')">Edit</button>' +
            '<button class="btn-danger" onclick="delCard(' + c.idx + ')">Del</button>' +
            '</div></div>';
    }).join('');
}

function toggleAdd() {
    editIdx = -1;
    aWord.value = aSent.value = aDef.value = '';
    document.getElementById('addError').classList.remove('show');
    document.getElementById('addPreview').classList.remove('show');
    document.getElementById('addForm').classList.toggle('show');
}

function cancelAdd() {
    editIdx = -1;
    document.getElementById('addForm').classList.remove('show');
}

function validateCard() {
    let w = aWord.value.trim();
    let s = aSent.value.trim();
    let error = document.getElementById('addError');
    let preview = document.getElementById('addPreview');

    if (w && s) {
        if (s.toLowerCase().includes(w.toLowerCase())) {
            error.classList.remove('show');
            preview.classList.add('show');
            preview.innerHTML = s.replace(new RegExp('(' + w + ')', 'gi'), '<strong>___</strong>');
        } else {
            error.classList.add('show');
            preview.classList.remove('show');
        }
    } else {
        error.classList.remove('show');
        preview.classList.remove('show');
    }
}

function saveCard() {
    let w = aWord.value.trim();
    let s = aSent.value.trim();
    let d = aDef.value.trim();
    if (!w || !s || !d) return;
    if (!s.toLowerCase().includes(w.toLowerCase())) return;

    if (editIdx >= 0) {
        cards[editIdx].w = w;
        cards[editIdx].s = s;
        cards[editIdx].d = d;
        cards[editIdx].lang = currentLang;
    } else {
        cards.push({w, s, d, int: 1, due: 0, ef: 2.5, n: 0, lang: currentLang});
    }

    save();
    cancelAdd();
    show();
}

function editCard(i) {
    editIdx = i;
    aWord.value = cards[i].w;
    aSent.value = cards[i].s;
    aDef.value = cards[i].d;
    document.getElementById('addForm').classList.add('show');
    validateCard();
}

function delCard(i) {
    if (confirm('Delete "' + cards[i].w + '"?')) {
        cards.splice(i, 1);
        save();
        show();
    }
}

function clearWords() {
    let langCards = currentLangCards();
    if (langCards.length === 0) {
        alert('No cards to clear for ' + languages.find(l => l.code === currentLang)?.name || currentLang);
        return;
    }
    
    let allCardsCount = cards.length;
    let currentLangCount = langCards.length;
    
    let message = 'Clear cards for "' + (languages.find(l => l.code === currentLang)?.name || currentLang) + '" (' + currentLangCount + ' cards)?\n\n';
    message += 'Click OK to clear current language only.\n';
    if (allCardsCount > currentLangCount) {
        message += 'Click Cancel, then type "ALL" to clear ALL ' + allCardsCount + ' cards across all languages.';
    }
    
    if (confirm(message)) {
        cards = cards.filter(c => (c.lang || 'en') !== currentLang);
        save();
        show();
    } else {
        let confirmAll = prompt('Type "ALL" (uppercase) to delete ALL ' + allCardsCount + ' cards across all languages:');
        if (confirmAll === 'ALL') {
            cards = [];
            save();
            show();
        }
    }
}

function escapeCSV(str) {
    return '"' + str.replace(/"/g, '""') + '"';
}

function exp() {
    let langCards = currentLangCards();
    let csv = 'Word,Definition,Example,Language\n';
    csv += langCards.map(c => escapeCSV(c.w) + ',' + escapeCSV(c.d) + ',' + escapeCSV(c.s) + ',' + escapeCSV(c.lang || 'en')).join('\n');
    let a = document.createElement('a');
    a.href = 'data:text/csv,' + encodeURIComponent(csv);
    a.download = 'cards-' + currentLang + '.csv';
    a.click();
}

function parseCSV(text) {
    let lines = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        let char = text[i];
        if (char === '"') {
            if (inQuotes && text[i+1] === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === '\n' && !inQuotes) {
            lines.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    if (current) lines.push(current);

    return lines.map(line => {
        let fields = [];
        let field = '';
        let inQ = false;
        for (let i = 0; i < line.length; i++) {
            let c = line[i];
            if (c === '"') {
                if (inQ && line[i+1] === '"') {
                    field += '"';
                    i++;
                } else {
                    inQ = !inQ;
                }
            } else if (c === ',' && !inQ) {
                fields.push(field);
                field = '';
            } else {
                field += c;
            }
        }
        fields.push(field);
        return fields;
    });
}

imp.onchange = e => {
    if (!e.target.files[0]) return;
    e.target.files[0].text().then(t => {
        let rows = parseCSV(t);
        if (rows[0]?.[0]?.toLowerCase() === 'word') rows.shift();
        let newCards = rows.filter(r => r.length >= 3 && r[0]).map(r => ({
            w: r[0], d: r[1], s: r[2], int: 1, due: 0, ef: 2.5, n: 0,
            lang: r[3] || currentLang
        }));
        cards = cards.filter(c => !newCards.find(nc => nc.w === c.w && nc.lang === c.lang));
        cards = cards.concat(newCards);
        save();
        show();
    });
};

renderLangSelect();
show();
</script>
</body>
</html>
