<!DOCTYPE html>
<!--
  FLASHCARDS APP - A Spaced Repetition Learning Tool
  ================================================
  This app helps you learn vocabulary using the SM-2 algorithm, similar to Anki.
  
  HOW IT WORKS:
  1. Cards have a word, definition, and example sentence
  2. You see the sentence with the word hidden (___)
  3. Type the missing word - the app grades your response
  4. Based on accuracy and speed, the card is scheduled for review
  
  KEY CONCEPTS:
  - Due cards: Cards ready for review (based on spacing algorithm)
  - Learning stages: New ‚Üí Learning ‚Üí Mastered
  - Mistake review: Wrong answers reappear during the session
  - Focus mode: Hide sidebar to concentrate on studying
-->
<html>
<head>
    <meta charset="UTF-8">
    <!-- Fixed width for consistent study experience -->
    <meta name="viewport" content="width=1280">
    <title>Flashcards</title>
    <style>
        /* ===== GLOBAL STYLES ===== */
        /* Reset default margins and use border-box for predictable sizing */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Main page styling: light gray background with system fonts */
        body { 
            font: 1rem system-ui, -apple-system, sans-serif; 
            background: #f5f5f7; /* Apple-style light gray */ 
            color: #1d1d1f; /* Near-black for readability */ 
            min-height: 100vh; 
        }

        /* ===== MAIN LAYOUT ===== */
        /* Container uses CSS grid: main study area + sidebar */
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 2rem 3rem; 
            display: grid; 
            grid-template-columns: 1fr 420px; /* Main content | Sidebar */ 
            gap: 3rem; 
            min-height: calc(100vh - 3rem); 
            transition: all .3s; 
            align-items: start; 
        }
        
        /* Focus mode: hide sidebar, center the study panel */
        .container.focus-mode { grid-template-columns: 1fr; max-width: 900px; }
        .container.focus-mode .sidebar { display: none; }

        /* ===== TOP BAR ===== */
        /* Fixed position buttons in top-right corner */
        .top-bar { 
            position: fixed; 
            top: 1.5rem; 
            right: 1.5rem; 
            display: flex; 
            gap: .75rem; 
            align-items: center; 
            font-size: 1rem; 
            color: #86868b; /* Medium gray */ 
            z-index: 10; 
        }
        
        /* Hamburger button to toggle focus mode */
        .focus-btn { 
            background: #fff; 
            border: 1px solid #d2d2d7; 
            font-size: 1.1rem; 
            cursor: pointer; 
            padding: .5rem .75rem; 
            border-radius: 8px; 
            transition: all .2s; 
        }
        .focus-btn:hover { background: #f5f5f7; }

        /* ===== STUDY PANEL (Main Learning Area) ===== */
        /* White card where you actually study flashcards */
        .study-panel { 
            background: #fff; 
            border-radius: 20px; 
            padding: 4rem; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 550px; 
            box-shadow: 0 2px 8px rgba(0,0,0,.08); 
            position: sticky; 
            top: 1.5rem; /* Stick to top when scrolling */
            align-self: flex-start; 
            z-index: 5; 
        }
        
        /* Example sentence with hidden word shown as ___ */
        .sentence { 
            font-size: 2.2rem; 
            line-height: 1.5; 
            text-align: center; 
            margin-bottom: 2rem; 
            color: #1d1d1f; 
            max-width: 900px; 
        }
        
        /* Definition hint shown below the sentence */
        .hint { 
            color: #86868b; /* Gray hint text */ 
            font-size: 1.3rem; 
            margin-bottom: 3rem; 
            text-align: center; 
            font-style: italic; 
            max-width: 800px; 
        }
        
        /* Container for the answer input field */
        .input-wrap { position: relative; }
        
        /* Main text input where you type the answer */
        input[type="text"] { 
            border: 2px solid #d2d2d7; 
            background: #f5f5f7; 
            border-radius: 14px; 
            padding: 1.3rem 2rem; 
            width: 400px; 
            font-size: 1.4rem; 
            text-align: center; 
            outline: none; 
            transition: all .2s; 
        }
        input[type="text"]:focus { 
            border-color: #0071e3; /* Apple blue on focus */ 
            background: #fff; 
        }
        
        /* Feedback message (correct/incorrect/prompts) */
        .msg { 
            margin-top: 2rem; 
            font-size: 1.2rem; 
            min-height: 1.5rem; 
            font-weight: 500; 
        }
        
        /* ===== STUDY ACTIONS (Edit/Delete buttons) ===== */
        /* Hidden by default, appear on hover */
        .study-actions { 
            display: flex; 
            gap: .5rem; 
            position: absolute; 
            bottom: 1.5rem; 
            right: 1.5rem;
            opacity: 0.25; /* Semi-transparent normally */
            transition: opacity .3s;
        }
        .study-panel:hover .study-actions { opacity: 0.6; }
        .study-actions:hover { opacity: 1 !important; }
        
        /* Small action buttons in the study panel */
        .study-actions button { 
            width: 36px; 
            height: 36px; 
            padding: 0; 
            font-size: 1rem; 
            background: #f5f5f7; 
            border: 1px solid #e8e8ed; 
            border-radius: 8px; 
            cursor: pointer; 
            opacity: 0.7;
            transition: all .2s; 
        }
        .study-actions button:hover { 
            opacity: 1; 
            background: #e8e8ed; 
            transform: scale(1.05); 
        }
        /* Delete button turns red on hover */
        .study-actions .btn-delete:hover { 
            background: #ffeceb; 
            border-color: #ffccc9; 
        }
        
        /* ===== MODAL DIALOGS (Add/Edit Card) ===== */
        /* Dark overlay behind modal */
        .modal-overlay { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,.5); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
        }
        .modal-overlay.show { display: flex; }
        
        /* White modal box */
        .modal { 
            background: #fff; 
            border-radius: 16px; 
            padding: 2rem; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 10px 40px rgba(0,0,0,.2); 
        }
        .modal h3 { margin-bottom: 1.5rem; font-size: 1.3rem; }
        .modal .form-group { margin-bottom: 1rem; }
        .modal label { 
            display: block; 
            font-size: .85rem; 
            color: #86868b; 
            margin-bottom: .3rem; 
        }
        .modal input, .modal textarea { 
            width: 100%; 
            padding: .75rem; 
            border: 1px solid #d2d2d7; 
            border-radius: 8px; 
            font: inherit; 
            font-size: 1rem; 
        }
        .modal input:focus, .modal textarea:focus { 
            outline: none; 
            border-color: #0071e3; 
        }
        .modal textarea { height: 80px; resize: none; }
        
        /* Error message shown when sentence doesn't contain the word */
        .modal .error { 
            color: #ff3b30; /* Apple red */ 
            font-size: .85rem; 
            margin-top: .25rem; 
            display: none; 
        }
        .modal .error.show { display: block; }
        
        /* Preview showing how the sentence will look */
        .modal .preview { 
            font-size: .9rem; 
            color: #86868b; 
            margin-top: .5rem; 
            padding: .5rem; 
            background: #f5f5f7; 
            border-radius: 6px; 
            display: none; 
        }
        .modal .preview.show { display: block; }
        /* The hidden word shown as a blue box in preview */
        .modal .preview strong { 
            background: #0071e3; 
            color: #fff; 
            padding: .1rem .4rem; 
            border-radius: 4px; 
        }
        
        .modal-btns { 
            display: flex; 
            gap: .75rem; 
            justify-content: flex-end; 
            margin-top: 1.5rem; 
        }
        .btn-save { background: #0071e3; color: #fff; border-color: #0071e3; }
        
        /* Feedback colors */
        .ok { color: #34c759; font-weight: 600; } /* Green for correct */
        .no { color: #ff3b30; font-weight: 600; } /* Red for incorrect */
        .done-msg { color: #86868b; }
        .done-msg button { margin-top: 1rem; }

        /* ===== SESSION INFO (Top Left) ===== */
        /* Shows progress: "5/20" and progress bar */
        .session-info { 
            position: fixed; 
            top: 1.5rem; 
            left: 1.5rem; 
            background: #fff; 
            padding: 1rem 1.5rem; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,.1); 
            font-size: 1.1rem; 
            z-index: 10; 
        }
        /* Blue progress bar */
        .session-info .progress-bar { 
            width: 180px; 
            height: 6px; 
            background: #e8e8ed; 
            border-radius: 3px; 
            margin-top: .5rem; 
            overflow: hidden; 
        }
        .session-info .progress-fill { 
            height: 100%; 
            background: #0071e3; 
            border-radius: 2px; 
            transition: width .3s; 
        }
        /* Red badge showing mistake count */
        .session-info .mistake-badge { color: #ff3b30; font-weight: 600; }

        /* ===== MISTAKE REVIEW BANNER ===== */
        /* Yellow banner shown when reviewing cards you got wrong */
        .review-banner { 
            background: #fff5f5; 
            border: 1px solid #ffccc9; 
            color: #ff3b30; 
            padding: 1rem 2rem; 
            border-radius: 12px; 
            margin-bottom: 2rem; 
            font-weight: 500; 
            font-size: 1.1rem; 
            display: flex; 
            align-items: center; 
            gap: .5rem; 
        }
        .review-banner::before { content: "üîÑ"; }

        /* ===== SESSION COMPLETE SCREEN ===== */
        .session-complete { 
            text-align: center; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .session-complete h2 { 
            font-size: 2.5rem; 
            margin-bottom: 1.5rem; 
            color: #34c759; /* Green success color */ 
        }
        /* Stats grid: Studied | Correct | Accuracy */
        .session-stats { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 1.5rem; 
            margin: 2rem auto; 
            max-width: 450px; 
        }
        .session-stat { 
            background: #f5f5f7; 
            padding: 1.25rem; 
            border-radius: 12px; 
        }
        .session-stat .num { 
            font-size: 2.2rem; 
            font-weight: 600; 
            color: #1d1d1f; 
        }
        .session-stat .label { 
            font-size: .85rem; 
            color: #86868b; 
            margin-top: .25rem; 
        }
        .session-actions {
            display: flex;
            gap: .75rem;
            justify-content: center;
        }

        /* ===== WELCOME PAGE ===== */
        /* Shown before starting a study session */
        .welcome-page { 
            background: #fff; 
            border-radius: 20px; 
            padding: 3rem; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 400px; 
            box-shadow: 0 2px 8px rgba(0,0,0,.08); 
            text-align: center; 
        }
        .welcome-page h1 { font-size: 2rem; margin-bottom: 2rem; color: #1d1d1f; }
        .welcome-form { width: 100%; max-width: 360px; }
        .welcome-form label { 
            display: block; 
            text-align: left; 
            font-size: .85rem; 
            color: #86868b; 
            margin-bottom: .25rem; 
        }
        .welcome-form select, .welcome-form input[type="number"] { 
            width: 100%; 
            padding: .875rem; 
            border: 1px solid #d2d2d7; 
            border-radius: 10px; 
            font: inherit; 
            font-size: 1.2rem; 
            margin-bottom: 1.5rem; 
            background: #fff; 
        }
        .welcome-form button { 
            width: 100%; 
            padding: 1rem; 
            background: #0071e3; 
            color: #fff; 
            border: none; 
            border-radius: 10px; 
            font: inherit; 
            font-size: 1.2rem; 
            font-weight: 500; 
            cursor: pointer; 
        }
        .welcome-form button:hover { background: #0077ed; }
        .welcome-form button:disabled { 
            background: #d2d2d7; 
            cursor: not-allowed; 
        }

        /* ===== BUTTON STYLES ===== */
        button { 
            background: #f5f5f7; 
            border: 1px solid #d2d2d7; 
            color: #1d1d1f; 
            padding: .7rem 1.4rem; 
            border-radius: 8px; 
            font: inherit; 
            font-size: 1.05rem; 
            cursor: pointer; 
            transition: all .2s; 
        }
        button:hover { background: #e8e8ed; }
        
        /* Primary action button (blue) */
        .btn-primary { 
            background: #0071e3; 
            border-color: #0071e3; 
            color: #fff; 
        }
        .btn-primary:hover { background: #0077ed; }
        
        /* Danger button (red) */
        .btn-danger { 
            color: #ff3b30; 
            border-color: #ffccc9; 
            background: #fff5f5; 
        }
        .btn-danger:hover { background: #ffeceb; }
        
        /* Success button (green) */
        .btn-success { 
            background: #34c759; 
            border-color: #34c759; 
            color: #fff; 
        }
        .btn-success:hover { background: #30b350; }

        /* ===== SIDEBAR (Right Column) ===== */
        .sidebar { 
            display: flex; 
            flex-direction: column; 
            gap: 1.25rem; 
        }

        /* Header card: Language selector + stats */
        .sidebar-header { 
            background: #fff; 
            border-radius: 16px; 
            padding: 1.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,.08); 
        }
        .lang-section { 
            display: flex; 
            align-items: center; 
            gap: .75rem; 
            margin-bottom: 1rem; 
        }
        /* Blue gradient icon for language */
        .lang-icon { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #0071e3, #00c6ff); 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.2rem; 
        }
        .lang-select-wrap { flex: 1; }
        .lang-select { 
            width: 100%; 
            padding: .5rem .75rem; 
            border-radius: 8px; 
            border: 1px solid #d2d2d7; 
            background: #f5f5f7; 
            font: inherit; 
            font-size: .95rem; 
            cursor: pointer; 
            transition: all .2s; 
        }
        .lang-select:hover { border-color: #0071e3; }
        .lang-actions { display: flex; gap: .25rem; }
        .lang-actions button { 
            padding: .4rem .5rem; 
            font-size: .85rem; 
            background: transparent; 
            border: none; 
            border-radius: 6px; 
            opacity: .6; 
        }
        .lang-actions button:hover { opacity: 1; background: #f5f5f7; }

        /* Stats pills: Due, Learning, Mastered, Accuracy */
        .stats-row { 
            display: flex; 
            gap: .5rem; 
            flex-wrap: wrap; 
        }
        .stat-pill { 
            display: flex; 
            align-items: center; 
            gap: .4rem; 
            padding: .5rem .75rem; 
            background: #f5f5f7; 
            border-radius: 20px; 
            font-size: .9rem; 
        }
        .stat-pill .icon { font-size: .95rem; }
        .stat-pill .num { font-weight: 600; color: #1d1d1f; }
        .stat-pill .label { color: #86868b; font-size: .8rem; }
        /* Orange pill for due cards */
        .stat-pill.due { background: #fff4e6; }
        .stat-pill.due .num { color: #ff9500; }
        /* Green pill for mastered cards */
        .stat-pill.mastered { background: #e8f5e9; }
        .stat-pill.mastered .num { color: #34c759; }

        /* Streak card */
        .streak-card { 
            background: linear-gradient(135deg, #fff9f0, #fff5f0); 
            border-radius: 16px; 
            padding: 1.25rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,.08);
            border: 1px solid #ffe4d6;
        }
        .streak-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .streak-title { 
            font-size: .75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: #86868b; 
            font-weight: 600; 
        }
        .streak-flame {
            font-size: 1.5rem;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .streak-count {
            font-size: 2rem;
            font-weight: 700;
            color: #ff6b35;
            line-height: 1;
        }
        .streak-label {
            font-size: 0.85rem;
            color: #86868b;
            margin-top: 0.25rem;
        }
        .streak-progress {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #ffe4d6;
        }
        .streak-progress-bar {
            height: 6px;
            background: #ffe4d6;
            border-radius: 3px;
            overflow: hidden;
        }
        .streak-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #ff9500);
            border-radius: 2px;
            transition: width 0.3s;
        }
        .streak-progress-text {
            font-size: 0.75rem;
            color: #86868b;
            margin-top: 0.4rem;
            text-align: center;
        }
        .streak-complete {
            color: #34c759;
            font-weight: 600;
        }

        /* Data management card (Export/Import/Clear) */
        .data-card { 
            background: #fff; 
            border-radius: 16px; 
            padding: 1.25rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,.08); 
        }
        .data-title { 
            font-size: .75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: #86868b; 
            margin-bottom: .75rem; 
            font-weight: 600; 
        }
        .data-btns { display: flex; gap: .5rem; }
        .data-btns button { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: .4rem; 
            padding: .6rem; 
            font-size: .85rem; 
            background: #f5f5f7; 
            border: 1px solid transparent; 
            border-radius: 8px; 
        }
        .data-btns button:hover { background: #e8e8ed; }
        .data-btns button.danger { color: #ff3b30; }
        .data-btns button.danger:hover { 
            background: #ffeceb; 
            border-color: #ffccc9; 
        }

        /* Words list card (scrollable list of all cards) */
        .words-card { 
            background: #fff; 
            border-radius: 16px; 
            padding: 1.25rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,.08); 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            min-height: 0; 
        }
        .words-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: .75rem; 
        }
        .words-title { 
            font-size: .75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: #86868b; 
            font-weight: 600; 
        }
        .words-title span { color: #1d1d1f; font-weight: 600; margin-left: .25rem; }
        .sort-select { 
            font-size: .85rem; 
            padding: .35rem .6rem; 
            border-radius: 8px; 
            border: 1px solid #d2d2d7; 
            background: #f5f5f7; 
            cursor: pointer; 
        }
        .sort-select:hover { border-color: #0071e3; }
        
        /* Blue "Add Card" button */
        .btn-add-card { 
            display: flex; 
            align-items: center; 
            gap: .3rem; 
            padding: .4rem .75rem; 
            background: #0071e3; 
            color: #fff; 
            border: none; 
            border-radius: 8px; 
            font-size: .85rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all .2s; 
        }
        .btn-add-card:hover { 
            background: #0077ed; 
            transform: translateY(-1px); 
        }

        /* Scrollable list of vocabulary cards */
        .words-list { 
            flex: 1; 
            overflow-y: auto; /* Scroll if too many cards */
            min-height: 0; 
            margin: 0 -.25rem; 
            padding: 0 .25rem; 
        }
        
        /* Individual card row in the list */
        .word-item { 
            display: flex; 
            align-items: center; 
            padding: .6rem .5rem; 
            border-radius: 10px; 
            gap: .75rem; 
            transition: background .15s; 
        }
        .word-item:hover { background: #f5f5f7; }
        
        /* Status dot: orange=due, green=mastered, gray=new */
        .word-status { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            flex-shrink: 0; 
        }
        .word-status.due { 
            background: #ff9500; 
            box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.15); 
        }
        .word-status.ok { background: #34c759; }
        .word-status.new { background: #86868b; }
        
        .word-info { flex: 1; min-width: 0; }
        .word-name { 
            font-weight: 500; 
            font-size: 1rem; 
            color: #1d1d1f; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .word-meta { 
            font-size: .75rem; 
            color: #86868b; 
            margin-top: .1rem; 
        }
        
        /* Edit/Delete buttons appear on hover */
        .word-actions { 
            display: flex; 
            gap: .25rem; 
            opacity: 0; 
            transition: opacity .15s; 
        }
        .word-item:hover .word-actions { opacity: 1; }
        .word-actions button { 
            padding: .35rem .5rem; 
            font-size: .75rem; 
            background: transparent; 
            border: none; 
            border-radius: 6px; 
            opacity: .6; 
        }
        .word-actions button:hover { opacity: 1; background: #e8e8ed; }
        .word-actions button.danger { color: #ff3b30; }
        .word-actions button.danger:hover { background: #ffeceb; }

        /* Empty state when no cards exist */
        .words-empty { 
            text-align: center; 
            padding: 2rem 1rem; 
            color: #86868b; 
            font-size: .9rem; 
        }
        .words-empty .icon { font-size: 2rem; margin-bottom: .5rem; opacity: .5; }

        /* Add language form (hidden by default) */
        .lang-form { 
            display: none; 
            margin-top: .75rem; 
            padding: .75rem; 
            background: #f5f5f7; 
            border-radius: 10px; 
        }
        .lang-form.show { 
            display: block; 
            animation: slideDown .2s ease; 
        }
        .lang-form input { 
            width: 100%; 
            padding: .5rem .75rem; 
            margin-bottom: .4rem; 
            border: 1px solid #d2d2d7; 
            border-radius: 8px; 
            font: inherit; 
            font-size: .9rem; 
        }
        .lang-form-btns { 
            display: flex; 
            gap: .4rem; 
            justify-content: flex-end; 
        }
        .lang-form-btns button { font-size: .85rem; padding: .4rem .75rem; }

        /* ===== RESPONSIVE STYLES (Large Screens) ===== */
        @media (min-width: 1920px) {
            .container { 
                max-width: 1800px; 
                grid-template-columns: 1fr 480px; 
                gap: 4rem; 
            }
            .sentence { font-size: 2.6rem; max-width: 1000px; }
            .hint { font-size: 1.4rem; }
            input[type="text"] { width: 450px; font-size: 1.6rem; }
            .study-panel { min-height: 600px; }
        }

        /* Hide file input (triggered by button) */
        input[type="file"] { display: none; }

        /* Shake animation for wrong answers */
        .shake { animation: shake 0.5s ease; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        /* ===== IMAGE PANEL (Bottom) ===== */
        /* Fixed bottom panel showing Bing image search results */
        .image-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid #d2d2d7;
            box-shadow: 0 -4px 20px rgba(0,0,0,.1);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform .3s ease;
            max-height: 220px;
        }
        .image-panel.show {
            transform: translateY(0);
        }
        
        .image-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .5rem 1rem;
            border-bottom: 1px solid #e8e8ed;
            background: #f5f5f7;
        }
        .image-panel-title {
            font-size: .85rem;
            font-weight: 600;
            color: #1d1d1f;
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .image-panel-title .word {
            color: #0071e3;
        }
        .image-panel-actions {
            display: flex;
            gap: .5rem;
        }
        .image-panel-actions button {
            padding: .35rem .75rem;
            font-size: .8rem;
            background: #fff;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            cursor: pointer;
        }
        .image-panel-actions button:hover {
            background: #f5f5f7;
        }
        .image-panel-close {
            background: transparent !important;
            border: none !important;
            font-size: 1.2rem !important;
            padding: .25rem .5rem !important;
        }
        
        .image-panel-content {
            padding: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #d2d2d7 transparent;
            min-height: 140px;
        }
        .image-panel-content::-webkit-scrollbar {
            height: 6px;
        }
        .image-panel-content::-webkit-scrollbar-thumb {
            background: #d2d2d7;
            border-radius: 3px;
        }
        
        .image-results {
            display: flex;
            gap: .75rem;
            align-items: center;
        }
        
        .image-result {
            flex-shrink: 0;
            width: 120px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            background: #f5f5f7;
            border: 1px solid #e8e8ed;
            cursor: pointer;
            transition: all .2s;
            position: relative;
        }
        .image-result:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,.15);
        }
        .image-result img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .image-result-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #86868b;
            font-size: 2rem;
        }
        
        .image-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            color: #86868b;
            font-size: .9rem;
            padding: 2rem;
            width: 100%;
        }
        .image-loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid #d2d2d7;
            border-top-color: #0071e3;
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .image-error {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            color: #86868b;
            font-size: .9rem;
            padding: 2rem;
            width: 100%;
        }
        
        /* Image toggle button in study panel */
        .btn-images {
            position: absolute;
            bottom: 1.5rem;
            left: 1.5rem;
            display: none; /* Hidden by default, shown during session */
            align-items: center;
            gap: .4rem;
            padding: .5rem 1rem;
            background: #f5f5f7;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: .9rem;
            cursor: pointer;
            opacity: 0.7;
            transition: all .2s;
        }
        .btn-images:hover {
            opacity: 1;
            background: #e8e8ed;
        }
        .btn-images.active {
            background: #0071e3;
            color: #fff;
            border-color: #0071e3;
        }
        .btn-images.visible {
            display: flex;
        }
        
        /* Adjust container when image panel is visible */
        body.image-panel-open {
            padding-bottom: 220px;
        }
        body.image-panel-open .study-panel {
            max-height: calc(100vh - 280px);
        }
        
        /* Image modal for full-size view */
        .image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }
        .image-modal-overlay.show {
            display: flex;
        }
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
        .image-modal-content img {
            max-width: 100%;
            max-height: 80vh;
            display: block;
        }
        .image-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,.2);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-modal-close:hover {
            background: rgba(255,255,255,.3);
        }
    </style>
</head>
<body>

<!-- ===== SESSION PROGRESS (Top Left) ===== -->
<!-- Shows "5/20" progress and how many mistakes to review -->
<div class="session-info" id="sessionInfo" style="display: none;">
    <div>Session: <span id="sessionProgress">0/20</span> <span id="mistakeBadge" class="mistake-badge" style="display: none;"></span></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
</div>

<!-- ===== TOP BAR (Top Right) ===== -->
<!-- Shows count of due cards and focus mode toggle -->
<div class="top-bar">
    <span><strong id="dueCount">0</strong> due</span>
    <button class="focus-btn" onclick="toggleFocus()" title="Toggle sidebar" id="focusBtn">‚ò∞</button>
</div>

<!-- ===== MAIN CONTAINER ===== -->
<!-- Grid layout: study panel + sidebar -->
<div class="container">
    
    <!-- ===== MAIN STUDY AREA ===== -->
    <main class="study-panel" id="studyPanel">
        
        <!-- WELCOME PAGE: Shown before starting a session -->
        <div class="welcome-page" id="welcomePage">
            <h1>Flashcards</h1>
            <div class="welcome-form">
                <label>Language</label>
                <select id="welcomeLangSelect" onchange="changeWelcomeLang()">
                    <option value="en">English</option>
                </select>
                
                <label>Cards to study (<span id="welcomeDue">0</span> due)</label>
                <input type="number" id="sessionSizeInput" value="50" min="1" max="500">
                
                <button id="startBtn" onclick="startSession()">Start</button>
            </div>
        </div>

        <!-- STUDY INTERFACE: Shown during active session -->
        <div id="studyInterface" style="display: none; width: 100%; text-align: center;">
            <!-- Banner shown when reviewing mistakes -->
            <div class="review-banner" id="reviewBanner" style="display: none;">Mistake Review Mode</div>
            
            <!-- Main sentence with hidden word -->
            <p class="sentence" id="sentence"></p>
            
            <!-- Definition hint with first letter revealed -->
            <p class="hint" id="hint"></p>
            
            <!-- Answer input field -->
            <div class="input-wrap">
                <input type="text" id="answer" autocomplete="off">
            </div>
            
            <!-- Feedback message area -->
            <p class="msg" id="msg"></p>
            
            <!-- Quick edit/delete for current card -->
            <div class="study-actions" id="studyActions">
                <button onclick="editCurrentCard()" title="Edit">‚úèÔ∏è</button>
                <button class="btn-delete" onclick="deleteCurrentCard()" title="Delete">üóëÔ∏è</button>
            </div>
            
            <!-- Images button -->
            <button class="btn-images" id="btnImages" onclick="toggleImagePanel()" title="Show word images">
                <span>üñºÔ∏è</span> Images
            </button>
            
            <!-- EDIT MODAL: Popup to edit the current card -->
            <div class="modal-overlay" id="editModal" onclick="if(event.target===this)closeEditModal()">
                <div class="modal">
                    <h3>Edit Card</h3>
                    <div class="form-group">
                        <label>Word</label>
                        <input type="text" id="editWord" oninput="validateEdit()">
                    </div>
                    <div class="form-group">
                        <label>Definition</label>
                        <input type="text" id="editDef">
                    </div>
                    <div class="form-group">
                        <label>Sentence (include the word)</label>
                        <textarea id="editSent" oninput="validateEdit()"></textarea>
                        <p class="error" id="editError">Include the word in your sentence</p>
                        <div class="preview" id="editPreview"></div>
                    </div>
                    <div class="modal-btns">
                        <button onclick="closeEditModal()">Cancel</button>
                        <button class="btn-primary" onclick="saveEdit()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ===== SIDEBAR (Right Column) ===== -->
    <aside class="sidebar">
        
        <!-- LANGUAGE SELECTOR & STATS -->
        <div class="sidebar-header">
            <div class="lang-section">
                <div class="lang-icon">üåê</div>
                <div class="lang-select-wrap">
                    <select class="lang-select" id="langSelect" onchange="switchLang()">
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="lang-actions">
                    <button onclick="toggleLangForm()" title="Add language">+</button>
                    <button onclick="renameLang()" title="Rename">‚úé</button>
                </div>
            </div>
            
            <!-- Hidden form to add new language -->
            <div class="lang-form" id="langForm">
                <input id="newLangName" placeholder="Language name (e.g., Spanish)">
                <input id="newLangCode" placeholder="Code (e.g., es)">
                <div class="lang-form-btns">
                    <button onclick="cancelLangForm()">Cancel</button>
                    <button class="btn-primary" onclick="addLang()">Add</button>
                </div>
            </div>
            
            <!-- Stats pills row -->
            <div class="stats-row">
                <div class="stat-pill due">
                    <span class="icon">‚è∞</span>
                    <span class="num" id="statDue">0</span>
                    <span class="label">due</span>
                </div>
                <div class="stat-pill">
                    <span class="icon">üìö</span>
                    <span class="num" id="statLearning">0</span>
                    <span class="label">learning</span>
                </div>
                <div class="stat-pill mastered">
                    <span class="icon">‚≠ê</span>
                    <span class="num" id="statMastered">0</span>
                    <span class="label">mastered</span>
                </div>
                <div class="stat-pill">
                    <span class="icon">üéØ</span>
                    <span class="num" id="statAccuracy">0%</span>
                    <span class="label">accuracy</span>
                </div>
            </div>
        </div>

        <!-- STREAK CARD -->
        <div class="streak-card">
            <div class="streak-header">
                <div class="streak-title">Daily Streak</div>
                <div class="streak-flame" id="streakFlame">üî•</div>
            </div>
            <div class="streak-count" id="streakCount">0</div>
            <div class="streak-label" id="streakLabel">day streak</div>
            <div class="streak-progress">
                <div class="streak-progress-bar">
                    <div class="streak-progress-fill" id="streakProgressFill" style="width: 0%"></div>
                </div>
                <div class="streak-progress-text" id="streakProgressText">0 / 50 words today</div>
            </div>
        </div>

        <!-- DATA MANAGEMENT CARD -->
        <div class="data-card">
            <div class="data-title">Data</div>
            <div class="data-btns">
                <button onclick="exp()">
                    <span>üì§</span> Export
                </button>
                <button onclick="imp.click()">
                    <span>üì•</span> Import
                </button>
                <button class="danger" onclick="clearWords()">
                    <span>üóëÔ∏è</span> Clear
                </button>
            </div>
            <!-- Hidden file input for import -->
            <input type="file" id="imp" accept=".json" onchange="handleImport(this)">
        </div>

        <!-- VOCABULARY LIST CARD -->
        <div class="words-card">
            <div class="words-header">
                <div class="words-title">Cards <span id="langCount">0</span></div>
                <div style="display: flex; gap: .5rem; align-items: center;">
                    <button class="btn-add-card" onclick="openAddModal()" title="Add new card">
                        <span>‚ûï</span> Add
                    </button>
                    <select class="sort-select" id="sortSelect" onchange="renderList()">
                        <option value="due">Due First</option>
                        <option value="word">A-Z</option>
                        <option value="ef">Hardest</option>
                        <option value="stage">Stage</option>
                    </select>
                </div>
            </div>
            <!-- Scrollable list container -->
            <div class="words-list" id="wordsList"></div>
        </div>
    </aside>

    <!-- ADD CARD MODAL: Popup to create new flashcards -->
    <div class="modal-overlay" id="addModal" onclick="if(event.target===this)closeAddModal()">
        <div class="modal">
            <h3>Add New Card</h3>
            <div class="form-group">
                <label>Word</label>
                <input type="text" id="aWord" placeholder="e.g., elephant" oninput="validateAddForm()">
            </div>
            <div class="form-group">
                <label>Definition (hint)</label>
                <input type="text" id="aDef" placeholder="e.g., a large animal with a trunk">
            </div>
            <div class="form-group">
                <label>Sentence (include the word)</label>
                <textarea id="aSent" placeholder="e.g., The elephant sprayed water with its trunk." oninput="validateAddForm()"></textarea>
                <p class="error" id="addError">Include the word in your sentence</p>
                <div class="preview" id="addPreview"></div>
            </div>
            <div class="modal-btns">
                <button onclick="closeAddModal()">Cancel</button>
                <button class="btn-primary" onclick="saveCard()">Save Card</button>
            </div>
        </div>
    </div>
</div>

<!-- ===== IMAGE PANEL (Bottom) ===== -->
<div class="image-panel" id="imagePanel">
    <div class="image-panel-header">
        <div class="image-panel-title">
            <span>üñºÔ∏è</span>
            Images for: <span class="word" id="imagePanelWord">-</span>
        </div>
        <div class="image-panel-actions">
            <button onclick="refreshImages()" title="Refresh">üîÑ</button>
            <button onclick="openBingSearch()" title="Open in Bing">üîç</button>
            <button class="image-panel-close" onclick="toggleImagePanel()" title="Close">√ó</button>
        </div>
    </div>
    <div class="image-panel-content">
        <div class="image-results" id="imageResults">
            <div class="image-loading">Loading images...</div>
        </div>
    </div>
</div>

<!-- ===== IMAGE MODAL (Full-size view) ===== -->
<div class="image-modal-overlay" id="imageModal" onclick="closeImageModal()">
    <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
    <div class="image-modal-content" onclick="event.stopPropagation()">
        <img id="imageModalImg" src="" alt="Full size">
    </div>
</div>

<script>
// ===== DOM ELEMENT REFERENCES =====
// Cache frequently accessed elements for better performance
const sentence = document.getElementById('sentence');
const hint = document.getElementById('hint');
const answer = document.getElementById('answer');
const msg = document.getElementById('msg');

// ===== DATA STORAGE =====
// Load cards from localStorage, or use default starter cards
let cards = JSON.parse(localStorage.cards || 'null') || [
    {w:'apple', s:'She took a bite of the crisp red apple.', d:'a round fruit', lang:'en'},
    {w:'banana', s:'The monkey peeled the banana before eating.', d:'a long curved yellow fruit', lang:'en'},
    {w:'door', s:'Please close the door behind you.', d:'a barrier for an entrance', lang:'en'}
], cur, editIdx = -1, answerStartTime = 0;

// Languages list with current selection
let languages = JSON.parse(localStorage.languages || 'null') || [{code: 'en', name: 'English'}];
let currentLang = localStorage.currentLang || 'en';

// ===== SESSION STATE =====
// Variables to track the current study session
let sessionSize = 20;           // How many cards to study in this session
let sessionCardsStudied = 0;    // Counter for cards completed
let sessionMistakes = [];       // Cards answered wrong (for review)
let reviewingMistakes = false;  // Currently in "mistake review mode"?
let inSession = false;          // Is a session active?
let sessionDueCards = [];       // Queue of cards due for this session
const INTERLEAVE_INTERVAL = 10; // Review mistakes every N cards
let waitingForNext = false;     // Waiting for Enter key to proceed?
let lastAnswerWrong = false;    // Was the last answer incorrect?

// ===== HELPER FUNCTIONS =====

// Save cards to localStorage (persist data)
const save = () => localStorage.cards = JSON.stringify(cards);

// Save language settings
const saveLangs = () => localStorage.languages = JSON.stringify(languages);
const saveCurrentLang = () => localStorage.currentLang = currentLang;

// ===== STREAK SYSTEM =====
const DAILY_GOAL = 50; // Default words per day

// Load streak data from localStorage
let streakData = JSON.parse(localStorage.streakData || 'null') || {
    currentStreak: 0,
    lastStudyDate: null,
    wordsStudiedToday: 0
};

// Save streak data
const saveStreak = () => localStorage.streakData = JSON.stringify(streakData);

// Get today's date string (YYYY-MM-DD)
const getTodayString = () => {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
};

// Get yesterday's date string
const getYesterdayString = () => {
    const now = new Date();
    now.setDate(now.getDate() - 1);
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
};

// Check and update streak status
function checkStreak() {
    const today = getTodayString();
    const yesterday = getYesterdayString();
    
    // If it's a new day, reset daily counter
    if (streakData.lastStudyDate !== today) {
        // Check if streak should be broken (more than 1 day gap)
        if (streakData.lastStudyDate !== yesterday && streakData.lastStudyDate !== null) {
            streakData.currentStreak = 0;
        }
        streakData.wordsStudiedToday = 0;
        streakData.lastStudyDate = today;
        saveStreak();
    }
}

// Add words to today's count and check if goal is met
function addWordsToStreak(count) {
    checkStreak();
    streakData.wordsStudiedToday += count;
    
    // If goal is reached for the first time today, increment streak
    if (streakData.wordsStudiedToday >= DAILY_GOAL && streakData.wordsStudiedToday - count < DAILY_GOAL) {
        streakData.currentStreak++;
    }
    
    saveStreak();
    updateStreakUI();
}

// Update streak UI elements
function updateStreakUI() {
    checkStreak();
    
    const streakCount = document.getElementById('streakCount');
    const streakLabel = document.getElementById('streakLabel');
    const streakFlame = document.getElementById('streakFlame');
    const streakProgressFill = document.getElementById('streakProgressFill');
    const streakProgressText = document.getElementById('streakProgressText');
    
    if (streakCount) streakCount.textContent = streakData.currentStreak;
    if (streakLabel) streakLabel.textContent = streakData.currentStreak === 1 ? 'day streak' : 'days streak';
    
    // Update flame animation based on streak
    if (streakFlame) {
        if (streakData.currentStreak > 0) {
            streakFlame.style.opacity = '1';
            streakFlame.style.filter = 'none';
        } else {
            streakFlame.style.opacity = '0.5';
            streakFlame.style.filter = 'grayscale(100%)';
        }
    }
    
    // Update progress bar
    const progress = Math.min(100, (streakData.wordsStudiedToday / DAILY_GOAL) * 100);
    if (streakProgressFill) streakProgressFill.style.width = `${progress}%`;
    
    // Update progress text
    if (streakProgressText) {
        if (streakData.wordsStudiedToday >= DAILY_GOAL) {
            streakProgressText.innerHTML = `<span class="streak-complete">‚úì Goal reached! ${streakData.wordsStudiedToday} words</span>`;
        } else {
            const remaining = DAILY_GOAL - streakData.wordsStudiedToday;
            streakProgressText.textContent = `${streakData.wordsStudiedToday} / ${DAILY_GOAL} words today (${remaining} to go)`;
        }
    }
}

// Add streak info to welcome page
function updateWelcomeStreakUI() {
    checkStreak();
    updateStreakUI();
}

// Get cards that are due for review in current language
const dueCards = () => cards.filter(c => (c.due||0) <= Date.now() && (c.lang || 'en') === currentLang);

// Get all cards for current language
const currentLangCards = () => cards.filter(c => (c.lang || 'en') === currentLang);

// Find index of a card in the main array (for editing/deleting)
const findCardIndex = (card) => cards.findIndex(c => c.w === card.w && c.s === card.s && c.lang === card.lang);

// Remove a card from the current session (when deleted)
const removeCardFromSession = (card) => {
    sessionDueCards = sessionDueCards.filter(c => !(c.w === card.w && c.s === card.s));
    sessionMistakes = sessionMistakes.filter(c => !(c.w === card.w && c.s === card.s));
};

// Escape special regex characters for safe matching
function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Speak a sentence using the Web Speech API
 * Used to reinforce pronunciation after answering
 * @param {string} text - The sentence to speak
 * @param {string} langCode - Language code (e.g., 'en', 'es', 'fr')
 */
function speakSentence(text, langCode) {
    if (!window.speechSynthesis) return;
    speechSynthesis.cancel();  // Stop any previous speech

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = langCode || 'en';
    speechSynthesis.speak(utterance);
}

/**
 * Validate that a sentence contains the target word
 * Shows error if missing, shows preview with word hidden if valid
 * @param {string} word - The word that should appear
 * @param {string} sentence - The sentence to check
 * @param {string} errorId - ID of error message element
 * @param {string} previewId - ID of preview element
 * @returns {boolean} - True if valid
 */
function validateSentence(word, sentence, errorId, previewId) {
    const errorEl = document.getElementById(errorId);
    const previewEl = document.getElementById(previewId);
    
    if (word && sentence) {
        if (sentence.toLowerCase().includes(word.toLowerCase())) {
            errorEl?.classList.remove('show');
            previewEl?.classList.add('show');
            if (previewEl) {
                // Show preview with word replaced by ___
                previewEl.innerHTML = sentence.replace(new RegExp('(' + escapeRegex(word) + ')', 'gi'), '<strong>___</strong>');
            }
            return true;
        } else {
            errorEl?.classList.add('show');
            previewEl?.classList.remove('show');
            return false;
        }
    } else {
        errorEl?.classList.remove('show');
        previewEl?.classList.remove('show');
        return false;
    }
}

/**
 * Calculate Levenshtein distance between two strings
 * Used for fuzzy matching (detecting typos)
 * Returns number of character edits needed to transform a into b
 */
function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array.from({length: m + 1}, () => Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            dp[i][j] = a[i-1] === b[j-1] ? dp[i-1][j-1] : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
        }
    }
    return dp[m][n];
}

/**
 * Calculate response quality (0-5) based on accuracy and speed
 * 5 = Perfect, fast (< 3 sec)
 * 4 = Perfect, normal (3-8 sec)
 * 3 = Perfect, slow (> 8 sec)
 * 2 = Minor typo (80%+ similar)
 * 1 = Major mistake (50%+ similar)
 * 0 = Complete miss (< 50% similar)
 */
function calculateQuality(userAnswer, correctAnswer, responseTimeMs) {
    const ua = userAnswer.trim().toLowerCase();
    const ca = correctAnswer.toLowerCase();
    const isCorrect = ua === ca;
    const distance = levenshtein(ua, ca);
    const similarity = 1 - distance / Math.max(ca.length, 1);
    const seconds = responseTimeMs / 1000;

    if (isCorrect) {
        return seconds < 3 ? 5 : seconds < 8 ? 4 : 3;
    }
    return similarity >= 0.8 ? 2 : similarity >= 0.5 ? 1 : 0;
}

/**
 * SM-2 Spaced Repetition Algorithm
 * This is the core algorithm that schedules when cards appear again
 * 
 * How it works:
 * - EF (Ease Factor): How easy the card is (starts at 2.5, min 1.3)
 * - n: Number of successful reviews in a row
 * - Interval: Minutes until next review
 * 
 * Intervals: 1min ‚Üí 10min ‚Üí 1day ‚Üí 6days ‚Üí EF multiplier
 * Wrong answers reset to 1 minute
 */
function sm2(card, quality) {
    // Initialize card properties if new
    if (card.ef === undefined) card.ef = 2.5;
    if (card.n === undefined) card.n = 0;

    // Update ease factor based on performance
    const qDiff = 5 - quality;
    card.ef = Math.max(1.3, card.ef + (0.1 - qDiff * (0.08 + qDiff * 0.02)));

    // Calculate next interval (in minutes)
    let intervalMins;
    if (quality < 3) {
        // Failed - reset to beginning
        card.n = 0;
        intervalMins = 1;
    } else {
        // Passed - increase interval
        if (card.n === 0) intervalMins = 1;
        else if (card.n === 1) intervalMins = 10;
        else if (card.n === 2) intervalMins = 1440;      // 1 day
        else if (card.n === 3) intervalMins = 6 * 1440;  // 6 days
        else intervalMins = Math.round((card.int || 1440) * card.ef);
        card.n++;
    }

    // Cap at 1 year (525600 minutes)
    card.int = Math.min(intervalMins, 525600);
    // Schedule due date
    card.due = Date.now() + card.int * 60000;
    return quality >= 3;
}

/**
 * Toggle focus mode (hide sidebar for distraction-free studying)
 * Saves preference to localStorage
 */
function toggleFocus() {
    const container = document.querySelector('.container');
    const focusBtn = document.getElementById('focusBtn');
    const isFocus = container.classList.toggle('focus-mode');
    focusBtn.textContent = isFocus ? '‚óß' : '‚ò∞';
    localStorage.focusMode = isFocus;
}

// Restore focus mode on page load
if (localStorage.focusMode === 'true') {
    document.querySelector('.container').classList.add('focus-mode');
    document.getElementById('focusBtn').textContent = '‚óß';
}

// ===== WELCOME PAGE FUNCTIONS =====

// Update the "X due" count on welcome screen
function updateWelcomeStats() {
    const due = dueCards().length;
    document.getElementById('welcomeDue').textContent = due;
    const startBtn = document.getElementById('startBtn');
    startBtn.disabled = due === 0;
    startBtn.textContent = due === 0 ? 'No Cards Due' : 'Start';
}

// Populate language dropdown on welcome page
function updateWelcomeLangSelect() {
    const select = document.getElementById('welcomeLangSelect');
    select.innerHTML = languages.map(l => `<option value="${l.code}"${l.code === currentLang ? ' selected' : ''}>${l.name}</option>`).join('');
}

// When language changes on welcome page
function changeWelcomeLang() {
    currentLang = document.getElementById('welcomeLangSelect').value;
    saveCurrentLang();
    renderLangSelect();
    updateWelcomeStats();
    updateStats();
    renderList();
}

// ===== SESSION MANAGEMENT =====

/**
 * Start a new study session
 * 1. Get due cards for selected language
 * 2. Shuffle and limit to session size
 * 3. Show study interface, hide welcome page
 */
function startSession() {
    const due = dueCards();
    if (due.length === 0) return;
    
    sessionSize = Math.min(500, Math.max(1, parseInt(document.getElementById('sessionSizeInput').value) || 20));
    
    document.getElementById('welcomePage').style.display = 'none';
    document.getElementById('studyInterface').style.display = '';
    
    // Reset session state
    inSession = true;
    sessionCardsStudied = 0;
    sessionMistakes = [];
    reviewingMistakes = false;
    waitingForNext = false;
    lastAnswerWrong = false;
    
    // Shuffle and select cards for this session
    sessionDueCards = due.slice(0, sessionSize).sort(() => Math.random() - 0.5);
    
    updateSessionUI();
    document.getElementById('sessionInfo').style.display = 'block';
    show();
}

// Return to welcome page, ending current session
function returnToWelcome() {
    inSession = false;
    sessionCardsStudied = 0;
    sessionMistakes = [];
    reviewingMistakes = false;
    waitingForNext = false;
    lastAnswerWrong = false;
    sessionDueCards = [];
    
    document.getElementById('studyInterface').style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    document.getElementById('btnImages').classList.remove('visible');
    document.getElementById('welcomePage').style.display = '';
    document.getElementById('sessionInfo').style.display = 'none';
    document.getElementById('msg').innerHTML = '';
    
    updateWelcomeStats();
    updateStats();
}

// Update progress bar and badge in top-left
function updateSessionUI() {
    checkStreak();
    const totalInSession = Math.min(sessionSize, sessionDueCards.length + sessionCardsStudied);
    const progress = Math.min(sessionCardsStudied, totalInSession);
    const percent = totalInSession > 0 ? (progress / totalInSession * 100) : 0;
    
    document.getElementById('sessionProgress').textContent = `${progress}/${totalInSession}`;
    document.getElementById('progressFill').style.width = `${percent}%`;
    
    const badge = document.getElementById('mistakeBadge');
    if (sessionMistakes.length > 0 && !reviewingMistakes) {
        badge.textContent = `(${sessionMistakes.length} mistakes)`;
        badge.style.display = '';
    } else {
        badge.style.display = 'none';
    }
}

// Check if it's time to review mistakes (every 10 cards)
function checkInterleaveReview() {
    if (!reviewingMistakes && sessionMistakes.length > 0 && sessionCardsStudied > 0 && sessionCardsStudied % INTERLEAVE_INTERVAL === 0) {
        reviewingMistakes = true;
        return true;
    }
    return false;
}

// ===== LANGUAGE MANAGEMENT =====

// Update language dropdown in sidebar
function renderLangSelect() {
    const select = document.getElementById('langSelect');
    select.innerHTML = languages.map(l => `<option value="${l.code}"${l.code === currentLang ? ' selected' : ''}>${l.name}</option>`).join('');
    document.getElementById('langCount').textContent = currentLangCards().length;
    updateWelcomeLangSelect();
}

// Switch to a different language
function switchLang() {
    currentLang = document.getElementById('langSelect').value;
    saveCurrentLang();
    renderLangSelect();
    updateWelcomeLangSelect();
    if (inSession) {
        returnToWelcome();
    } else {
        updateWelcomeStats();
    }
    updateStats();
    renderList();
}

// Show/hide the "add language" form
function toggleLangForm() {
    document.getElementById('langForm').classList.toggle('show');
    document.getElementById('newLangName').focus();
}

function cancelLangForm() {
    document.getElementById('langForm').classList.remove('show');
    document.getElementById('newLangName').value = '';
    document.getElementById('newLangCode').value = '';
}

// Add a new language to the system
function addLang() {
    const name = document.getElementById('newLangName').value.trim();
    const code = document.getElementById('newLangCode').value.trim().toLowerCase();
    
    if (!name || !code) return;
    if (languages.find(l => l.code === code)) {
        alert('Language code already exists');
        return;
    }
    
    languages.push({name, code});
    saveLangs();
    currentLang = code;
    saveCurrentLang();
    renderLangSelect();
    updateWelcomeLangSelect();
    cancelLangForm();
    updateWelcomeStats();
    updateStats();
}

// Rename current language
function renameLang() {
    const lang = languages.find(l => l.code === currentLang);
    if (!lang) return;
    
    const newName = prompt(`Rename "${lang.name}":`, lang.name);
    if (newName?.trim()) {
        lang.name = newName.trim();
        saveLangs();
        renderLangSelect();
        updateWelcomeLangSelect();
    }
}

// Format minutes into human-readable string
function formatInterval(mins) {
    if (!mins || mins <= 1) return 'new';
    if (mins < 60) return `${Math.round(mins)}m`;
    if (mins < 1440) return `${Math.round(mins/60)}h`;
    return `${Math.round(mins/1440)}d`;
}

// ===== STATS & DISPLAY =====

// Update all statistics displays
function updateStats() {
    const langCards = currentLangCards();
    const due = dueCards().length;
    // Mastered = 4+ successful reviews
    const mastered = langCards.filter(c => (c.n||0) >= 4).length;
    const totalReviews = langCards.reduce((a,c) => a + (c.reviews||0), 0);
    const totalCorrect = langCards.reduce((a,c) => a + (c.correct||0), 0);
    const accuracy = totalReviews ? Math.round(totalCorrect/totalReviews*100) : 0;

    document.getElementById('dueCount').textContent = due;
    document.getElementById('statDue').textContent = due;
    document.getElementById('statLearning').textContent = langCards.length - mastered;
    document.getElementById('statMastered').textContent = mastered;
    document.getElementById('statAccuracy').textContent = `${accuracy}%`;
    document.getElementById('langCount').textContent = langCards.length;
}

/**
 * Show the next flashcard
 * Handles three modes:
 * 1. Regular session - show due cards in order
 * 2. Mistake review - show cards that were answered wrong
 * 3. No cards - show completion/empty state
 */
function show() {
    waitingForNext = false;
    lastAnswerWrong = false;
    updateStats();
    renderList();
    
    // Priority 1: Review mistakes if in that mode
    if (reviewingMistakes && sessionMistakes.length > 0) {
        showMistakeReview();
        return;
    }
    
    // Priority 2: Check if it's time for interleaved review
    if (inSession && checkInterleaveReview()) {
        showMistakeReview();
        return;
    }
    
    // Get the appropriate card queue
    const dc = inSession ? sessionDueCards : dueCards();

    // No cards available
    if (!dc.length) {
        if (inSession) {
            // Session complete or still have mistakes
            if (sessionMistakes.length > 0) {
                reviewingMistakes = true;
                showMistakeReview();
                return;
            }
            showSessionComplete();
        } else {
            showNoCards();
        }
        return;
    }

    // Hide review banner, reset UI
    document.getElementById('reviewBanner').style.display = 'none';
    
    sentence.classList.remove('done-msg');
    answer.style.display = '';
    answer.readOnly = false;
    answer.style.background = '';
    msg.textContent = '';
    
    // Select next card (random if casual, sequential if session)
    cur = inSession ? dc[0] : dc[Math.random()*dc.length|0];
    
    // Display sentence with word hidden
    sentence.textContent = cur.s.replace(new RegExp(escapeRegex(cur.w), 'gi'), '___');
    // Show hint: definition + first letter
    hint.textContent = `${cur.d} (${cur.w[0]})`;
    answer.value = '';
    answer.focus();
    answerStartTime = Date.now();
    
    // Load images for the current word if panel is open
    if (imagePanelOpen) {
        loadImages(cur.w);
    }
}

// Show a card from the mistake review queue
function showMistakeReview() {
    waitingForNext = false;
    lastAnswerWrong = false;
    
    // No more mistakes? Return to normal
    if (sessionMistakes.length === 0) {
        reviewingMistakes = false;
        show();
        return;
    }
    
    document.getElementById('reviewBanner').style.display = '';
    
    sentence.classList.remove('done-msg');
    answer.style.display = '';
    answer.readOnly = false;
    answer.style.background = '';
    msg.textContent = '';
    
    // Take first mistake card
    cur = sessionMistakes[0];
    sentence.textContent = cur.s.replace(new RegExp(escapeRegex(cur.w), 'gi'), '___');
    hint.textContent = `${cur.d} (${cur.w[0]})`;
    answer.value = '';
    answer.focus();
    answerStartTime = Date.now();
}

// Show "All done" when no cards are due
function showNoCards() {
    sentence.textContent = 'All done';
    sentence.classList.add('done-msg');
    hint.textContent = '';
    answer.style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    
    msg.innerHTML = '<button class="btn-primary" onclick="resetAll()">Study Again</button>';
}

// Show session completion screen with stats
function showSessionComplete() {
    sentence.textContent = '';
    sentence.classList.remove('done-msg');
    hint.textContent = '';
    answer.style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    document.getElementById('reviewBanner').style.display = 'none';
    
    
    const sessionTotal = sessionCardsStudied;
    const mistakeCount = sessionMistakes.length;
    const correctCount = sessionTotal - mistakeCount;
    const accuracy = sessionTotal > 0 ? Math.round(correctCount / sessionTotal * 100) : 0;
    const remainingDue = dueCards().length;
    
    msg.innerHTML = 
        `<div class="session-complete">
        <h2>üéâ Session Complete!</h2>
        <div class="session-stats">
        <div class="session-stat"><div class="num">${sessionTotal}</div><div class="label">Studied</div></div>
        <div class="session-stat"><div class="num">${correctCount}</div><div class="label">Correct</div></div>
        <div class="session-stat"><div class="num">${accuracy}%</div><div class="label">Accuracy</div></div>
        </div>
        <p style="color: #86868b; margin-bottom: 1rem;">${remainingDue} cards still due</p>
        <div class="session-actions">
            <button class="btn-primary" onclick="startSession()">New Session</button>
            <button onclick="returnToWelcome()">Back to Home</button>
        </div>
        </div>`;
}

// Reset all cards to "new" state (for testing or restarting)
function resetAll() {
    cards.forEach(c => { c.due = 0; c.n = 0; c.int = 1; });
    save();
    show();
}

// ===== KEYBOARD SHORTCUTS =====

// ESC key closes modals
document.onkeydown = e => {
    if (e.key === 'Escape') {
        closeEditModal();
        closeAddModal();
        closeImageModal();
    }
    // 'I' key toggles image panel
    if (e.key === 'i' || e.key === 'I') {
        if (inSession && document.activeElement !== answer) {
            toggleImagePanel();
        }
    }
};

// ENTER key handles answer submission and progression
answer.onkeydown = e => {
    if (e.key !== 'Enter' || !cur) return;
    
    // If we already showed feedback, Enter proceeds to next card
    if (waitingForNext) {
        waitingForNext = false;
        msg.textContent = '';
        
        answer.readOnly = false;
        answer.style.background = '';
        
        // If wrong, give another chance on same card
        if (lastAnswerWrong) {
            lastAnswerWrong = false;
            sentence.textContent = cur.s.replace(new RegExp(escapeRegex(cur.w), 'gi'), '___');
            answer.focus();
            answerStartTime = Date.now();
            return;
        }
        
        // Move to next card
        show();
        return;
    }
    
    // Check the answer
    const userAnswer = answer.value.trim().toLowerCase();
    const correctAnswer = cur.w.toLowerCase();
    const isCorrect = userAnswer === correctAnswer;
    
    // WRONG ANSWER
    if (!isCorrect) {
        lastAnswerWrong = true;
        // Track mistake for review
        if (inSession && !reviewingMistakes) {
            const alreadyMistake = sessionMistakes.some(c => c.w === cur.w && c.lang === cur.lang);
            if (!alreadyMistake) {
                sessionMistakes.push(cur);
            }
        }
        // Show the correct word in red
        sentence.innerHTML = cur.s.replace(new RegExp(`(${escapeRegex(cur.w)})`, 'gi'), `<span class="no">$1</span>`);
        speakSentence(cur.s, cur.lang || 'en');  // TTS: hear correct pronunciation
        msg.innerHTML = '<span style="color: #86868b;">Press Enter to try again</span>';
        answer.value = '';
        answer.readOnly = true;
        answer.style.background = '#ffeceb'; // Light red background
        answer.classList.add('shake'); // Shake animation
        setTimeout(() => answer.classList.remove('shake'), 500);
        waitingForNext = true;
        updateSessionUI();
        
        // Auto-show images after wrong answer
        if (!imagePanelOpen) {
            toggleImagePanel();
        } else if (cur?.w) {
            loadImages(cur.w);
        }
        return;
    }
    
    // CORRECT ANSWER
    const responseTime = Date.now() - answerStartTime;
    const quality = calculateQuality(answer.value, cur.w, responseTime);
    const ok = sm2(cur, quality); // Apply SM-2 algorithm

    // Track stats
    cur.reviews = (cur.reviews || 0) + 1;
    cur.correct = (cur.correct || 0) + (ok ? 1 : 0);
    cur.lastReview = new Date().toISOString();
    cur.lastQuality = quality;
    save();

    // Show the correct word in green
    sentence.innerHTML = cur.s.replace(new RegExp(`(${escapeRegex(cur.w)})`, 'gi'), `<span class="ok">$1</span>`);
    speakSentence(cur.s, cur.lang || 'en');  // TTS: reinforce pronunciation
    
    // Update session progress
    if (inSession) {
        if (reviewingMistakes) {
            // Remove from mistake queue
            sessionMistakes = sessionMistakes.filter(c => !(c.w === cur.w && c.lang === cur.lang));
            sessionDueCards = sessionDueCards.filter(c => !(c.w === cur.w && c.lang === cur.lang));
        } else {
            // Normal session progress
            sessionDueCards = sessionDueCards.filter(c => !(c.w === cur.w && c.lang === cur.lang));
            sessionCardsStudied++;
            // Add to streak counter
            addWordsToStreak(1);
        }
        updateSessionUI();
    }
    
    lastAnswerWrong = false;
    waitingForNext = true;
    msg.innerHTML = '<span style="color: #86868b;">Press Enter to continue</span>';
    
    // Auto-show images after correct answer
    if (!imagePanelOpen) {
        toggleImagePanel();
    } else if (cur?.w) {
        loadImages(cur.w);
    }
    answer.value = '';
    answer.readOnly = true;
    answer.style.background = '#e8e8ed'; // Gray background (done)
};

// ===== SIDEBAR: CARD LIST =====

// Render the scrollable list of all cards
function renderList() {
    const sortBy = document.getElementById('sortSelect').value;
    // Filter to current language and add index for editing
    let sorted = cards.map((c,i) => ({...c, idx: i})).filter(c => (c.lang || 'en') === currentLang);

    // Apply sorting
    if (sortBy === 'word') sorted.sort((a,b) => a.w.localeCompare(b.w));
    else if (sortBy === 'due') sorted.sort((a,b) => (a.due||0) - (b.due||0));
    else if (sortBy === 'ef') sorted.sort((a,b) => (a.ef||2.5) - (b.ef||2.5));
    else if (sortBy === 'stage') sorted.sort((a,b) => (a.n||0) - (b.n||0));

    // Empty state
    if (sorted.length === 0) {
        document.getElementById('wordsList').innerHTML = `
            <div class="words-empty">
                <div class="icon">üìù</div>
                <div>No cards yet</div>
                <div style="font-size: .8rem; margin-top: .25rem;">Click "Add Card" to create one</div>
            </div>`;
        return;
    }

    // Render each card row
    document.getElementById('wordsList').innerHTML = sorted.map(c => {
        const isDue = (c.due||0) <= Date.now();
        const isNew = (c.n || 0) === 0;
        const ef = (c.ef || 2.5).toFixed(1);
        const stage = (c.n || 0);
        const stageLabel = stage === 0 ? 'New' : stage < 4 ? `Learning ${stage}` : 'Mastered';
        const statusClass = isDue ? 'due' : isNew ? 'new' : 'ok';
        
        return `<div class="word-item">
            <div class="word-status ${statusClass}"></div>
            <div class="word-info">
                <div class="word-name">${c.w}</div>
                <div class="word-meta">${stageLabel} ¬∑ Next: ${formatInterval(c.int)} ¬∑ EF: ${ef}</div>
            </div>
            <div class="word-actions">
                <button onclick="editCard(${c.idx})" title="Edit">‚úé</button>
                <button class="danger" onclick="delCard(${c.idx})" title="Delete">üóë</button>
            </div>
        </div>`;
    }).join('');
}

// ===== ADD CARD MODAL =====

function openAddModal() {
    editIdx = -1;
    document.getElementById('aWord').value = '';
    document.getElementById('aSent').value = '';
    document.getElementById('aDef').value = '';
    document.getElementById('addError').classList.remove('show');
    document.getElementById('addPreview').classList.remove('show');
    document.getElementById('addModal').classList.add('show');
    document.getElementById('aWord').focus();
}

function closeAddModal() {
    editIdx = -1;
    document.getElementById('addModal').classList.remove('show');
}

function validateAddForm() {
    const word = document.getElementById('aWord').value.trim();
    const sent = document.getElementById('aSent').value.trim();
    validateSentence(word, sent, 'addError', 'addPreview');
}

// Save new or edited card
function saveCard() {
    const w = document.getElementById('aWord').value.trim();
    const s = document.getElementById('aSent').value.trim();
    const d = document.getElementById('aDef').value.trim();
    
    if (!w || !s || !d) {
        alert('Please fill in all fields');
        return;
    }
    if (!s.toLowerCase().includes(w.toLowerCase())) {
        alert('The sentence must include the word');
        return;
    }

    if (editIdx >= 0) {
        // Edit existing
        cards[editIdx].w = w;
        cards[editIdx].s = s;
        cards[editIdx].d = d;
        cards[editIdx].lang = currentLang;
    } else {
        // Add new card with SM-2 defaults
        cards.push({w, s, d, int: 1, due: 0, ef: 2.5, n: 0, lang: currentLang});
    }

    save();
    closeAddModal();
    if (!inSession) updateWelcomeStats();
    updateStats();
    renderList();
}

// Legacy aliases for backward compatibility
toggleAdd = openAddModal;
cancelAdd = closeAddModal;
validateCard = validateAddForm;

// Edit a card from the sidebar list
function editCard(i) {
    editIdx = i;
    document.getElementById('aWord').value = cards[i].w;
    document.getElementById('aSent').value = cards[i].s;
    document.getElementById('aDef').value = cards[i].d;
    document.getElementById('addError').classList.remove('show');
    document.getElementById('addPreview').classList.remove('show');
    document.getElementById('addModal').classList.add('show');
    validateAddForm();
    document.getElementById('aWord').focus();
}

// Delete a card from the sidebar
function delCard(i) {
    if (confirm(`Delete "${cards[i].w}"?`)) {
        cards.splice(i, 1);
        save();
        if (!inSession) updateWelcomeStats();
        updateStats();
        renderList();
    }
}

// ===== STUDY PANEL: EDIT CURRENT CARD =====

// Edit the card currently being studied
function editCurrentCard() {
    if (!cur) return;
    document.getElementById('editWord').value = cur.w;
    document.getElementById('editDef').value = cur.d;
    document.getElementById('editSent').value = cur.s;
    document.getElementById('editError').classList.remove('show');
    document.getElementById('editPreview').classList.remove('show');
    document.getElementById('editModal').classList.add('show');
    document.getElementById('editWord').focus();
}

function validateEdit() {
    const word = document.getElementById('editWord').value.trim();
    const sent = document.getElementById('editSent').value.trim();
    validateSentence(word, sent, 'editError', 'editPreview');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

// Save changes to the currently studied card
function saveEdit() {
    if (!cur) return;
    
    const newWord = document.getElementById('editWord').value.trim();
    const newDef = document.getElementById('editDef').value.trim();
    const newSent = document.getElementById('editSent').value.trim();
    
    if (!newWord || !newDef || !newSent) {
        alert('All fields are required');
        return;
    }
    if (!newSent.toLowerCase().includes(newWord.toLowerCase())) {
        alert('The sentence must include the word');
        return;
    }
    
    const idx = findCardIndex(cur);
    if (idx === -1) return;
    
    cards[idx].w = newWord;
    cards[idx].d = newDef;
    cards[idx].s = newSent;
    save();
    
    // Update the displayed card
    cur = cards[idx];
    sentence.innerHTML = cur.s.replace(new RegExp(`(${cur.w})`, 'gi'), '<span class="ok">$1</span>');
    hint.textContent = `${cur.d} (${cur.w[0]})`;
    
    renderList();
    updateStats();
    if (!inSession) updateWelcomeStats();
    closeEditModal();
}

// Delete the card currently being studied
function deleteCurrentCard() {
    if (!cur) return;
    if (!confirm(`Delete "${cur.w}"?`)) return;
    
    const idx = findCardIndex(cur);
    if (idx === -1) return;
    
    cards.splice(idx, 1);
    save();
    
    if (inSession) removeCardFromSession(cur);
    
    waitingForNext = false;
    lastAnswerWrong = false;
    
    renderList();
    updateStats();
    if (!inSession) updateWelcomeStats();
    show();
}

// ===== DATA MANAGEMENT =====

// Clear all cards (with confirmation)
function clearWords() {
    const langCards = currentLangCards();
    if (langCards.length === 0) {
        alert(`No cards to clear for ${languages.find(l => l.code === currentLang)?.name || currentLang}`);
        return;
    }
    
    const allCardsCount = cards.length;
    const currentLangCount = langCards.length;
    
    let message = `Clear cards for "${languages.find(l => l.code === currentLang)?.name || currentLang}" (${currentLangCount} cards)?\n\n`;
    message += 'Click OK to clear current language only.\n';
    if (allCardsCount > currentLangCount) {
        message += `Click Cancel, then type "ALL" to clear ALL ${allCardsCount} cards across all languages.`;
    }
    
    if (confirm(message)) {
        cards = cards.filter(c => (c.lang || 'en') !== currentLang);
        save();
        if (!inSession) updateWelcomeStats();
        updateStats();
        renderList();
    } else {
        const confirmAll = prompt(`Type "ALL" (uppercase) to delete ALL ${allCardsCount} cards across all languages:`);
        if (confirmAll === 'ALL') {
            cards = [];
            save();
            if (!inSession) updateWelcomeStats();
            updateStats();
            renderList();
        }
    }
}

// Export cards to JSON file
function exp() {
    const langCards = currentLangCards();
    const exportData = {
        version: 1,
        exportedAt: new Date().toISOString(),
        language: languages.find(l => l.code === currentLang)?.name || currentLang,
        languageCode: currentLang,
        cardCount: langCards.length,
        cards: langCards
    };
    const a = document.createElement('a');
    a.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(exportData, null, 2));
    a.download = `flashcards-${currentLang}-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

// Import cards from JSON file
function handleImport(input) {
    if (!input.files[0]) return;
    input.files[0].text().then(t => {
        try {
            const data = JSON.parse(t);
            let newCards = [];
            
            // Support both object format {cards: [...]} and array format [...]
            if (data.cards && Array.isArray(data.cards)) {
                newCards = data.cards;
            } else if (Array.isArray(data)) {
                newCards = data;
            } else {
                alert('Invalid JSON format');
                return;
            }
            
            // Validate and deduplicate
            newCards = newCards.filter(c => c.w && c.s && c.d);
            cards = cards.filter(c => !newCards.find(nc => nc.w === c.w && nc.lang === c.lang));
            cards = cards.concat(newCards);
            save();
            
            if (!inSession) updateWelcomeStats();
            updateStats();
            renderList();
            
            alert(`Imported ${newCards.length} cards!`);
        } catch (e) {
            alert('Error reading JSON file: ' + e.message);
        }
        input.value = '';
    });
}

// ===== IMAGE PANEL FUNCTIONS =====
let imagePanelOpen = localStorage.imagePanelOpen === 'true';
let currentImageWord = '';

// Restore image panel state on load
if (imagePanelOpen) {
    document.getElementById('imagePanel').classList.add('show');
    document.getElementById('btnImages').classList.add('active');
    document.body.classList.add('image-panel-open');
}

function toggleImagePanel() {
    const panel = document.getElementById('imagePanel');
    const btn = document.getElementById('btnImages');
    imagePanelOpen = !imagePanelOpen;
    
    if (imagePanelOpen) {
        panel.classList.add('show');
        btn.classList.add('active');
        document.body.classList.add('image-panel-open');
        // Load images for current word if in session
        if (cur && cur.w) {
            loadImages(cur.w);
        }
    } else {
        panel.classList.remove('show');
        btn.classList.remove('active');
        document.body.classList.remove('image-panel-open');
    }
    
    localStorage.imagePanelOpen = imagePanelOpen;
}

// Load images from Bing Image Search
async function loadImages(word) {
    if (!word || word === currentImageWord) return;
    currentImageWord = word;
    
    document.getElementById('imagePanelWord').textContent = word;
    const resultsContainer = document.getElementById('imageResults');
    resultsContainer.innerHTML = '<div class="image-loading">Loading images...</div>';
    
    try {
        // Use Bing image search via a CORS-friendly approach
        // We'll use the Bing image search URL with a fallback to showing search link
        const images = await fetchBingImages(word);
        
        if (images.length === 0) {
            resultsContainer.innerHTML = `
                <div class="image-error">
                    <span>‚ö†Ô∏è</span> No images found. 
                    <button onclick="openBingSearch()" style="margin-left: .5rem;">Search Bing</button>
                </div>`;
            return;
        }
        
        resultsContainer.innerHTML = images.map((img, i) => `
            <div class="image-result" onclick="openImageModal('${escapeHtml(img.url)}')" title="${escapeHtml(img.title || word)}">
                <img src="${escapeHtml(img.thumbnail)}" alt="${escapeHtml(img.title || word)}" loading="lazy" onerror="this.parentElement.style.display='none'">
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading images:', error);
        resultsContainer.innerHTML = `
            <div class="image-error">
                <span>üîç</span> 
                <a href="https://www.bing.com/images/search?q=${encodeURIComponent(word)}" target="_blank" style="color: #0071e3;">
                    Search "${escapeHtml(word)}" on Bing Images
                </a>
            </div>`;
    }
}

// Fetch images from multiple sources for better results
async function fetchBingImages(query) {
    const images = [];
    const encodedQuery = encodeURIComponent(query);
    
    try {
        // Try Wikimedia Commons API first (reliable, educational images)
        try {
            const commonsUrl = `https://commons.wikimedia.org/w/api.php?action=query&list=search&srsearch=${encodedQuery}&srnamespace=6&format=json&origin=*&srlimit=10`;
            const commonsResponse = await fetch(commonsUrl);
            const commonsData = await commonsResponse.json();
            
            if (commonsData.query && commonsData.query.search && commonsData.query.search.length > 0) {
                // Get image info for the search results
                const titles = commonsData.query.search.slice(0, 6).map(s => s.title).join('|');
                const imageInfoUrl = `https://commons.wikimedia.org/w/api.php?action=query&titles=${encodeURIComponent(titles)}&prop=imageinfo&iiprop=url|thumburl&iiurlwidth=300&format=json&origin=*`;
                
                const infoResponse = await fetch(imageInfoUrl);
                const infoData = await infoResponse.json();
                
                const pages = infoData.query.pages;
                for (const pageId in pages) {
                    const page = pages[pageId];
                    if (page.imageinfo && page.imageinfo[0]) {
                        const info = page.imageinfo[0];
                        images.push({
                            url: info.url,
                            thumbnail: info.thumburl || info.url,
                            title: page.title.replace('File:', '').replace(/\.[^/.]+$/, '')
                        });
                    }
                }
            }
        } catch (e) {
            console.log('Wikimedia Commons fetch failed:', e);
        }
        
        // Try Wikipedia as secondary source
        if (images.length < 4) {
            try {
                const wikiUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodedQuery}&format=json&origin=*&srlimit=5`;
                const wikiResponse = await fetch(wikiUrl);
                const wikiData = await wikiResponse.json();
                
                if (wikiData.query && wikiData.query.search) {
                    for (const result of wikiData.query.search.slice(0, 3)) {
                        const imageUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(result.title)}&prop=pageimages&format=json&origin=*&pithumbsize=300`;
                        
                        const imgResponse = await fetch(imageUrl);
                        const imgData = await imgResponse.json();
                        
                        const pages = imgData.query.pages;
                        for (const pageId in pages) {
                            const page = pages[pageId];
                            if (page.thumbnail && page.thumbnail.source) {
                                // Avoid duplicates
                                const exists = images.some(img => img.thumbnail === page.thumbnail.source);
                                if (!exists) {
                                    images.push({
                                        url: page.thumbnail.source,
                                        thumbnail: page.thumbnail.source,
                                        title: result.title
                                    });
                                }
                            }
                        }
                    }
                }
            } catch (e) {
                console.log('Wikipedia fetch failed:', e);
            }
        }
        
        // Use Lorem Flickr as a reliable fallback for any word
        if (images.length < 6) {
            const needed = 8 - images.length;
            for (let i = 0; i < needed; i++) {
                images.push({
                    url: `https://loremflickr.com/400/400/${encodedQuery}?lock=${i}`,
                    thumbnail: `https://loremflickr.com/120/120/${encodedQuery}?lock=${i}`,
                    title: query
                });
            }
        }
        
    } catch (error) {
        console.error('Error fetching images:', error);
    }
    
    return images.slice(0, 8);
}

// Refresh images for current word
function refreshImages() {
    if (currentImageWord) {
        currentImageWord = ''; // Reset to force reload
        loadImages(cur?.w || currentImageWord);
    }
}

// Open Bing search in new tab
function openBingSearch() {
    const word = currentImageWord || (cur?.w) || '';
    if (word) {
        window.open(`https://www.bing.com/images/search?q=${encodeURIComponent(word)}`, '_blank');
    }
}

// Open image modal for full-size view
function openImageModal(url) {
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('imageModalImg');
    img.src = url;
    modal.classList.add('show');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('show');
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ===== INITIALIZATION =====
// Run these when page loads
checkStreak();
renderLangSelect();
updateWelcomeLangSelect();
updateWelcomeStats();
updateWelcomeStreakUI();
updateStats();
renderList();
</script>
</body>
</html>
