<!DOCTYPE html>
<!--
  FLASHCARDS APP - A Spaced Repetition Learning Tool
  ================================================
  This app helps you learn vocabulary using the SM-2 algorithm, similar to Anki.
  
  HOW IT WORKS:
  1. Cards have a word, definition, and example sentence
  2. You see the sentence with the word hidden (___)
  3. Type the missing word - the app grades your response
  4. Based on accuracy and speed, the card is scheduled for review
  
  KEY CONCEPTS:
  - Due cards: Cards ready for review (based on spacing algorithm)
  - Learning stages: New ‚Üí Learning ‚Üí Mastered
  - Mistake review: Wrong answers reappear during the session
  - Focus mode: Hide sidebar to concentrate on studying
-->
<html>
<head>
    <meta charset="UTF-8">
    <!-- Fixed width for consistent study experience -->
    <meta name="viewport" content="width=1280">
    <title>Flashcards</title>
    <link rel="stylesheet" href="color-palette.css">
    <style>
        /* ===== GLOBAL STYLES ===== */
        /* Reset default margins and use border-box for predictable sizing */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Main page styling: warm cream background with system fonts */
        body { 
            font: 1rem system-ui, -apple-system, sans-serif; 
            background: var(--color-bg-primary); /* Warm cream */ 
            color: var(--color-text-primary); /* Dark brown text */ 
            min-height: 100vh; 
        }

        /* ===== MAIN LAYOUT ===== */
        /* Container uses CSS grid: main study area + sidebar */
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 2rem 3rem; 
            display: grid; 
            grid-template-columns: 1fr 420px; /* Main content | Sidebar */ 
            gap: 3rem; 
            min-height: calc(100vh - 3rem); 
            transition: all .3s; 
            align-items: start; 
        }
        
        /* Focus mode container background */
        .container.focus-mode {
            background: transparent;
        }
        
        /* Focus mode: hide sidebar, center the study panel */
        .container.focus-mode { grid-template-columns: 1fr; max-width: 900px; }
        .container.focus-mode .sidebar { display: none; }

        /* ===== TOP BAR ===== */
        /* Fixed position buttons in top-right corner */
        .top-bar { 
            position: fixed; 
            top: 1.5rem; 
            right: 1.5rem; 
            display: flex; 
            gap: .75rem; 
            align-items: center; 
            font-size: 1rem; 
            color: var(--color-text-muted); /* Muted brown */ 
            z-index: 10; 
        }
        
        /* ===== DAILY PROGRESS BAR (Above Study Panel) ===== */
        .daily-progress-bar-container {
            width: 100%;
            height: 4px;
            margin-bottom: 1.5rem;
            opacity: 0;
            transition: opacity .3s ease;
        }
        .daily-progress-bar-container.show {
            opacity: 1;
        }
        .daily-progress-bar-container .daily-progress-bar { 
            width: 100%; 
            height: 100%; 
            background: var(--color-border-secondary); 
            border-radius: 2px; 
            overflow: hidden;
        }
        .daily-progress-bar-container .daily-progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--color-progress-orange), var(--color-progress-orange-light)); 
            border-radius: 2px; 
            transition: width .3s ease; 
        }
        .daily-progress-bar-container .daily-progress-fill.complete {
            background: linear-gradient(90deg, var(--color-progress-green), var(--color-progress-green-light));
        }
        
        /* Hamburger button to toggle focus mode */
        .focus-btn { 
            background: var(--color-elevation-2); 
            border: 1px solid var(--color-border-primary); 
            color: var(--color-text-primary);
            font-size: 1.1rem; 
            cursor: pointer; 
            padding: .5rem .75rem; 
            border-radius: 8px; 
            transition: all .2s; 
        }
        .focus-btn:hover { background: var(--color-elevation-3); }

        /* ===== STUDY PANEL (Main Learning Area) ===== */
        /* Cream card where you actually study flashcards */
        .study-panel { 
            background: var(--color-elevation-1); 
            border-radius: 20px; 
            padding: 2.5rem; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 400px; 
            box-shadow: 0 4px 20px var(--color-shadow); 
            position: sticky; 
            top: 1.5rem; /* Stick to top when scrolling */
            align-self: flex-start; 
            z-index: 5; 
            border: 1px solid var(--color-border-secondary);
            transition: box-shadow .3s ease, transform .3s ease;
        }
        .study-panel:hover {
            box-shadow: 0 6px 28px var(--color-shadow-dark);
        }
        
        /* Example sentence with hidden word shown as ___ */
        .sentence { 
            font-size: 1.8rem; 
            line-height: 1.5; 
            text-align: center; 
            margin-bottom: 1.5rem; 
            color: var(--color-text-dark); 
            max-width: 900px; 
        }
        
        /* Definition hint shown below the sentence */
        .hint { 
            color: var(--color-text-muted); /* Muted brown hint text */ 
            font-size: 1.1rem; 
            margin-bottom: 2rem; 
            text-align: center; 
            font-style: italic; 
            max-width: 800px; 
        }
        
        /* Container for the answer input field */
        .input-wrap { position: relative; }
        
        /* Main text input where you type the answer */
        input[type="text"] { 
            border: 2px solid var(--color-border-primary); 
            background: var(--color-elevation-2); 
            color: var(--color-text-primary);
            border-radius: 14px; 
            padding: 1rem 1.5rem; 
            width: 380px; 
            font-size: 1.3rem; 
            text-align: center; 
            outline: none; 
            transition: border-color .2s ease, background-color .2s ease, box-shadow .2s ease; 
        }
        input[type="text"]:hover {
            border-color: var(--color-border-secondary);
            background: var(--color-elevation-1);
        }
        input[type="text"]:focus { 
            border-color: var(--color-success); /* Sage green on focus */ 
            background: var(--color-elevation-1); 
            box-shadow: 0 0 0 4px var(--color-focus-bg);
        }
        
        /* Feedback message (correct/incorrect/prompts) */
        .msg { 
            margin-top: 1.5rem; 
            font-size: 1.1rem; 
            min-height: 1.5rem; 
            font-weight: 500; 
        }
        
        /* ===== STUDY ACTIONS (Edit/Delete buttons) ===== */
        /* Hidden by default, appear on hover */
        .study-actions { 
            display: flex; 
            gap: .5rem; 
            position: absolute; 
            bottom: 1.5rem; 
            right: 1.5rem;
            opacity: 0.25; /* Semi-transparent normally */
            transition: opacity .3s;
        }
        .study-panel:hover .study-actions { opacity: 0.6; }
        .study-actions:hover { opacity: 1 !important; }
        
        /* Small action buttons in the study panel */
        .study-actions button { 
            width: 36px; 
            height: 36px; 
            padding: 0; 
            font-size: 1rem; 
            background: var(--color-elevation-2); 
            border: 1px solid var(--color-border-secondary); 
            border-radius: 8px; 
            cursor: pointer; 
            opacity: 0.7;
            transition: all .2s; 
        }
        .study-actions button:hover { 
            opacity: 1; 
            background: var(--color-elevation-3); 
            transform: scale(1.05); 
        }
        /* Delete button turns red on hover */
        .study-actions .btn-delete:hover { 
            background: var(--color-error-pale); 
            border-color: var(--color-error-light); 
        }
        
        /* ===== MODAL DIALOGS (Add/Edit Card) ===== */
        /* Dark overlay behind modal */
        .modal-overlay { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: var(--color-shadow-heavy); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
            opacity: 0;
            visibility: hidden;
            transition: opacity .2s ease, visibility .2s ease;
        }
        .modal-overlay.show { 
            opacity: 1;
            visibility: visible;
        }
        
        /* Cream modal box */
        .modal { 
            background: var(--color-elevation-1); 
            border-radius: 16px; 
            padding: 2rem; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 
                0 25px 80px var(--color-shadow-dark),
                0 10px 30px rgba(0, 0, 0, 0.1); 
            border: 1px solid var(--color-border-secondary);
            transform: scale(0.95);
            opacity: 0;
            transition: transform .25s cubic-bezier(0.16, 1, 0.3, 1), 
                        opacity .2s ease;
        }
        .modal-overlay.show .modal {
            transform: scale(1);
            opacity: 1;
        }
        .modal h3 { margin-bottom: 1.5rem; font-size: 1.3rem; color: var(--color-text-dark); }
        .modal .form-group { margin-bottom: 1rem; }
        .modal label { 
            display: block; 
            font-size: .85rem; 
            color: var(--color-text-muted); 
            margin-bottom: .3rem; 
        }
        .modal input, .modal textarea { 
            width: 100%; 
            padding: .75rem; 
            border: 1px solid var(--color-border-primary); 
            border-radius: 8px; 
            font: inherit; 
            font-size: 1rem; 
            background: var(--color-elevation-2);
            color: var(--color-text-primary);
        }
        .modal input:focus, .modal textarea:focus { 
            outline: none; 
            border-color: var(--color-success); 
            background: var(--color-elevation-1);
        }
        .modal textarea { height: 80px; resize: none; }
        
        /* Error message shown when sentence doesn't contain the word */
        .modal .error { 
            color: var(--color-error-text); /* Muted red */ 
            font-size: .85rem; 
            margin-top: .25rem; 
            display: none; 
        }
        .modal .error.show { display: block; }
        
        /* Preview showing how the sentence will look */
        .modal .preview { 
            font-size: .9rem; 
            color: var(--color-text-muted); 
            margin-top: .5rem; 
            padding: .5rem; 
            background: var(--color-elevation-2); 
            border-radius: 6px; 
            display: none; 
        }
        .modal .preview.show { display: block; }
        /* The hidden word shown as a sage green box in preview */
        .modal .preview strong { 
            background: var(--color-success); 
            color: var(--color-bg-secondary); 
            padding: .1rem .4rem; 
            border-radius: 4px; 
        }
        
        .modal-btns { 
            display: flex; 
            gap: .75rem; 
            justify-content: flex-end; 
            margin-top: 1.5rem; 
        }
        .btn-save { background: var(--color-success); color: var(--color-bg-secondary); border-color: var(--color-success); }
        
        /* Preview Modal Styles */
        .preview-modal {
            max-width: 400px;
        }
        .preview-word {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--color-text-dark);
            margin-bottom: .75rem;
            text-align: center;
        }
        .preview-def {
            font-size: 1rem;
            color: var(--color-text-muted);
            font-style: italic;
            margin-bottom: 1rem;
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border-secondary);
        }
        .preview-sentence {
            font-size: 1.1rem;
            color: var(--color-text-primary);
            line-height: 1.5;
            margin-bottom: 1rem;
            text-align: center;
        }
        .preview-sentence .highlight {
            background: var(--color-success);
            color: var(--color-bg-secondary);
            padding: .1rem .4rem;
            border-radius: 4px;
        }
        .preview-meta {
            display: flex;
            justify-content: center;
            gap: 1rem;
            font-size: .85rem;
            color: var(--color-text-muted);
        }
        .preview-meta span {
            display: flex;
            align-items: center;
            gap: .3rem;
        }
        
        /* Feedback colors */
        .ok { color: var(--color-success); font-weight: 600; } /* Sage green for correct */
        .no { color: var(--color-error); font-weight: 600; } /* Muted red for incorrect */
        .done-msg { color: var(--color-text-muted); }
        .done-msg button { margin-top: 1rem; }

        /* ===== STUDY COMPLETE SCREEN ===== */
        .session-complete { 
            text-align: center; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .session-complete h2 { 
            font-size: 2.5rem; 
            margin-bottom: 1.5rem; 
            color: var(--color-success); /* Sage green success color */ 
        }
        /* Stats grid: Studied | Correct | Accuracy */
        .session-stats { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 1.5rem; 
            margin: 2rem auto; 
            max-width: 450px; 
        }
        .session-stat { 
            background: var(--color-elevation-2); 
            padding: 1.25rem; 
            border-radius: 12px; 
            border: 1px solid var(--color-border-secondary);
            transition: transform .2s ease, box-shadow .2s ease;
        }
        .session-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--color-shadow);
        }
        .session-stat .num { 
            font-size: 2.2rem; 
            font-weight: 600; 
            color: var(--color-text-dark); 
        }
        .session-stat .label { 
            font-size: .85rem; 
            color: var(--color-text-muted); 
            margin-top: .25rem; 
        }
        .session-actions {
            display: flex;
            gap: .75rem;
            justify-content: center;
        }

        /* ===== WELCOME PAGE ===== */
        /* Shown before starting a study session */
        .welcome-page { 
            background: var(--color-elevation-1); 
            border-radius: 20px; 
            padding: 3rem; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 400px; 
            box-shadow: 0 4px 20px var(--color-shadow); 
            text-align: center;
            border: 1px solid var(--color-border-secondary);
            transition: box-shadow .3s ease, transform .3s ease;
        }
        .welcome-page:hover {
            box-shadow: 0 6px 28px var(--color-shadow-dark);
        }
        .welcome-page h1 { font-size: 2rem; margin-bottom: 2rem; color: var(--color-text-dark); }
        .welcome-form { width: 100%; max-width: 360px; }
        .welcome-form label { 
            display: block; 
            text-align: left; 
            font-size: .85rem; 
            color: var(--color-text-muted); 
            margin-bottom: .25rem; 
        }
        .welcome-form select { 
            width: 100%; 
            padding: .875rem; 
            border: 1px solid var(--color-border-primary); 
            border-radius: 10px; 
            font: inherit; 
            font-size: 1.2rem; 
            margin-bottom: 1.5rem; 
            background: var(--color-elevation-2); 
            color: var(--color-text-primary);
        }
        .welcome-form button { 
            width: 100%; 
            padding: 1rem; 
            background: var(--color-success); 
            color: var(--color-bg-secondary); 
            border: none; 
            border-radius: 10px; 
            font: inherit; 
            font-size: 1.2rem; 
            font-weight: 500; 
            cursor: pointer; 
        }
        .welcome-form button:hover { background: var(--color-success-text); }
        .welcome-form button:disabled { 
            background: var(--color-border-primary); 
            color: var(--color-text-light);
            cursor: not-allowed; 
        }

        /* ===== BUTTON STYLES ===== */
        button { 
            background: var(--color-elevation-2); 
            border: 1px solid var(--color-border-primary); 
            color: var(--color-text-primary); 
            padding: .7rem 1.4rem; 
            border-radius: 8px; 
            font: inherit; 
            font-size: 1.05rem; 
            cursor: pointer; 
            transition: background-color .2s ease, border-color .2s ease, transform .15s ease, box-shadow .2s ease; 
        }
        button:hover { 
            background: var(--color-elevation-3); 
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--color-shadow);
        }
        button:active { 
            background: var(--color-active);
            transform: translateY(0);
            box-shadow: none;
        }
        button:focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
        }
        
        /* Primary action button (sage green) */
        .btn-primary { 
            background: var(--color-success); 
            border-color: var(--color-success); 
            color: var(--color-bg-secondary); 
        }
        .btn-primary:hover { background: var(--color-success-text); }
        
        /* Danger button (muted red) */
        .btn-danger { 
            color: var(--color-error); 
            border-color: var(--color-error-light); 
            background: var(--color-error-pale); 
        }
        .btn-danger:hover { background: rgba(166, 92, 92, 0.25); }
        
        /* Success button (sage green) */
        button.btn-success { 
            background: var(--color-success); 
            border-color: var(--color-success); 
            color: var(--color-bg-secondary); 
        }
        button.btn-success:hover { background: var(--color-success-text); }

        /* ===== SIDEBAR (Right Column) ===== */
        .sidebar { 
            display: flex; 
            flex-direction: column; 
            gap: 1.25rem; 
        }

        /* Header card: Language selector + stats */
        .sidebar-header { 
            background: var(--color-elevation-1); 
            border-radius: 16px; 
            padding: 1.5rem; 
            box-shadow: 0 4px 20px var(--color-shadow); 
            border: 1px solid var(--color-border-secondary);
            transition: box-shadow .3s ease;
        }
        .sidebar-header:hover {
            box-shadow: 0 6px 24px var(--color-shadow-dark);
        }
        .lang-section { 
            display: flex; 
            align-items: center; 
            gap: .75rem; 
            margin-bottom: 1rem; 
        }
        /* Sage green gradient icon for language */
        .lang-icon { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, var(--color-success), var(--color-success-light)); 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.2rem; 
        }
        .lang-select-wrap { flex: 1; }
        .lang-select { 
            width: 100%; 
            padding: .5rem .75rem; 
            border-radius: 8px; 
            border: 1px solid var(--color-border-primary); 
            background: var(--color-elevation-2); 
            color: var(--color-text-primary);
            font: inherit; 
            font-size: .95rem; 
            cursor: pointer; 
            transition: all .2s; 
        }
        .lang-select:hover { 
            border-color: var(--color-success); 
            background: var(--color-elevation-1);
        }
        .lang-actions { display: flex; gap: .25rem; }
        .lang-actions button { 
            padding: .4rem .5rem; 
            font-size: .85rem; 
            background: transparent; 
            border: none; 
            border-radius: 6px; 
            opacity: .6; 
        }
        .lang-actions button:hover { opacity: 1; background: var(--color-elevation-3); }

        /* Stats pills: Due, Learning, Mastered, Accuracy */
        .stats-row { 
            display: flex; 
            gap: .5rem; 
            flex-wrap: wrap; 
        }
        .stat-pill { 
            display: flex; 
            align-items: center; 
            gap: .4rem; 
            padding: .5rem .75rem; 
            background: var(--color-elevation-2); 
            border-radius: 20px; 
            font-size: .9rem;
            transition: transform .15s ease, background-color .15s ease;
        }
        .stat-pill:hover {
            transform: scale(1.02);
            background: var(--color-elevation-3);
        }
        .stat-pill .icon { font-size: .95rem; }
        .stat-pill .num { font-weight: 600; color: var(--color-text-dark); }
        .stat-pill .label { color: var(--color-text-muted); font-size: .8rem; }
        /* Orange pill for due cards */
        .stat-pill.due { background: rgba(230, 126, 34, 0.15); }
        .stat-pill.due .num { color: var(--color-progress-orange); }
        /* Green pill for mastered cards */
        .stat-pill.mastered { background: var(--color-success-bg); }
        .stat-pill.mastered .num { color: var(--color-success); }

        /* Data management card (Export/Import/Clear) */
        .data-card { 
            background: var(--color-elevation-1); 
            border-radius: 16px; 
            padding: 1.25rem; 
            box-shadow: 0 4px 20px var(--color-shadow); 
            border: 1px solid var(--color-border-secondary);
            transition: box-shadow .3s ease;
        }
        .data-card:hover {
            box-shadow: 0 6px 24px var(--color-shadow-dark);
        }
        .data-title { 
            font-size: .75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--color-text-muted); 
            margin-bottom: .75rem; 
            font-weight: 600; 
        }
        .data-btns { display: flex; gap: .5rem; }
        .data-btns button { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: .4rem; 
            padding: .6rem; 
            font-size: .85rem; 
            background: var(--color-elevation-2); 
            border: 1px solid transparent; 
            border-radius: 8px;
            transition: background-color .2s ease, transform .1s ease;
        }
        .data-btns button:hover { 
            background: var(--color-elevation-3); 
            transform: translateY(-1px);
        }
        .data-btns button:active {
            background: var(--color-active);
            transform: translateY(0);
        }
        .data-btns button.danger { color: var(--color-error); }
        .data-btns button.danger:hover { 
            background: var(--color-error-pale); 
            border-color: var(--color-error-light); 
        }

        /* Words list card (scrollable list of all cards) */
        .words-card { 
            background: var(--color-elevation-1); 
            border-radius: 16px; 
            padding: 1.25rem; 
            box-shadow: 0 4px 20px var(--color-shadow); 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            min-height: 0; 
            border: 1px solid var(--color-border-secondary);
            transition: box-shadow .3s ease;
        }
        .words-card:hover {
            box-shadow: 0 6px 24px var(--color-shadow-dark);
        }
        .words-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: .75rem; 
        }
        .words-title { 
            font-size: .75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--color-text-muted); 
            font-weight: 600; 
        }
        .words-title span { color: var(--color-text-dark); font-weight: 600; margin-left: .25rem; }
        
        /* Search Box */
        .words-search {
            position: relative;
            margin-bottom: .75rem;
        }
        .words-search .search-icon {
            position: absolute;
            left: .75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: .9rem;
            opacity: 0.5;
            color: var(--color-text-muted);
        }
        .words-search input {
            width: 100%;
            padding: .5rem .75rem .5rem 2.25rem;
            border: 1px solid var(--color-border-secondary);
            border-radius: 10px;
            font-size: .9rem;
            background: var(--color-elevation-2);
            color: var(--color-text-primary);
            transition: all .2s;
        }
        .words-search input:focus {
            outline: none;
            border-color: var(--color-success);
            background: var(--color-elevation-1);
        }
        .words-search input::placeholder {
            color: var(--color-text-light);
        }
        .words-search .clear-search {
            position: absolute;
            right: .5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: .25rem;
            font-size: .8rem;
            cursor: pointer;
            opacity: 0.5;
        }
        .words-search .clear-search:hover {
            opacity: 1;
        }
        
        /* Filter Tabs */
        .words-tabs {
            display: flex;
            gap: .25rem;
            margin-bottom: .75rem;
            padding-bottom: .5rem;
            border-bottom: 1px solid var(--color-border-secondary);
            overflow-x: auto;
        }
        .words-tab {
            padding: .4rem .75rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: .85rem;
            color: var(--color-text-muted);
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: .4rem;
            transition: background-color .15s ease, color .15s ease, transform .1s ease;
        }
        .words-tab:hover {
            background: var(--color-hover-subtle);
            color: var(--color-text-primary);
        }
        .words-tab:active {
            background: var(--color-active);
            transform: scale(0.97);
        }
        .words-tab.active {
            background: var(--color-success);
            color: var(--color-elevation-1);
            box-shadow: 0 2px 6px rgba(107, 142, 107, 0.3);
        }
        .tab-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .tab-dot.due { background: var(--color-progress-orange); }
        .tab-dot.learning { background: var(--color-success); }
        .tab-dot.mastered { background: var(--color-success); }
        .words-tab.active .tab-dot.due { background: var(--color-bg-secondary); }
        .words-tab.active .tab-dot.learning { background: var(--color-bg-secondary); }
        .words-tab.active .tab-dot.mastered { background: var(--color-bg-secondary); }
        .sort-select { 
            font-size: .85rem; 
            padding: .35rem .6rem; 
            border-radius: 8px; 
            border: 1px solid var(--color-border-primary); 
            background: var(--color-elevation-2);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: border-color .2s ease, background-color .2s ease;
        }
        .sort-select:hover { 
            border-color: var(--color-success); 
            background: var(--color-elevation-1);
        }
        .sort-select:focus {
            outline: none;
            border-color: var(--color-success);
            box-shadow: 0 0 0 3px var(--color-focus-bg);
        }
        
        /* Sage green "Add Card" button */
        .btn-add-card { 
            display: flex; 
            align-items: center; 
            gap: .3rem; 
            padding: .4rem .75rem; 
            background: var(--color-success); 
            color: var(--color-bg-secondary); 
            border: none; 
            border-radius: 8px; 
            font-size: .85rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all .2s; 
        }
        .btn-add-card:hover { 
            background: var(--color-success-text); 
            transform: translateY(-1px); 
        }

        /* Scrollable list of vocabulary cards */
        .words-list { 
            flex: 1; 
            overflow-y: auto; /* Scroll if too many cards */
            min-height: 0; 
            margin: 0 -.25rem; 
            padding: 0 .25rem; 
        }
        
        /* Individual card row in the list */
        .word-item { 
            display: flex; 
            align-items: center; 
            padding: .6rem .5rem; 
            border-radius: 10px; 
            gap: .75rem; 
            transition: background-color .15s ease, transform .1s ease; 
        }
        .word-item:hover { 
            background: var(--color-hover-subtle); 
        }
        .word-item:active {
            background: var(--color-active);
            transform: scale(0.995);
        }
        
        /* Status dot: orange=due, green=mastered, gray=new */
        .word-status { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            flex-shrink: 0; 
        }
        .word-status.due { 
            background: var(--color-progress-orange); 
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.15); 
        }
        .word-status.ok { background: var(--color-success); }
        .word-status.new { background: var(--color-text-light); }
        
        .word-info { flex: 1; min-width: 0; }
        .word-name { 
            font-weight: 500; 
            font-size: 1rem; 
            color: var(--color-text-dark); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .word-meta { 
            font-size: .75rem; 
            color: var(--color-text-muted); 
            margin-top: .15rem;
            display: flex;
            align-items: center;
            gap: .4rem;
        }
        
        /* Stage Progress Dots */
        .stage-dots {
            display: flex;
            gap: 3px;
        }
        .stage-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--color-border-secondary);
        }
        .stage-dot.filled {
            background: var(--color-success);
        }
        .mastered-badge {
            font-size: .7rem;
        }
        
        /* Difficulty Indicator */
        .difficulty {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-left: .2rem;
        }
        .difficulty.easy { background: var(--color-success); }
        .difficulty.medium { background: var(--color-progress-orange); }
        .difficulty.hard { background: var(--color-error); }
        
        /* Next Review Badge */
        .next-review-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: var(--color-success-bg);
            color: var(--color-success);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        
        /* Card Item Clickable */
        .word-item {
            cursor: pointer;
        }
        
        /* Next Review Badge (right side of word item) */
        .word-next-review-wrap {
            margin-left: auto;
            padding-right: 0.5rem;
        }
        .word-next-review {
            font-size: .75rem;
            font-weight: 500;
            color: var(--color-success);
            background: var(--color-success-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            white-space: nowrap;
        }
        .word-next-review.due {
            color: var(--color-progress-orange);
            background: rgba(230, 126, 34, 0.15);
        }
        .word-next-review.new {
            color: var(--color-text-muted);
            background: var(--color-elevation-2);
        }
        
        /* Edit/Delete buttons appear on hover */
        .word-actions { 
            display: flex; 
            gap: .25rem; 
            opacity: 0; 
            transition: opacity .15s; 
        }
        .word-item:hover .word-actions { opacity: 1; }
        .word-actions button { 
            padding: .35rem .5rem; 
            font-size: .75rem; 
            background: transparent; 
            border: none; 
            border-radius: 6px; 
            opacity: .6; 
            cursor: pointer;
        }
        .word-actions button:hover { opacity: 1; background: var(--color-elevation-3); }
        .word-actions button.danger { color: var(--color-error); }
        .word-actions button.danger:hover { background: var(--color-error-pale); }

        /* Empty state when no cards exist */
        .words-empty { 
            text-align: center; 
            padding: 2rem 1rem; 
            color: var(--color-text-muted); 
            font-size: .9rem; 
        }
        .words-empty .icon { font-size: 2rem; margin-bottom: .5rem; opacity: .5; }

        /* Add language form (hidden by default) */
        .lang-form { 
            display: none; 
            margin-top: .75rem; 
            padding: .75rem; 
            background: var(--color-elevation-2); 
            border-radius: 10px; 
            border: 1px solid var(--color-border-secondary);
        }
        .lang-form.show { 
            display: block; 
            animation: slideDown .2s ease; 
        }
        .lang-form input { 
            width: 100%; 
            padding: .5rem .75rem; 
            margin-bottom: .4rem; 
            border: 1px solid var(--color-border-primary); 
            border-radius: 8px; 
            font: inherit; 
            font-size: .9rem; 
            background: var(--color-elevation-1);
            color: var(--color-text-primary);
        }
        .lang-form-btns { 
            display: flex; 
            gap: .4rem; 
            justify-content: flex-end; 
        }
        .lang-form-btns button { font-size: .85rem; padding: .4rem .75rem; }

        /* ===== RESPONSIVE STYLES (Large Screens) ===== */
        @media (min-width: 1920px) {
            .container { 
                max-width: 1800px; 
                grid-template-columns: 1fr 480px; 
                gap: 4rem; 
            }
            .sentence { font-size: 2.6rem; max-width: 1000px; }
            .hint { font-size: 1.4rem; }
            input[type="text"] { width: 450px; font-size: 1.6rem; }
            .study-panel { min-height: 600px; }
        }

        /* Hide file input (triggered by button) */
        input[type="file"] { display: none; }

        /* Shake animation for wrong answers */
        .shake { animation: shake 0.5s ease; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        /* ===== IMAGE PANEL (Bottom) ===== */
        /* Fixed bottom panel showing Bing image search results */
        .image-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-elevation-2);
            border-top: 1px solid var(--color-border-primary);
            box-shadow: 0 -4px 20px var(--color-shadow);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform .3s ease;
            height: 380px;
            display: flex;
            flex-direction: column;
        }
        .image-panel.show {
            transform: translateY(0);
        }
        
        .image-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .5rem 1rem;
            border-bottom: 1px solid var(--color-border-secondary);
            background: var(--color-elevation-2);
            flex-shrink: 0;
        }
        .image-panel-title {
            font-size: .85rem;
            font-weight: 600;
            color: var(--color-text-dark);
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .image-panel-title .word {
            color: var(--color-success);
        }
        .image-panel-actions {
            display: flex;
            gap: .5rem;
        }
        .image-panel-actions button {
            padding: .35rem .75rem;
            font-size: .8rem;
            background: var(--color-elevation-1);
            border: 1px solid var(--color-border-primary);
            border-radius: 6px;
            cursor: pointer;
            color: var(--color-text-primary);
        }
        .image-panel-actions button:hover {
            background: var(--color-elevation-3);
        }
        .image-panel-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: var(--color-elevation-1);
            border: 1px solid var(--color-border-primary);
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px var(--color-shadow);
            color: var(--color-text-primary);
        }
        .image-panel-close-btn:hover {
            background: var(--color-elevation-3);
        }
        .image-panel-link-btn {
            position: absolute;
            top: 8px;
            right: 48px;
            width: 32px;
            height: 32px;
            background: var(--color-elevation-1);
            border: 1px solid var(--color-border-primary);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px var(--color-shadow);
            color: var(--color-text-primary);
        }
        .image-panel-link-btn:hover {
            background: var(--color-elevation-3);
        }
        
        .image-panel-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--color-elevation-2);
        }
        
        .bing-iframe {
            width: 100%;
            height: 100%;
            border: none;
            margin-top: -60px; /* Hide Bing header */
            height: calc(100% + 60px);
        }
        
        /* Adjust container when image panel is visible */
        body.image-panel-open {
            padding-bottom: 380px;
        }
        body.image-panel-open .study-panel {
            max-height: calc(100vh - 430px);
        }
        
        body.image-panel-open .container {
            padding-bottom: 1rem;
        }
    </style>
</head>
<body>



<!-- ===== TOP BAR (Top Right) ===== -->
<!-- Shows count of due cards and focus mode toggle -->
<div class="top-bar">
    <span><strong id="dueCount">0</strong> due</span>
    <button class="focus-btn" onclick="toggleFocus()" title="Toggle sidebar" id="focusBtn">‚ò∞</button>
</div>

<!-- ===== MAIN CONTAINER ===== -->
<!-- Grid layout: study panel + sidebar -->
<div class="container">
    
    <!-- ===== MAIN STUDY AREA ===== -->
    <main class="study-panel" id="studyPanel">
        
        <!-- WELCOME PAGE: Shown when no cards are due -->
        <div class="welcome-page" id="welcomePage">
            <h1>Flashcards</h1>
            <div class="welcome-form">
                <label>Language</label>
                <select id="welcomeLangSelect" onchange="changeWelcomeLang()">
                    <option value="en">English</option>
                </select>
                
                <p style="color: var(--color-text-muted); margin: 1.5rem 0; font-size: 1rem;">
                    <span id="welcomeDue">0</span> cards due for review
                </p>
                
                <button id="startBtn" onclick="startStudying()" disabled>No Cards Due</button>
            </div>
        </div>

        <!-- STUDY INTERFACE: Shown when studying -->
        <div id="studyInterface" style="display: none; width: 100%; text-align: center;">
            
            <!-- Daily Progress Bar (at top of study panel) -->
            <div class="daily-progress-bar-container" id="dailyProgressContainer">
                <div class="daily-progress-bar">
                    <div class="daily-progress-fill" id="dailyProgressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Main sentence with hidden word -->
            <p class="sentence" id="sentence"></p>
            
            <!-- Definition hint with first letter revealed -->
            <p class="hint" id="hint"></p>
            
            <!-- Answer input field -->
            <div class="input-wrap">
                <input type="text" id="answer" autocomplete="off">
            </div>
            
            <!-- Feedback message area -->
            <p class="msg" id="msg"></p>
            
            <!-- Quick edit/delete for current card -->
            <div class="study-actions" id="studyActions">
                <button onclick="editCurrentCard()" title="Edit">‚úèÔ∏è</button>
                <button class="btn-delete" onclick="deleteCurrentCard()" title="Delete">üóëÔ∏è</button>
            </div>
            
            <!-- EDIT MODAL: Popup to edit the current card -->
            <div class="modal-overlay" id="editModal" onclick="if(event.target===this)closeEditModal()">
                <div class="modal">
                    <h3>Edit Card</h3>
                    <div class="form-group">
                        <label>Word</label>
                        <input type="text" id="editWord" oninput="validateEdit()">
                    </div>
                    <div class="form-group">
                        <label>Definition</label>
                        <input type="text" id="editDef">
                    </div>
                    <div class="form-group">
                        <label>Sentence (include the word)</label>
                        <textarea id="editSent" oninput="validateEdit()"></textarea>
                        <p class="error" id="editError">Include the word in your sentence</p>
                        <div class="preview" id="editPreview"></div>
                    </div>
                    <div class="modal-btns">
                        <button onclick="closeEditModal()">Cancel</button>
                        <button class="btn-primary" onclick="saveEdit()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ===== SIDEBAR (Right Column) ===== -->
    <aside class="sidebar">
        
        <!-- LANGUAGE SELECTOR & STATS -->
        <div class="sidebar-header">
            <div class="lang-section">
                <div class="lang-icon">üåê</div>
                <div class="lang-select-wrap">
                    <select class="lang-select" id="langSelect" onchange="switchLang()">
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="lang-actions">
                    <button onclick="toggleLangForm()" title="Add language">+</button>
                    <button onclick="renameLang()" title="Rename">‚úé</button>
                </div>
            </div>
            
            <!-- Hidden form to add new language -->
            <div class="lang-form" id="langForm">
                <input id="newLangName" placeholder="Language name (e.g., Spanish)">
                <input id="newLangCode" placeholder="Code (e.g., es)">
                <div class="lang-form-btns">
                    <button onclick="cancelLangForm()">Cancel</button>
                    <button class="btn-primary" onclick="addLang()">Add</button>
                </div>
            </div>
            
            <!-- Stats pills row -->
            <div class="stats-row">
                <div class="stat-pill due">
                    <span class="icon">‚è∞</span>
                    <span class="num" id="statDue">0</span>
                    <span class="label">due</span>
                </div>
                <div class="stat-pill">
                    <span class="icon">üìö</span>
                    <span class="num" id="statLearning">0</span>
                    <span class="label">learning</span>
                </div>
                <div class="stat-pill mastered">
                    <span class="icon">‚≠ê</span>
                    <span class="num" id="statMastered">0</span>
                    <span class="label">mastered</span>
                </div>
                <div class="stat-pill">
                    <span class="icon">üéØ</span>
                    <span class="num" id="statAccuracy">0%</span>
                    <span class="label">accuracy</span>
                </div>
            </div>
        </div>

        <!-- DATA MANAGEMENT CARD -->
        <div class="data-card">
            <div class="data-title">Data</div>
            <div class="data-btns">
                <button onclick="exp()">
                    <span>üì§</span> Export
                </button>
                <button onclick="imp.click()">
                    <span>üì•</span> Import
                </button>
                <button class="danger" onclick="clearWords()">
                    <span>üóëÔ∏è</span> Clear
                </button>
            </div>
            <!-- Hidden file input for import -->
            <input type="file" id="imp" accept=".json" onchange="handleImport(this)">
        </div>

        <!-- VOCABULARY LIST CARD -->
        <div class="words-card">
            <div class="words-header">
                <div class="words-title">Cards <span id="langCount">0</span></div>
                <div style="display: flex; gap: .5rem; align-items: center;">
                    <button class="btn-add-card" onclick="openAddModal()" title="Add new card">
                        <span>‚ûï</span> Add
                    </button>
                    <select class="sort-select" id="sortSelect" onchange="renderList()">
                        <option value="due">‚è∞ Due First</option>
                        <option value="word">üî§ A-Z</option>
                        <option value="za">üî• Z-A</option>
                        <option value="stage">üìö Stage</option>
                        <option value="accuracy-high">üéØ Best Recall</option>
                        <option value="accuracy-low">üö® Needs Practice</option>
                        <option value="most-reviewed">üìñ Most Studied</option>
                        <option value="least-reviewed">üìï Least Studied</option>
                        <option value="recent">üîî Recently Added</option>
                        <option value="oldest">üìÖ Oldest First</option>
                        <option value="hardest-ef">ü§¢ Hardest (EF)</option>
                        <option value="easiest-ef">üòå Easiest (EF)</option>
                        <option value="longest-interval">üß† Longest Interval</option>
                        <option value="random">üé≤ Random</option>
                    </select>
                </div>
            </div>
            
            <!-- Search Box -->
            <div class="words-search">
                <span class="search-icon">üîç</span>
                <input type="text" id="wordsSearch" placeholder="Search cards..." oninput="renderList()">
                <button class="clear-search" id="clearSearch" onclick="clearWordsSearch()" style="display: none;">‚úï</button>
            </div>
            
            <!-- Filter Tabs -->
            <div class="words-tabs">
                <button class="words-tab active" data-filter="all" onclick="setWordsFilter('all')">
                    All
                </button>
                <button class="words-tab" data-filter="due" onclick="setWordsFilter('due')">
                    <span class="tab-dot due"></span>Due
                </button>
                <button class="words-tab" data-filter="learning" onclick="setWordsFilter('learning')">
                    <span class="tab-dot learning"></span>Learning
                </button>
                <button class="words-tab" data-filter="mastered" onclick="setWordsFilter('mastered')">
                    <span class="tab-dot mastered"></span>Mastered
                </button>
            </div>
            
            <!-- Scrollable list container -->
            <div class="words-list" id="wordsList"></div>
        </div>
    </aside>

    <!-- CARD PREVIEW MODAL: Quick view without editing -->
    <div class="modal-overlay" id="previewModal" onclick="if(event.target===this)closePreviewModal()">
        <div class="modal preview-modal">
            <div class="preview-word" id="previewWord"></div>
            <div class="preview-def" id="previewDef"></div>
            <div class="preview-sentence" id="previewSentence"></div>
            <div class="preview-meta" id="previewMeta"></div>
            <div class="modal-btns">
                <button onclick="closePreviewModal()">Close</button>
                <button class="btn-primary" onclick="editFromPreview()">Edit Card</button>
            </div>
        </div>
    </div>

    <!-- ADD CARD MODAL: Popup to create new flashcards -->
    <div class="modal-overlay" id="addModal" onclick="if(event.target===this)closeAddModal()">
        <div class="modal">
            <h3>Add New Card</h3>
            <div class="form-group">
                <label>Word</label>
                <input type="text" id="aWord" placeholder="e.g., elephant" oninput="validateAddForm()">
            </div>
            <div class="form-group">
                <label>Definition (hint)</label>
                <input type="text" id="aDef" placeholder="e.g., a large animal with a trunk">
            </div>
            <div class="form-group">
                <label>Sentence (include the word)</label>
                <textarea id="aSent" placeholder="e.g., The elephant sprayed water with its trunk." oninput="validateAddForm()"></textarea>
                <p class="error" id="addError">Include the word in your sentence</p>
                <div class="preview" id="addPreview"></div>
            </div>
            <div class="modal-btns">
                <button onclick="closeAddModal()">Cancel</button>
                <button class="btn-primary" onclick="saveCard()">Save Card</button>
            </div>
        </div>
    </div>
</div>

<!-- ===== IMAGE PANEL (Bottom) ===== -->
<div class="image-panel" id="imagePanel">
    <button class="image-panel-close-btn" onclick="toggleImagePanel()" title="Close">√ó</button>
    <button class="image-panel-link-btn" onclick="openBingSearch()" title="Open in Bing">üîó</button>
    <div class="image-panel-content">
        <iframe class="bing-iframe" id="bingIframe" sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
    </div>
</div>

<script>
// ===== DOM ELEMENT REFERENCES =====
// Cache frequently accessed elements for better performance
const sentence = document.getElementById('sentence');
const hint = document.getElementById('hint');
const answer = document.getElementById('answer');
const msg = document.getElementById('msg');

// ===== DATA STORAGE =====
// Load cards from localStorage, or use default starter cards
let cards = JSON.parse(localStorage.cards || 'null') || [
    {w:'apple', s:'She took a bite of the crisp red apple.', d:'a round fruit', lang:'en', addedAt: Date.now() - 86400000 * 3},
    {w:'banana', s:'The monkey peeled the banana before eating.', d:'a long curved yellow fruit', lang:'en', addedAt: Date.now() - 86400000 * 2},
    {w:'door', s:'Please close the door behind you.', d:'a barrier for an entrance', lang:'en', addedAt: Date.now() - 86400000}
], cur, editIdx = -1, answerStartTime = 0;

// Languages list with current selection
let languages = JSON.parse(localStorage.languages || 'null') || [{code: 'en', name: 'English'}];
let currentLang = localStorage.currentLang || 'en';

// ===== DAILY STUDY TRACKING =====
// Daily goal: 50 words per language
const DAILY_GOAL = 50;

// Load daily progress from localStorage
// Structure: { '2024-01-15': { 'en': 23, 'es': 15, ... } }
function getDailyProgress() {
    const today = new Date().toISOString().split('T')[0];
    const stored = JSON.parse(localStorage.dailyProgress || '{}');
    
    // Check if we need to reset (new day)
    const lastStudyDate = localStorage.lastStudyDate;
    if (lastStudyDate !== today) {
        // It's a new day, reset progress
        localStorage.lastStudyDate = today;
        return {};
    }
    
    return stored[today] || {};
}

function saveDailyProgress(progress) {
    const today = new Date().toISOString().split('T')[0];
    const stored = JSON.parse(localStorage.dailyProgress || '{}');
    stored[today] = progress;
    localStorage.dailyProgress = JSON.stringify(stored);
    localStorage.lastStudyDate = today;
}

// Get today's count for current language
function getTodayCount() {
    const progress = getDailyProgress();
    return progress[currentLang] || 0;
}

// Increment today's count for current language
function incrementTodayCount() {
    const progress = getDailyProgress();
    progress[currentLang] = (progress[currentLang] || 0) + 1;
    saveDailyProgress(progress);
    updateDailyProgressUI();
}

// Check if daily goal is reached for current language
function isDailyGoalReached() {
    return getTodayCount() >= DAILY_GOAL;
}

// Update the daily progress UI
function updateDailyProgressUI() {
    const count = getTodayCount();
    const percentage = Math.min((count / DAILY_GOAL) * 100, 100);
    
    const fill = document.getElementById('dailyProgressFill');
    fill.style.width = percentage + '%';
    
    if (count >= DAILY_GOAL) {
        fill.classList.add('complete');
    } else {
        fill.classList.remove('complete');
    }
}

// ===== STUDY STATE =====
let isStudying = false;         // Is study mode active?
let waitingForNext = false;     // Waiting for Enter key to proceed?
let lastAnswerWrong = false;    // Was the last answer incorrect?

// ===== HELPER FUNCTIONS =====

// Save cards to localStorage (persist data)
const save = () => localStorage.cards = JSON.stringify(cards);

// Save language settings
const saveLangs = () => localStorage.languages = JSON.stringify(languages);
const saveCurrentLang = () => localStorage.currentLang = currentLang;

// Get cards that are due for review in current language
const dueCards = () => cards.filter(c => (c.due||0) <= Date.now() && (c.lang || 'en') === currentLang);

// Get all cards for current language
const currentLangCards = () => cards.filter(c => (c.lang || 'en') === currentLang);

// Find index of a card in the main array (for editing/deleting)
const findCardIndex = (card) => cards.findIndex(c => c.w === card.w && c.s === card.s && c.lang === card.lang);

// Remove a card from the study queue (when deleted)
const removeCardFromStudy = (card) => {
    // Card removed from main cards array, nothing to do here
};

// Escape special regex characters for safe matching
function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Validate that a sentence contains the target word
 * Shows error if missing, shows preview with word hidden if valid
 * @param {string} word - The word that should appear
 * @param {string} sentence - The sentence to check
 * @param {string} errorId - ID of error message element
 * @param {string} previewId - ID of preview element
 * @returns {boolean} - True if valid
 */
function validateSentence(word, sentence, errorId, previewId) {
    const errorEl = document.getElementById(errorId);
    const previewEl = document.getElementById(previewId);
    
    if (word && sentence) {
        if (sentence.toLowerCase().includes(word.toLowerCase())) {
            errorEl?.classList.remove('show');
            previewEl?.classList.add('show');
            if (previewEl) {
                // Show preview with word replaced by ___
                previewEl.innerHTML = sentence.replace(new RegExp('(' + escapeRegex(word) + ')', 'gi'), '<strong>___</strong>');
            }
            return true;
        } else {
            errorEl?.classList.add('show');
            previewEl?.classList.remove('show');
            return false;
        }
    } else {
        errorEl?.classList.remove('show');
        previewEl?.classList.remove('show');
        return false;
    }
}

/**
 * Calculate Levenshtein distance between two strings
 * Used for fuzzy matching (detecting typos)
 * Returns number of character edits needed to transform a into b
 */
function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array.from({length: m + 1}, () => Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            dp[i][j] = a[i-1] === b[j-1] ? dp[i-1][j-1] : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
        }
    }
    return dp[m][n];
}

/**
 * Calculate response quality (0-5) based on accuracy and speed
 * 5 = Perfect, fast (< 3 sec)
 * 4 = Perfect, normal (3-8 sec)
 * 3 = Perfect, slow (> 8 sec)
 * 2 = Minor typo (80%+ similar)
 * 1 = Major mistake (50%+ similar)
 * 0 = Complete miss (< 50% similar)
 */
function calculateQuality(userAnswer, correctAnswer, responseTimeMs) {
    const ua = userAnswer.trim().toLowerCase();
    const ca = correctAnswer.toLowerCase();
    const isCorrect = ua === ca;
    const distance = levenshtein(ua, ca);
    const similarity = 1 - distance / Math.max(ca.length, 1);
    const seconds = responseTimeMs / 1000;

    if (isCorrect) {
        return seconds < 3 ? 5 : seconds < 8 ? 4 : 3;
    }
    return similarity >= 0.8 ? 2 : similarity >= 0.5 ? 1 : 0;
}

/**
 * SM-2 Spaced Repetition Algorithm
 * This is the core algorithm that schedules when cards appear again
 * 
 * How it works:
 * - EF (Ease Factor): How easy the card is (starts at 2.5, min 1.3)
 * - n: Number of successful reviews in a row
 * - Interval: Minutes until next review
 * 
 * Intervals: 1min ‚Üí 10min ‚Üí 1day ‚Üí 6days ‚Üí EF multiplier
 * Wrong answers reset to 1 minute
 */
function sm2(card, quality) {
    // Initialize card properties if new
    if (card.ef === undefined) card.ef = 2.5;
    if (card.n === undefined) card.n = 0;

    // Update ease factor based on performance
    const qDiff = 5 - quality;
    card.ef = Math.max(1.3, card.ef + (0.1 - qDiff * (0.08 + qDiff * 0.02)));

    // Calculate next interval (in minutes)
    let intervalMins;
    if (quality < 3) {
        // Failed - reset to beginning
        card.n = 0;
        intervalMins = 1;
    } else {
        // Passed - increase interval
        if (card.n === 0) intervalMins = 1;
        else if (card.n === 1) intervalMins = 10;
        else if (card.n === 2) intervalMins = 1440;      // 1 day
        else if (card.n === 3) intervalMins = 6 * 1440;  // 6 days
        else intervalMins = Math.round((card.int || 1440) * card.ef);
        card.n++;
    }

    // Cap at 1 year (525600 minutes)
    card.int = Math.min(intervalMins, 525600);
    // Schedule due date
    card.due = Date.now() + card.int * 60000;
    return quality >= 3;
}

/**
 * Toggle focus mode (hide sidebar for distraction-free studying)
 * Saves preference to localStorage
 */
function toggleFocus() {
    const container = document.querySelector('.container');
    const focusBtn = document.getElementById('focusBtn');
    const isFocus = container.classList.toggle('focus-mode');
    focusBtn.textContent = isFocus ? '‚óß' : '‚ò∞';
    localStorage.focusMode = isFocus;
}

// Restore focus mode on page load
if (localStorage.focusMode === 'true') {
    document.querySelector('.container').classList.add('focus-mode');
    document.getElementById('focusBtn').textContent = '‚óß';
}

// ===== WELCOME PAGE FUNCTIONS =====

// Update the "X due" count on welcome screen
function updateWelcomeStats() {
    const due = dueCards().length;
    const todayCount = getTodayCount();
    document.getElementById('welcomeDue').textContent = due;
    const startBtn = document.getElementById('startBtn');
    
    // Check if daily goal is already reached
    if (todayCount >= DAILY_GOAL) {
        startBtn.disabled = false;
        if (due > 0) {
            startBtn.textContent = `Continue Studying (${due} more due)`;
            startBtn.style.background = 'var(--color-success)';
        } else {
            startBtn.textContent = `Daily Goal Reached (${todayCount}/${DAILY_GOAL})`;
            startBtn.style.background = 'var(--color-success)';
        }
    } else if (due === 0) {
        startBtn.disabled = true;
        startBtn.textContent = 'No Cards Due';
        startBtn.style.background = '';
    } else {
        startBtn.disabled = false;
        const remaining = Math.min(due, DAILY_GOAL - todayCount);
        startBtn.textContent = `Start Studying (${remaining} for daily goal)`;
        startBtn.style.background = '';
    }
}

// Populate language dropdown on welcome page
function updateWelcomeLangSelect() {
    const select = document.getElementById('welcomeLangSelect');
    select.innerHTML = languages.map(l => `<option value="${l.code}"${l.code === currentLang ? ' selected' : ''}>${l.name}</option>`).join('');
}

// When language changes on welcome page
function changeWelcomeLang() {
    currentLang = document.getElementById('welcomeLangSelect').value;
    saveCurrentLang();
    renderLangSelect();
    updateDailyProgressUI();
    updateWelcomeStats();
    updateStats();
    renderList();
}

// ===== STUDY MANAGEMENT =====

/**
 * Start studying - shows due cards based purely on SRS
 * Allows studying even if daily goal reached
 */
function startStudying() {
    const due = dueCards();
    if (due.length === 0) return;
    
    document.getElementById('welcomePage').style.display = 'none';
    document.getElementById('studyInterface').style.display = '';
    document.getElementById('dailyProgressContainer').classList.add('show');
    
    // Reset study state
    isStudying = true;
    waitingForNext = false;
    lastAnswerWrong = false;
    
    show();
}

// Return to welcome page, ending study
function returnToWelcome() {
    isStudying = false;
    waitingForNext = false;
    lastAnswerWrong = false;
    
    document.getElementById('studyInterface').style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    document.getElementById('dailyProgressContainer').classList.remove('show');
    document.getElementById('welcomePage').style.display = '';
    document.getElementById('msg').innerHTML = '';
    
    updateWelcomeStats();
    updateStats();
}

// ===== LANGUAGE MANAGEMENT =====

// Update language dropdown in sidebar
function renderLangSelect() {
    const select = document.getElementById('langSelect');
    select.innerHTML = languages.map(l => `<option value="${l.code}"${l.code === currentLang ? ' selected' : ''}>${l.name}</option>`).join('');
    document.getElementById('langCount').textContent = currentLangCards().length;
    updateWelcomeLangSelect();
}

// Switch to a different language
function switchLang() {
    currentLang = document.getElementById('langSelect').value;
    saveCurrentLang();
    renderLangSelect();
    updateWelcomeLangSelect();
    updateDailyProgressUI(); // Update daily progress for new language
    if (isStudying) {
        returnToWelcome();
    } else {
        updateWelcomeStats();
    }
    updateStats();
    renderList();
}

// Show/hide the "add language" form
function toggleLangForm() {
    document.getElementById('langForm').classList.toggle('show');
    document.getElementById('newLangName').focus();
}

function cancelLangForm() {
    document.getElementById('langForm').classList.remove('show');
    document.getElementById('newLangName').value = '';
    document.getElementById('newLangCode').value = '';
}

// Add a new language to the system
function addLang() {
    const name = document.getElementById('newLangName').value.trim();
    const code = document.getElementById('newLangCode').value.trim().toLowerCase();
    
    if (!name || !code) return;
    if (languages.find(l => l.code === code)) {
        alert('Language code already exists');
        return;
    }
    
    languages.push({name, code});
    saveLangs();
    currentLang = code;
    saveCurrentLang();
    renderLangSelect();
    updateWelcomeLangSelect();
    cancelLangForm();
    updateWelcomeStats();
    updateStats();
}

// Rename current language
function renameLang() {
    const lang = languages.find(l => l.code === currentLang);
    if (!lang) return;
    
    const newName = prompt(`Rename "${lang.name}":`, lang.name);
    if (newName?.trim()) {
        lang.name = newName.trim();
        saveLangs();
        renderLangSelect();
        updateWelcomeLangSelect();
    }
}

// Format minutes into human-readable string
function formatInterval(mins) {
    if (!mins || mins <= 1) return 'new';
    if (mins < 60) return `${Math.round(mins)}m`;
    if (mins < 1440) return `${Math.round(mins/60)}h`;
    return `${Math.round(mins/1440)}d`;
}

// Format interval as days (for display in card list)
function formatIntervalDays(mins) {
    if (!mins || mins <= 1) return 'Due now';
    const days = Math.round(mins / 1440);
    if (days === 1) return '1 day';
    return `${days} days`;
}

// Format next review time in friendly way
function formatNextReview(dueTimestamp) {
    if (!dueTimestamp) return 'soon';
    
    const now = Date.now();
    const diff = dueTimestamp - now;
    const minutes = Math.round(diff / 60000);
    const hours = Math.round(diff / 3600000);
    const days = Math.round(diff / 86400000);
    
    if (minutes < 60) return `in ${minutes}m`;
    if (hours < 24) return `in ${hours}h`;
    if (days === 1) return `tomorrow`;
    if (days < 30) return `in ${days}d`;
    if (days < 365) return `in ${Math.round(days / 30)}mo`;
    return `in ${Math.round(days / 365)}y`;
}

// ===== STATS & DISPLAY =====

// Update all statistics displays
function updateStats() {
    const langCards = currentLangCards();
    const due = dueCards().length;
    // Mastered = 4+ successful reviews
    const mastered = langCards.filter(c => (c.n||0) >= 4).length;
    const totalReviews = langCards.reduce((a,c) => a + (c.reviews||0), 0);
    const totalCorrect = langCards.reduce((a,c) => a + (c.correct||0), 0);
    const accuracy = totalReviews ? Math.round(totalCorrect/totalReviews*100) : 0;

    document.getElementById('dueCount').textContent = due;
    document.getElementById('statDue').textContent = due;
    document.getElementById('statLearning').textContent = langCards.length - mastered;
    document.getElementById('statMastered').textContent = mastered;
    document.getElementById('statAccuracy').textContent = `${accuracy}%`;
    document.getElementById('langCount').textContent = langCards.length;
}

/**
 * Show the next flashcard based purely on SRS
 * Cards appear when they're due - no sessions, no limits
 */
function show() {
    waitingForNext = false;
    lastAnswerWrong = false;
    updateStats();
    renderList();
    
    // Clear image panel when showing new question (only load images after answer)
    if (imagePanelOpen) {
        document.getElementById('bingIframe').src = 'about:blank';
        currentImageWord = '';
    }
    
    // Get due cards
    const dc = dueCards();

    // No cards available
    if (!dc.length) {
        showNoCards();
        return;
    }

    // Reset UI
    sentence.classList.remove('done-msg');
    answer.style.display = '';
    answer.readOnly = false;
    answer.style.background = '';
    msg.textContent = '';
    document.getElementById('studyActions').style.display = 'flex';
    
    // Select next due card randomly
    cur = dc[Math.random() * dc.length | 0];
    
    // Display sentence with word hidden
    sentence.textContent = cur.s.replace(new RegExp(escapeRegex(cur.w), 'gi'), '___');
    // Show hint: definition + first letter
    hint.textContent = `${cur.d} (${cur.w[0]})`;
    answer.value = '';
    answer.focus();
    answerStartTime = Date.now();
    
    // Note: Images will only be shown after user answers, not before
    // This prevents giving hints before the user attempts the answer
}

// No longer needed - SRS handles scheduling automatically

// Show "All done" when no cards are due
function showNoCards() {
    showStudyComplete();
}

// Show completion screen when no more cards due
function showStudyComplete() {
    sentence.textContent = '';
    sentence.classList.remove('done-msg');
    hint.textContent = '';
    answer.style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    
    msg.innerHTML = 
        `<div class="session-complete">
        <h2>üéâ All Caught Up!</h2>
        <p style="color: var(--color-text-muted); margin: 1rem 0;">No more cards due for review.</p>
        <p style="color: var(--color-text-muted); margin-bottom: 1rem;">Come back later for your next reviews.</p>
        <div class="session-actions">
            <button class="btn-primary" onclick="returnToWelcome()">Back to Home</button>
        </div>
        </div>`;
}

// Show daily goal completion screen
function showDailyGoalComplete() {
    const count = getTodayCount();
    sentence.textContent = '';
    sentence.classList.remove('done-msg');
    hint.textContent = '';
    answer.style.display = 'none';
    document.getElementById('studyActions').style.display = 'none';
    
    // Check if there are more due cards available
    const remainingDue = dueCards().length;
    const hasMoreCards = remainingDue > 0;
    
    msg.innerHTML = 
        `<div class="session-complete">
        <h2>üéâ Daily Goal Reached!</h2>
        <p style="color: var(--color-text-muted); margin: 1rem 0;">You've studied <strong>${count}</strong> words today.</p>
        <p style="color: var(--color-text-muted); margin-bottom: 1rem;">Great job! ${hasMoreCards ? `There are <strong>${remainingDue}</strong> more cards due.` : 'Come back tomorrow to continue.'}</p>
        <div class="session-actions">
            ${hasMoreCards ? `<button class="btn-success" onclick="continueStudying()">Continue Studying</button>` : ''}
            <button class="btn-primary" onclick="returnToWelcome()">Back to Home</button>
        </div>
        </div>`;
}

// Continue studying beyond daily goal
function continueStudying() {
    // Reset UI for studying
    answer.style.display = '';
    document.getElementById('studyActions').style.display = '';
    msg.innerHTML = '';
    
    // Show next card
    show();
}

// Reset all cards to "new" state (for testing or restarting)
function resetAll() {
    cards.forEach(c => { c.due = 0; c.n = 0; c.int = 1; });
    save();
    show();
}

// ===== KEYBOARD SHORTCUTS =====

// ESC key closes modals and allows finishing study when daily goal reached
document.onkeydown = e => {
    if (e.key === 'Escape') {
        // Close any open modals first
        const editModal = document.getElementById('editModal');
        const addModal = document.getElementById('addModal');
        const previewModal = document.getElementById('previewModal');
        
        if (editModal?.classList.contains('show')) {
            closeEditModal();
            return;
        }
        if (addModal?.classList.contains('show')) {
            closeAddModal();
            return;
        }
        if (previewModal?.classList.contains('show')) {
            closePreviewModal();
            return;
        }
        
        // If daily goal is reached and waiting for next, ESC finishes studying
        if (isStudying && waitingForNext && isDailyGoalReached()) {
            returnToWelcome();
        }
    }
};

// ENTER key handles answer submission and progression
answer.onkeydown = e => {
    if (e.key !== 'Enter' || !cur) return;
    
    // If we already showed feedback, Enter proceeds to next card
    if (waitingForNext) {
        waitingForNext = false;
        msg.textContent = '';
        
        answer.readOnly = false;
        answer.style.background = '';
        
        // If wrong, give another chance on same card
        if (lastAnswerWrong) {
            lastAnswerWrong = false;
            sentence.textContent = cur.s.replace(new RegExp(escapeRegex(cur.w), 'gi'), '___');
            answer.focus();
            answerStartTime = Date.now();
            // Clear image panel when asking again
            if (imagePanelOpen) {
                document.getElementById('bingIframe').src = 'about:blank';
                currentImageWord = '';
            }
            return;
        }
        
        // Check if daily goal reached - but allow continuing
        if (isDailyGoalReached()) {
            // Check if there are more due cards
            const remainingDue = dueCards().length;
            if (remainingDue === 0) {
                // No more cards, show completion screen
                showDailyGoalComplete();
                return;
            }
            // Otherwise continue to next card
        }
        
        // Move to next card
        show();
        return;
    }
    
    // Check the answer
    const userAnswer = answer.value.trim().toLowerCase();
    const correctAnswer = cur.w.toLowerCase();
    const isCorrect = userAnswer === correctAnswer;
    
    // WRONG ANSWER
    if (!isCorrect) {
        lastAnswerWrong = true;
        // Show the correct word in red
        sentence.innerHTML = cur.s.replace(new RegExp(`(${escapeRegex(cur.w)})`, 'gi'), `<span class="no">$1</span>`);
        msg.innerHTML = '<span style="color: var(--color-text-muted);">Press Enter to try again</span>';
        answer.value = '';
        answer.readOnly = true;
        answer.style.background = 'var(--color-error-pale)'; // Light red background
        answer.classList.add('shake'); // Shake animation
        setTimeout(() => answer.classList.remove('shake'), 500);
        waitingForNext = true;
        
        // Load images after wrong answer
        if (!imagePanelOpen) {
            toggleImagePanel();
        }
        if (cur?.w) {
            loadBingImages(cur.w);
        }
        return;
    }
    
    // CORRECT ANSWER
    const responseTime = Date.now() - answerStartTime;
    const quality = calculateQuality(answer.value, cur.w, responseTime);
    const ok = sm2(cur, quality); // Apply SM-2 algorithm

    // Track stats
    cur.reviews = (cur.reviews || 0) + 1;
    cur.correct = (cur.correct || 0) + (ok ? 1 : 0);
    cur.lastReview = new Date().toISOString();
    cur.lastQuality = quality;
    save();
    
    // Track daily progress
    incrementTodayCount();

    // Show the correct word in green
    sentence.innerHTML = cur.s.replace(new RegExp(`(${escapeRegex(cur.w)})`, 'gi'), `<span class="ok">$1</span>`);
    
    // Update stats (pure SRS - no session tracking needed)
    
    lastAnswerWrong = false;
    waitingForNext = true;
    
    // Show next review info as compact badge
    const nextReview = formatNextReview(cur.due);
    const nextReviewBadge = `<span class="next-review-badge">üîÑ ${nextReview}</span>`;
    
    // Check if daily goal reached
    if (isDailyGoalReached()) {
        msg.innerHTML = `
            <div style="color: var(--color-success); font-weight: 600;">üéâ Daily goal reached! ${nextReviewBadge}</div>
            <div style="color: var(--color-text-muted); font-size: 0.9rem; margin-top: 0.3rem;">Press Enter to continue or ESC to finish</div>
        `;
    } else {
        msg.innerHTML = `
            <div style="color: var(--color-text-muted);">Press Enter to continue ${nextReviewBadge}</div>
        `;
    }
    
    // Load images after correct answer
    if (!imagePanelOpen) {
        toggleImagePanel();
    }
    if (cur?.w) {
        loadBingImages(cur.w);
    }
    answer.value = '';
    answer.readOnly = true;
    answer.style.background = 'var(--color-elevation-3)'; // Done state - higher elevation
};

// ===== SIDEBAR: CARD LIST =====

let wordsFilter = 'all'; // all | due | learning | mastered

function setWordsFilter(filter) {
    wordsFilter = filter;
    // Update tab UI
    document.querySelectorAll('.words-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.filter === filter);
    });
    renderList();
}

function clearWordsSearch() {
    document.getElementById('wordsSearch').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    renderList();
}

// Render the scrollable list of all cards
function renderList() {
    const sortBy = document.getElementById('sortSelect').value;
    const searchTerm = document.getElementById('wordsSearch')?.value?.trim().toLowerCase() || '';
    
    // Show/hide clear button
    if (document.getElementById('clearSearch')) {
        document.getElementById('clearSearch').style.display = searchTerm ? 'block' : 'none';
    }
    
    // Filter to current language and add index for editing
    let sorted = cards.map((c,i) => ({...c, idx: i})).filter(c => (c.lang || 'en') === currentLang);
    
    // Apply search filter
    if (searchTerm) {
        sorted = sorted.filter(c => 
            c.w.toLowerCase().includes(searchTerm) || 
            c.d.toLowerCase().includes(searchTerm) ||
            c.s.toLowerCase().includes(searchTerm)
        );
    }
    
    // Apply tab filter
    if (wordsFilter === 'due') {
        sorted = sorted.filter(c => (c.due||0) <= Date.now());
    } else if (wordsFilter === 'learning') {
        sorted = sorted.filter(c => (c.n || 0) > 0 && (c.n || 0) < 4);
    } else if (wordsFilter === 'mastered') {
        sorted = sorted.filter(c => (c.n || 0) >= 4);
    }

    // Apply sorting
    if (sortBy === 'word') sorted.sort((a,b) => a.w.localeCompare(b.w));
    else if (sortBy === 'za') sorted.sort((a,b) => b.w.localeCompare(a.w));
    else if (sortBy === 'due') sorted.sort((a,b) => (a.due||0) - (b.due||0));
    else if (sortBy === 'stage') sorted.sort((a,b) => (a.n||0) - (b.n||0));
    else if (sortBy === 'accuracy-high') {
        sorted.sort((a,b) => {
            const accA = (a.reviews || 0) > 0 ? (a.correct || 0) / a.reviews : 0;
            const accB = (b.reviews || 0) > 0 ? (b.correct || 0) / b.reviews : 0;
            return accB - accA; // High to low
        });
    }
    else if (sortBy === 'accuracy-low') {
        sorted.sort((a,b) => {
            const accA = (a.reviews || 0) > 0 ? (a.correct || 0) / a.reviews : 0;
            const accB = (b.reviews || 0) > 0 ? (b.correct || 0) / b.reviews : 0;
            // Put cards with no reviews at the end
            if (a.reviews === 0 && b.reviews > 0) return 1;
            if (b.reviews === 0 && a.reviews > 0) return -1;
            return accA - accB; // Low to high
        });
    }
    else if (sortBy === 'most-reviewed') sorted.sort((a,b) => (b.reviews || 0) - (a.reviews || 0));
    else if (sortBy === 'least-reviewed') sorted.sort((a,b) => (a.reviews || 0) - (b.reviews || 0));
    else if (sortBy === 'recent') sorted.sort((a,b) => (b.addedAt || 0) - (a.addedAt || 0));
    else if (sortBy === 'oldest') sorted.sort((a,b) => (a.addedAt || 0) - (b.addedAt || 0));
    else if (sortBy === 'hardest-ef') sorted.sort((a,b) => (a.ef || 2.5) - (b.ef || 2.5));
    else if (sortBy === 'easiest-ef') sorted.sort((a,b) => (b.ef || 2.5) - (a.ef || 2.5));
    else if (sortBy === 'longest-interval') sorted.sort((a,b) => (b.int || 0) - (a.int || 0));
    else if (sortBy === 'random') sorted.sort(() => Math.random() - 0.5);

    // Empty state
    if (sorted.length === 0) {
        const emptyMessage = searchTerm 
            ? 'No cards match your search'
            : wordsFilter === 'due' 
                ? 'No cards due for review'
                : wordsFilter === 'learning'
                    ? 'No cards in learning'
                    : wordsFilter === 'mastered'
                        ? 'No mastered cards yet'
                        : 'No cards yet';
        const subMessage = searchTerm
            ? 'Try a different search term'
            : 'Click "Add Card" to create one';
        document.getElementById('wordsList').innerHTML = `
            <div class="words-empty">
                <div class="icon">üìù</div>
                <div>${emptyMessage}</div>
                <div style="font-size: .8rem; margin-top: .25rem;">${subMessage}</div>
            </div>`;
        return;
    }

    // Render each card row
    document.getElementById('wordsList').innerHTML = sorted.map(c => {
        const isDue = (c.due||0) <= Date.now();
        const isNew = (c.n || 0) === 0;
        const ef = (c.ef || 2.5);
        const stage = (c.n || 0);
        const stageLabel = stage === 0 ? 'New' : stage < 4 ? `Learning ${stage}` : 'Mastered';
        const statusClass = isDue ? 'due' : isNew ? 'new' : 'ok';
        
        // Difficulty indicator (based on EF: < 2.0 = hard, > 2.5 = easy)
        let difficultyClass = 'medium';
        if (ef < 2.0) difficultyClass = 'hard';
        else if (ef > 2.5) difficultyClass = 'easy';
        
        // Progress dots for learning stage
        let progressDots = '';
        if (stage > 0 && stage < 4) {
            progressDots = '<span class="stage-dots">' + 
                Array(3).fill(0).map((_, i) => 
                    `<span class="stage-dot ${i < stage ? 'filled' : ''}"></span>`
                ).join('') + 
            '</span>';
        } else if (stage >= 4) {
            progressDots = '<span class="mastered-badge">‚≠ê</span>';
        }
        
        // Next review time badge for right side
        let nextReviewBadge = '';
        if (isDue) {
            nextReviewBadge = '<span class="word-next-review due">‚è∞ Due</span>';
        } else if (stage === 0) {
            nextReviewBadge = '<span class="word-next-review new">New</span>';
        } else {
            nextReviewBadge = `<span class="word-next-review">üîÑ ${formatNextReview(c.due)}</span>`;
        }
        
        return `<div class="word-item" onclick="showCardPreview(${c.idx}, event)">
            <div class="word-status ${statusClass}"></div>
            <div class="word-info">
                <div class="word-name">${c.w}</div>
                <div class="word-meta">
                    ${stageLabel} ${progressDots || ''}
                    <span class="difficulty ${difficultyClass}" title="Ease Factor: ${ef.toFixed(1)}"></span>
                </div>
            </div>
            <div class="word-next-review-wrap">
                ${nextReviewBadge}
            </div>
            <div class="word-actions" onclick="event.stopPropagation()">
                <button onclick="editCard(${c.idx})" title="Edit">‚úé</button>
                <button class="danger" onclick="delCard(${c.idx})" title="Delete">üóë</button>
            </div>
        </div>`;
    }).join('');
}

// ===== CARD PREVIEW MODAL =====

let previewCardIdx = -1;

function showCardPreview(idx, event) {
    // Don't open preview if clicking action buttons
    if (event && event.target.closest('.word-actions')) return;
    
    const card = cards[idx];
    if (!card) return;
    
    previewCardIdx = idx;
    
    document.getElementById('previewWord').textContent = card.w;
    document.getElementById('previewDef').textContent = card.d;
    document.getElementById('previewSentence').innerHTML = card.s.replace(
        new RegExp('(' + escapeRegex(card.w) + ')', 'gi'), 
        '<span class="highlight">$1</span>'
    );
    
    const stage = card.n || 0;
    const stageLabel = stage === 0 ? '‚≠ê New' : stage < 4 ? `üìö Learning ${stage}/3` : 'üåü Mastered';
    const reviews = card.reviews || 0;
    const accuracy = reviews > 0 ? Math.round(((card.correct || 0) / reviews) * 100) : 0;
    const isDue = (card.due || 0) <= Date.now();
    const nextReviewText = isDue 
        ? '<span style="background: rgba(230, 126, 34, 0.15); color: var(--color-progress-orange); padding: 0.15rem 0.4rem; border-radius: 8px; font-weight: 500;">‚è∞ Due</span>' 
        : `<span style="background: var(--color-success-bg); color: var(--color-success); padding: 0.15rem 0.4rem; border-radius: 8px; font-weight: 500;">üîÑ ${formatNextReview(card.due)}</span>`;
    
    document.getElementById('previewMeta').innerHTML = `
        <span>${stageLabel}</span>
        <span>üîÑ ${reviews}</span>
        <span>üéØ ${accuracy}%</span>
        <span>${nextReviewText}</span>
    `;
    
    document.getElementById('previewModal').classList.add('show');
}

function closePreviewModal() {
    document.getElementById('previewModal').classList.remove('show');
    previewCardIdx = -1;
}

function editFromPreview() {
    if (previewCardIdx >= 0) {
        closePreviewModal();
        editCard(previewCardIdx);
    }
}

// ===== ADD CARD MODAL =====

function openAddModal() {
    editIdx = -1;
    document.getElementById('aWord').value = '';
    document.getElementById('aSent').value = '';
    document.getElementById('aDef').value = '';
    document.getElementById('addError').classList.remove('show');
    document.getElementById('addPreview').classList.remove('show');
    document.getElementById('addModal').classList.add('show');
    document.getElementById('aWord').focus();
}

function closeAddModal() {
    editIdx = -1;
    document.getElementById('addModal').classList.remove('show');
}

function validateAddForm() {
    const word = document.getElementById('aWord').value.trim();
    const sent = document.getElementById('aSent').value.trim();
    validateSentence(word, sent, 'addError', 'addPreview');
}

// Save new or edited card
function saveCard() {
    const w = document.getElementById('aWord').value.trim();
    const s = document.getElementById('aSent').value.trim();
    const d = document.getElementById('aDef').value.trim();
    
    if (!w || !s || !d) {
        alert('Please fill in all fields');
        return;
    }
    if (!s.toLowerCase().includes(w.toLowerCase())) {
        alert('The sentence must include the word');
        return;
    }

    if (editIdx >= 0) {
        // Edit existing
        cards[editIdx].w = w;
        cards[editIdx].s = s;
        cards[editIdx].d = d;
        cards[editIdx].lang = currentLang;
    } else {
        // Add new card with SM-2 defaults and timestamp
        cards.push({w, s, d, int: 1, due: 0, ef: 2.5, n: 0, lang: currentLang, addedAt: Date.now()});
    }

    save();
    closeAddModal();
    if (!isStudying) updateWelcomeStats();
    updateStats();
    renderList();
}

// Legacy aliases for backward compatibility
toggleAdd = openAddModal;
cancelAdd = closeAddModal;
validateCard = validateAddForm;

// Edit a card from the sidebar list
function editCard(i) {
    editIdx = i;
    document.getElementById('aWord').value = cards[i].w;
    document.getElementById('aSent').value = cards[i].s;
    document.getElementById('aDef').value = cards[i].d;
    document.getElementById('addError').classList.remove('show');
    document.getElementById('addPreview').classList.remove('show');
    document.getElementById('addModal').classList.add('show');
    validateAddForm();
    document.getElementById('aWord').focus();
}

// Delete a card from the sidebar
function delCard(i) {
    if (confirm(`Delete "${cards[i].w}"?`)) {
        cards.splice(i, 1);
        save();
        if (!isStudying) updateWelcomeStats();
        updateStats();
        renderList();
    }
}

// ===== STUDY PANEL: EDIT CURRENT CARD =====

// Edit the card currently being studied
function editCurrentCard() {
    if (!cur) return;
    document.getElementById('editWord').value = cur.w;
    document.getElementById('editDef').value = cur.d;
    document.getElementById('editSent').value = cur.s;
    document.getElementById('editError').classList.remove('show');
    document.getElementById('editPreview').classList.remove('show');
    document.getElementById('editModal').classList.add('show');
    document.getElementById('editWord').focus();
}

function validateEdit() {
    const word = document.getElementById('editWord').value.trim();
    const sent = document.getElementById('editSent').value.trim();
    validateSentence(word, sent, 'editError', 'editPreview');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

// Save changes to the currently studied card
function saveEdit() {
    if (!cur) return;
    
    const newWord = document.getElementById('editWord').value.trim();
    const newDef = document.getElementById('editDef').value.trim();
    const newSent = document.getElementById('editSent').value.trim();
    
    if (!newWord || !newDef || !newSent) {
        alert('All fields are required');
        return;
    }
    if (!newSent.toLowerCase().includes(newWord.toLowerCase())) {
        alert('The sentence must include the word');
        return;
    }
    
    const idx = findCardIndex(cur);
    if (idx === -1) return;
    
    cards[idx].w = newWord;
    cards[idx].d = newDef;
    cards[idx].s = newSent;
    save();
    
    // Update the displayed card
    cur = cards[idx];
    sentence.innerHTML = cur.s.replace(new RegExp(`(${cur.w})`, 'gi'), '<span class="ok">$1</span>');
    hint.textContent = `${cur.d} (${cur.w[0]})`;
    
    renderList();
    updateStats();
    if (!isStudying) updateWelcomeStats();
    closeEditModal();
}

// Delete the card currently being studied
function deleteCurrentCard() {
    if (!cur) return;
    if (!confirm(`Delete "${cur.w}"?`)) return;
    
    const idx = findCardIndex(cur);
    if (idx === -1) return;
    
    cards.splice(idx, 1);
    save();
    
    if (isStudying) removeCardFromStudy(cur);
    
    waitingForNext = false;
    lastAnswerWrong = false;
    
    renderList();
    updateStats();
    if (!isStudying) updateWelcomeStats();
    show();
}

// ===== DATA MANAGEMENT =====

// Clear all cards (with confirmation)
function clearWords() {
    const langCards = currentLangCards();
    if (langCards.length === 0) {
        alert(`No cards to clear for ${languages.find(l => l.code === currentLang)?.name || currentLang}`);
        return;
    }
    
    const allCardsCount = cards.length;
    const currentLangCount = langCards.length;
    
    let message = `Clear cards for "${languages.find(l => l.code === currentLang)?.name || currentLang}" (${currentLangCount} cards)?\n\n`;
    message += 'Click OK to clear current language only.\n';
    if (allCardsCount > currentLangCount) {
        message += `Click Cancel, then type "ALL" to clear ALL ${allCardsCount} cards across all languages.`;
    }
    
    if (confirm(message)) {
        cards = cards.filter(c => (c.lang || 'en') !== currentLang);
        save();
        if (!isStudying) updateWelcomeStats();
        updateStats();
        renderList();
    } else {
        const confirmAll = prompt(`Type "ALL" (uppercase) to delete ALL ${allCardsCount} cards across all languages:`);
        if (confirmAll === 'ALL') {
            cards = [];
            save();
            if (!isStudying) updateWelcomeStats();
            updateStats();
            renderList();
        }
    }
}

// Export cards to JSON file
function exp() {
    const langCards = currentLangCards();
    const exportData = {
        version: 1,
        exportedAt: new Date().toISOString(),
        language: languages.find(l => l.code === currentLang)?.name || currentLang,
        languageCode: currentLang,
        cardCount: langCards.length,
        cards: langCards
    };
    const a = document.createElement('a');
    a.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(exportData, null, 2));
    a.download = `flashcards-${currentLang}-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

// Import cards from JSON file
function handleImport(input) {
    if (!input.files[0]) return;
    input.files[0].text().then(t => {
        try {
            const data = JSON.parse(t);
            let importedCards = [];
            
            // Support both object format {cards: [...]} and array format [...]
            if (data.cards && Array.isArray(data.cards)) {
                importedCards = data.cards;
            } else if (Array.isArray(data)) {
                importedCards = data;
            } else {
                alert('Invalid JSON format');
                return;
            }
            
            // Validate cards
            importedCards = importedCards.filter(c => c.w && c.s && c.d);
            
            // Skip duplicates - keep existing cards, only add new ones
            const duplicates = [];
            const newCards = [];
            
            for (const imported of importedCards) {
                const exists = cards.some(c => c.w === imported.w && c.lang === imported.lang);
                if (exists) {
                    duplicates.push(imported.w);
                } else {
                    // Add timestamp if missing
                    if (!imported.addedAt) imported.addedAt = Date.now();
                    newCards.push(imported);
                }
            }
            
            // Add only new cards
            cards = cards.concat(newCards);
            save();
            
            if (!isStudying) updateWelcomeStats();
            updateStats();
            renderList();
            
            // Show result message
            let message = '';
            if (newCards.length > 0) {
                message += `Imported ${newCards.length} new card${newCards.length > 1 ? 's' : ''}!`;
            }
            if (duplicates.length > 0) {
                if (message) message += '\n\n';
                message += `Skipped ${duplicates.length} duplicate${duplicates.length > 1 ? 's' : ''}:\n${duplicates.slice(0, 5).join(', ')}${duplicates.length > 5 ? ` and ${duplicates.length - 5} more` : ''}`;
            }
            if (!message) {
                message = 'No valid cards to import.';
            }
            
            alert(message);
        } catch (e) {
            alert('Error reading JSON file: ' + e.message);
        }
        input.value = '';
    });
}

// ===== IMAGE PANEL FUNCTIONS =====
let imagePanelOpen = localStorage.imagePanelOpen === 'true';
let currentImageWord = '';

// Restore image panel state on load
if (imagePanelOpen) {
    document.getElementById('imagePanel').classList.add('show');
    document.body.classList.add('image-panel-open');
}

function toggleImagePanel() {
    const panel = document.getElementById('imagePanel');
    imagePanelOpen = !imagePanelOpen;
    
    if (imagePanelOpen) {
        panel.classList.add('show');

        document.body.classList.add('image-panel-open');
        // Load Bing search for current word if in session
        if (cur && cur.w) {
            loadBingImages(cur.w);
        }
    } else {
        panel.classList.remove('show');

        document.body.classList.remove('image-panel-open');
        // Clear iframe when closing to stop loading
        document.getElementById('bingIframe').src = 'about:blank';
    }
    
    localStorage.imagePanelOpen = imagePanelOpen;
}

// Load Bing Image Search in iframe
function loadBingImages(word) {
    if (!word || word === currentImageWord) return;
    currentImageWord = word;
    
    const iframe = document.getElementById('bingIframe');
    const encodedWord = encodeURIComponent(word);
    
    // Load Bing image search directly in iframe
    // Using Bing's image search URL
    iframe.src = `https://www.bing.com/images/search?q=${encodedWord}`;
}

// Open Bing search in new tab
function openBingSearch() {
    const word = currentImageWord || (cur?.w) || '';
    if (word) {
        window.open(`https://www.bing.com/images/search?q=${encodeURIComponent(word)}`, '_blank');
    }
}

// ===== INITIALIZATION =====
// Run these when page loads
renderLangSelect();
updateWelcomeLangSelect();
updateWelcomeStats();
updateStats();
renderList();
updateDailyProgressUI();
</script>
</body>
</html>
